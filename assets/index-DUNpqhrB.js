import{r as Ps,g as Os,a as Ws}from"./vendor-B4QdQTOU.js";import{_ as Us,a as _s}from"./pdfjs-Cp9nfDvG.js";import{u as mt,w as Vs}from"./xlsx-DIVJSiuo.js";(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const j of document.querySelectorAll('link[rel="modulepreload"]'))C(j);new MutationObserver(j=>{for(const N of j)if(N.type==="childList")for(const U of N.addedNodes)U.tagName==="LINK"&&U.rel==="modulepreload"&&C(U)}).observe(document,{childList:!0,subtree:!0});function A(j){const N={};return j.integrity&&(N.integrity=j.integrity),j.referrerPolicy&&(N.referrerPolicy=j.referrerPolicy),j.crossOrigin==="use-credentials"?N.credentials="include":j.crossOrigin==="anonymous"?N.credentials="omit":N.credentials="same-origin",N}function C(j){if(j.ep)return;j.ep=!0;const N=A(j);fetch(j.href,N)}})();var Es={exports:{}},as={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Rs;function Xs(){if(Rs)return as;Rs=1;var o=Ps(),c=Symbol.for("react.element"),A=Symbol.for("react.fragment"),C=Object.prototype.hasOwnProperty,j=o.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,N={key:!0,ref:!0,__self:!0,__source:!0};function U(L,v,Y){var H,se={},Q=null,O=null;Y!==void 0&&(Q=""+Y),v.key!==void 0&&(Q=""+v.key),v.ref!==void 0&&(O=v.ref);for(H in v)C.call(v,H)&&!N.hasOwnProperty(H)&&(se[H]=v[H]);if(L&&L.defaultProps)for(H in v=L.defaultProps,v)se[H]===void 0&&(se[H]=v[H]);return{$$typeof:c,type:L,key:Q,ref:O,props:se,_owner:j.current}}return as.Fragment=A,as.jsx=U,as.jsxs=U,as}var Ds;function Zs(){return Ds||(Ds=1,Es.exports=Xs()),Es.exports}var e=Zs(),t=Ps();const ot=Os(t);var us={},As;function Ys(){if(As)return us;As=1;var o=Ws();return us.createRoot=o.createRoot,us.hydrateRoot=o.hydrateRoot,us}var Ks=Ys();const Gs=Os(Ks);let hs;const Js=new Uint8Array(16);function Qs(){if(!hs&&(hs=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!hs))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return hs(Js)}const ut=[];for(let o=0;o<256;++o)ut.push((o+256).toString(16).slice(1));function en(o,c=0){return ut[o[c+0]]+ut[o[c+1]]+ut[o[c+2]]+ut[o[c+3]]+"-"+ut[o[c+4]]+ut[o[c+5]]+"-"+ut[o[c+6]]+ut[o[c+7]]+"-"+ut[o[c+8]]+ut[o[c+9]]+"-"+ut[o[c+10]]+ut[o[c+11]]+ut[o[c+12]]+ut[o[c+13]]+ut[o[c+14]]+ut[o[c+15]]}const tn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ms={randomUUID:tn};function Fe(o,c,A){if(Ms.randomUUID&&!o)return Ms.randomUUID();o=o||{};const C=o.random||(o.rng||Qs)();return C[6]=C[6]&15|64,C[8]=C[8]&63|128,en(C)}const sn=({onFileSelect:o})=>{const[c,A]=t.useState(!1),C=t.useCallback(v=>{v.preventDefault(),v.stopPropagation(),A(!0)},[]),j=t.useCallback(v=>{v.preventDefault(),v.stopPropagation(),A(!1)},[]),N=t.useCallback(v=>{v.preventDefault(),v.stopPropagation()},[]),U=t.useCallback(v=>{v.preventDefault(),v.stopPropagation(),A(!1),v.dataTransfer.files&&v.dataTransfer.files.length>0&&(v.dataTransfer.files[0].type==="application/pdf"&&o(v.dataTransfer.files[0]),v.dataTransfer.clearData())},[o]),L=v=>{v.target.files&&v.target.files[0]&&o(v.target.files[0])};return e.jsx("div",{className:"flex items-center justify-center h-full p-8",children:e.jsxs("div",{className:`w-full max-w-2xl h-full max-h-[500px] border-2 border-dashed rounded-xl flex flex-col items-center justify-center text-center transition-colors ${c?"border-sky-400 bg-sky-500/10":"border-slate-600 bg-slate-800/20"}`,onDragEnter:C,onDragLeave:j,onDragOver:N,onDrop:U,children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-16 w-16 mb-4 transition-colors ${c?"text-sky-400":"text-slate-500"}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 16a4 4 0 01-4-4V6a2 2 0 012-2h10a2 2 0 012 2v6a4 4 0 01-4 4H7z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 9v6m3-3H7"})]}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Upload P&ID Drawing"}),e.jsx("p",{className:"text-slate-400 mb-6",children:"Drag & drop a PDF file here, or click to select."}),e.jsx("label",{htmlFor:"file-upload",className:"cursor-pointer px-6 py-2.5 text-sm font-semibold text-white bg-sky-600 rounded-md hover:bg-sky-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-slate-900",children:"Select File"}),e.jsx("input",{id:"file-upload",type:"file",className:"hidden",accept:".pdf",onChange:L}),e.jsx("p",{className:"text-xs text-slate-500 mt-6 max-w-md",children:"All processing is done in your browser. Your files are never uploaded to a server, ensuring complete privacy."})]})})},a={Equipment:"Equipment",Line:"Line",Instrument:"Instrument",DrawingNumber:"DrawingNumber",NotesAndHolds:"NotesAndHolds",SpecialItem:"SpecialItem",OffPageConnector:"OffPageConnector",Uncategorized:"Uncategorized"},J={Connection:"Connection",Installation:"Installation",Annotation:"Annotation",Note:"Note",Description:"Description",EquipmentShortSpec:"EquipmentShortSpec",OffPageConnection:"OffPageConnection"},os={[a.Equipment]:"^([^-]*-){2}[^-]*$",[a.Line]:'^(?=.{10,25}$)(?=.*")([^-]*-){3,}[^-]*$',[a.Instrument]:{func:"[A-Z]{2,4}",num:"\\d{3,4}(?:\\s?[A-Z])?"},[a.DrawingNumber]:"[A-Z\\d-]{5,}-[A-Z\\d-]{5,}-\\d{3,}",[a.NotesAndHolds]:"^(NOTE|HOLD).*",[a.SpecialItem]:"",[a.OffPageConnector]:"^[A-Z0-9]{1,3}$"},is={[a.Instrument]:{vertical:15,horizontal:20,autoLinkDistance:30},[a.OffPageConnector]:{vertical:15,horizontal:20,autoLinkDistance:30}},cs={autoGenerateLoops:!0,autoRemoveWhitespace:!0,hyphenSettings:{equipment:!1,line:!1,instrument:!0,drawingNumber:!1,notesAndHolds:!1,specialItem:!0,offPageConnector:!1}},xs={[a.Equipment]:{border:"border-orange-400",bg:"bg-orange-500/20",text:"text-orange-400"},[a.Line]:{border:"border-rose-400",bg:"bg-rose-500/20",text:"text-rose-400"},[a.Instrument]:{border:"border-amber-400",bg:"bg-amber-500/20",text:"text-amber-400"},[a.DrawingNumber]:{border:"border-indigo-400",bg:"bg-indigo-500/20",text:"text-indigo-400"},[a.NotesAndHolds]:{border:"border-teal-400",bg:"bg-teal-500/20",text:"text-teal-400"},[a.SpecialItem]:{border:"border-purple-400",bg:"bg-purple-500/20",text:"text-purple-400"},[a.OffPageConnector]:{border:"border-violet-400",bg:"bg-violet-500/20",text:"text-violet-400"},[a.Uncategorized]:{border:"border-slate-500",bg:"bg-slate-500/20",text:"text-slate-400"}},et={entities:{equipment:"#f97316",line:"#fb7185",instrument:"#fbbf24",drawingNumber:"#818cf8",notesAndHolds:"#14b8a6",specialItem:"#c084fc",offPageConnector:"#8b5cf6",uncategorized:"#94a3b8",description:"#a855f7",equipmentShortSpec:"#fb923c"},relationships:{connection:"#38bdf8",installation:"#facc15",annotation:"#a78bfa",note:"#14b8a6",offPageConnection:"#8b5cf6"},highlights:{primary:"#ef4444",note:"#8b5cf6",equipment:"#f97316",description:"#a855f7",related:"#6366f1",noteRelated:"#6366f1",selected:"#ef4444"}},Hs={NOTION_GUIDE:"https://www.notion.so/gs-enc/P-ID-Smart-Digitizer-262e12e04a1080f49111c88cd60a32dc",REGEX_HELPER:"https://chatgpt.com/g/g-dB9e8cEts-regex-helper"},ls=ot.memo(({bbox:o,type:c,effect:A,isPinged:C=!1,isSelected:j=!1,isHighlighted:N=!1,isMultiSelection:U=!1,customColor:L,colorSettings:v})=>{const{x1:Y,y1:H,x2:se,y2:Q}=o,O=Math.min(Y,se),_=Math.min(H,Q),ie=Math.abs(se-Y),fe=Math.abs(Q-H),ne={...et.highlights,...(v==null?void 0:v.highlights)||{}},K=L||ne[c]||ne.primary;if(!(C||j||N))return null;const z=()=>{if(A!=="arrows"&&A!=="all"||U&&!C)return null;const R=21,M=45;return e.jsxs("g",{className:C?"animate-pulse":"",children:[e.jsx("polygon",{points:`${O-M+R},${_-M+R} ${O-M},${_-M+R} ${O-M+R},${_-M}`,fill:K}),e.jsx("polygon",{points:`${O+ie+M-R},${_-M+R} ${O+ie+M},${_-M+R} ${O+ie+M-R},${_-M}`,fill:K}),e.jsx("polygon",{points:`${O-M+R},${_+fe+M-R} ${O-M},${_+fe+M-R} ${O-M+R},${_+fe+M}`,fill:K}),e.jsx("polygon",{points:`${O+ie+M-R},${_+fe+M-R} ${O+ie+M},${_+fe+M-R} ${O+ie+M-R},${_+fe+M}`,fill:K})]})},T=()=>{if(A!=="box"&&A!=="all")return null;const R=4,M=C?"ping-highlight-box":"";return e.jsx("rect",{x:O-R,y:_-R,width:ie+R*2,height:fe+R*2,fill:"none",stroke:K,strokeWidth:C?"3":"2",className:M,rx:"4"})},F=()=>A!=="outline"&&A!=="all"?null:e.jsx("rect",{x:O,y:_,width:ie,height:fe,fill:`${K}99`,stroke:K,strokeWidth:"2",rx:"2",className:N?"animate-pulse":""});return e.jsxs("g",{children:[T(),F(),z()]})}),Ts=(o,c,A)=>o?"arrows":A?"outline":"all",nn=ot.memo(({rel:o,start:c,end:A,strokeColor:C,marker:j,isPinged:N})=>{const U=N?"4":"2",L=N?"#ef4444":C,v=N?"none":o.type===J.Annotation||o.type===J.Note?"3 3":o.type===J.OffPageConnection?"8 4":"none";return e.jsxs("g",{children:[e.jsx("line",{x1:c.x,y1:c.y,x2:A.x,y2:A.y,stroke:L,strokeWidth:U,strokeDasharray:v,markerEnd:j,className:N?"ping-highlight-line":""}),N&&e.jsx("line",{x1:c.x,y1:c.y,x2:A.x,y2:A.y,stroke:"#ef4444",strokeWidth:"8",strokeOpacity:"0.3",strokeDasharray:"none",className:"ping-highlight-line-glow"})]})}),on=({pdfDoc:o,tags:c,setTags:A,relationships:C,setRelationships:j,currentPage:N,setCurrentPage:U,selectedTagIds:L,setSelectedTagIds:v,selectedDescriptionIds:Y,setSelectedDescriptionIds:H,selectedEquipmentShortSpecIds:se,setSelectedEquipmentShortSpecIds:Q,rawTextItems:O,descriptions:_,equipmentShortSpecs:ie,onCreateTag:fe,onCreateDescription:ne,onCreateHoldDescription:ye,onCreateEquipmentShortSpec:K,selectedRawTextItemIds:te,setSelectedRawTextItemIds:z,onDeleteTags:T,onMergeRawTextItems:F,onManualCreateLoop:R,onManualAreaSelect:M,onUpdateTagText:Z,onUpdateRawTextItemText:xe,scale:p,setScale:le,mode:oe,setMode:ge,relationshipStartTag:We,setRelationshipStartTag:Be,visibilitySettings:je,updateVisibilitySettings:D,pingedTagId:he,pingedDescriptionId:ue,pingedEquipmentShortSpecId:we,pingedRelationshipId:y,colorSettings:ae,scrollToCenter:be,setScrollToCenter:Ne,showAutoLinkRanges:Ze,tolerances:Ie,showAllRelationships:De,setShowAllRelationships:Ue,showOnlySelectedRelationships:Oe,setShowOnlySelectedRelationships:Ge,onOPCTagClick:_e})=>{var $;const Se=t.useRef(null),Ve=t.useRef(null),ve=t.useRef(null),Xe=t.useRef({x:0,y:0}),Ee=t.useRef(!1),[k,X]=t.useState(null),[ke,Le]=t.useState(0),[me,Te]=t.useState(!1),[Ae,Je]=t.useState(null),[yt,Ye]=t.useState(new Set),[ct,tt]=t.useState(new Set),[it,dt]=t.useState(null),[rt,jt]=t.useState(null),[St,Pt]=t.useState(""),ft=t.useRef(null),st=t.useRef(null),[xt,Zt]=t.useState(null),[vt,Ot]=t.useState(null),Yt=t.useCallback(()=>{if(xt){const{targetTagId:s,targetPage:l}=xt;Ot({targetTagId:s,targetPage:l}),U(l),Zt(null)}},[xt,U,N]);t.useEffect(()=>{if(vt&&N===vt.targetPage&&k){const{targetTagId:s}=vt;if(c.find(g=>g.id===s&&g.page===N)){const g=setTimeout(()=>{v([s]),wt(new Set([s]));const r={tagId:s,timestamp:Date.now()};Ne(r),Ot(null),setTimeout(()=>{wt(new Set)},2e3)},300);return()=>clearTimeout(g)}}},[N,vt,k,c,v,Ne]);const[gt,wt]=t.useState(new Set);t.useEffect(()=>{(it||rt)&&ft.current&&(ft.current.focus(),ft.current.select())},[it,rt]),t.useEffect(()=>{L.length>0?wt(new Set(L)):wt(new Set)},[L]),t.useEffect(()=>(st.current&&(clearTimeout(st.current),st.current=null),gt.size>0&&(st.current=setTimeout(()=>{wt(new Set),st.current=null},3e3)),()=>{st.current&&(clearTimeout(st.current),st.current=null)}),[gt]);const Ht=t.useCallback((s=!0)=>{s&&St.trim()&&(it?Z(it,St.trim()):rt&&xe(rt,St.trim())),dt(null),jt(null),Pt("")},[it,rt,St,Z,xe]),Kt=t.useCallback(s=>{s.key==="Enter"?(s.preventDefault(),Ht(!0)):s.key==="Escape"&&(s.preventDefault(),Ht(!1))},[Ht]),Bt=t.useMemo(()=>new Set(C.filter(s=>s.type===J.Annotation).map(s=>s.to)),[C]),Me={entities:{...et.entities,...(ae==null?void 0:ae.entities)||{}},relationships:{...et.relationships,...(ae==null?void 0:ae.relationships)||{}},highlights:{...et.highlights,...(ae==null?void 0:ae.highlights)||{}}},Ut=t.useCallback(s=>{switch(s){case a.Equipment:return Me.entities.equipment;case a.Line:return Me.entities.line;case a.Instrument:return Me.entities.instrument;case a.DrawingNumber:return Me.entities.drawingNumber;case a.NotesAndHolds:return Me.entities.notesAndHolds;case a.SpecialItem:return Me.entities.specialItem;case a.OffPageConnector:return Me.entities.offPageConnector;default:return Me.entities.uncategorized}},[Me]),At=t.useCallback(s=>{switch(s){case J.Connection:return Me.relationships.connection;case J.Installation:return Me.relationships.installation;case J.Annotation:return Me.relationships.annotation;case J.Note:return Me.relationships.note;case J.OffPageConnection:return Me.relationships.offPageConnection;default:return"#94a3b8"}},[Me]),_t=t.useCallback(s=>{switch(s.category){case a.Equipment:return je.tags.equipment;case a.Line:return je.tags.line;case a.Instrument:return je.tags.instrument;case a.DrawingNumber:return je.tags.drawingNumber;case a.NotesAndHolds:return je.tags.notesAndHolds;case a.SpecialItem:return je.tags.specialItem;case a.OffPageConnector:return je.tags.offPageConnector;default:return!0}},[je.tags]),Mt=t.useCallback(s=>{switch(s.type){case J.Connection:return je.relationships.connection;case J.Installation:return je.relationships.installation;case J.Annotation:return je.relationships.annotation;case J.Note:return je.relationships.note;case J.Description:return!1;case J.EquipmentShortSpec:return!1;case J.OffPageConnection:return!1;default:return!0}},[je.relationships]),Tt=t.useRef(!1),[bt,Nt]=t.useState(!1),Ce=t.useRef({scrollX:0,scrollY:0,clientX:0,clientY:0}),at=t.useRef(null),ht=t.useRef(0),pt=t.useRef(Promise.resolve()),Et=t.useCallback(async s=>{if(!o)return;const l=++ht.current;return pt.current=pt.current.then(async()=>{if(ht.current===l){if(at.current){try{at.current.cancel()}catch{}at.current=null,await new Promise(g=>setTimeout(g,10))}try{const g=await o.getPage(s);if(ht.current!==l)return;const r=g.getViewport({scale:p}),b=Se.current;if(!b)return;const S=b.getContext("2d");if(!S||(S.clearRect(0,0,b.width,b.height),b.height=r.height,b.width=r.width,S.clearRect(0,0,b.width,b.height),ht.current!==l))return;const I={canvasContext:S,viewport:r};at.current=g.render(I),await at.current.promise,ht.current===l&&(X(r),Le(r.rotation))}catch(g){g.name}finally{at.current&&(at.current=null)}}}),pt.current},[o,p]);t.useLayoutEffect(()=>(Et(N),()=>{if(ht.current++,at.current){try{at.current.cancel()}catch{}at.current=null}}),[N,Et,p]),t.useEffect(()=>{let s=new Set,l=new Set;if(L.length>0&&(l=new Set(C.filter(g=>g.type===J.Annotation&&L.includes(g.from)).map(g=>g.to)),L.length===1)){const g=c.find(r=>r.id===L[0]);g&&(g.category===a.Equipment||g.category===a.Line)&&(s=new Set(C.filter(r=>r.type===J.Installation&&r.to===g.id).map(r=>r.from)))}Ye(s),tt(l)},[L,C,c]),t.useEffect(()=>{if(be&&k&&ve.current){const{tagId:s,descriptionId:l,equipmentShortSpecId:g,x:r,y:b}=be;let S=r,I=b;if(s&&(!r||!b)){const i=c.find(E=>E.id===s);if(i){const{x1:E,y1:q,x2:pe,y2:Re}=i.bbox,qe=(E+pe)/2,G=(q+Re)/2,$e=f(qe,G);S=$e.x,I=$e.y}}else if(l&&(!r||!b)){const i=_.find(E=>E.id===l);if(i){const{x1:E,y1:q,x2:pe,y2:Re}=i.bbox,qe=(E+pe)/2,G=(q+Re)/2,$e=f(qe,G);S=$e.x,I=$e.y}}else if(g&&(!r||!b)){const i=ie.find(E=>E.id===g);if(i){const{x1:E,y1:q,x2:pe,y2:Re}=i.bbox,qe=(E+pe)/2,G=(q+Re)/2,$e=f(qe,G);S=$e.x,I=$e.y}}if(S!==void 0&&I!==void 0){const i=ve.current,E=i.getBoundingClientRect(),q=S-E.width/2,pe=I-E.height/2;i.scrollTo({left:Math.max(0,q),top:Math.max(0,pe),behavior:"smooth"})}}},[be,k,c,_,ie]),t.useEffect(()=>{const s=l=>{const g=l.target;if(!(g.tagName==="INPUT"||g.tagName==="TEXTAREA"||g.tagName==="SELECT"))if(l.key==="1")te.length>0?(fe(O.filter(r=>te.includes(r.id)),a.Equipment),z([])):(M(),setTimeout(()=>{const r=new CustomEvent("manualTagCreate",{detail:{category:a.Equipment}});window.dispatchEvent(r)},100)),l.preventDefault();else if(l.key==="2")te.length>0?(fe(O.filter(r=>te.includes(r.id)),a.Line),z([])):(M(),setTimeout(()=>{const r=new CustomEvent("manualTagCreate",{detail:{category:a.Line}});window.dispatchEvent(r)},100)),l.preventDefault();else if(l.key==="3")te.length>0?(fe(O.filter(r=>te.includes(r.id)),a.SpecialItem),z([])):(M(),setTimeout(()=>{const r=new CustomEvent("manualTagCreate",{detail:{category:a.SpecialItem}});window.dispatchEvent(r)},100)),l.preventDefault();else if(l.key==="4")te.length>0?(fe(O.filter(r=>te.includes(r.id)),a.Instrument),z([])):(M(),setTimeout(()=>{const r=new CustomEvent("manualTagCreate",{detail:{category:a.Instrument}});window.dispatchEvent(r)},100)),l.preventDefault();else if(l.key==="5")te.length>0?(fe(O.filter(r=>te.includes(r.id)),a.NotesAndHolds),z([])):(M(),setTimeout(()=>{const r=new CustomEvent("manualTagCreate",{detail:{category:a.NotesAndHolds}});window.dispatchEvent(r)},100)),l.preventDefault();else if(l.key==="6")te.length>0?(fe(O.filter(r=>te.includes(r.id)),a.OffPageConnector),z([])):(M(),setTimeout(()=>{const r=new CustomEvent("manualTagCreate",{detail:{category:a.OffPageConnector}});window.dispatchEvent(r)},100)),l.preventDefault();else if(l.key==="Delete"||l.key==="Backspace")L.length>0&&(l.preventDefault(),T(L),v([]));else if(l.key==="F2"){if(L.length===1){const r=L[0],b=c.find(S=>S.id===r);b&&(dt(r),jt(null),Pt(b.text))}else if(te.length===1){const r=te[0],b=O.find(S=>S.id===r);b&&(jt(r),dt(null),Pt(b.text))}l.preventDefault()}else if(l.key.toLowerCase()==="c")if(L.length>=2){l.preventDefault();const r=L.map(S=>c.find(I=>I.id===S)).filter(S=>!!S),b=[];for(let S=0;S<r.length-1;S++){const I=r[S],i=r[S+1];C.some(q=>q.from===I.id&&q.to===i.id&&q.type===J.Connection)||b.push({id:Fe(),from:I.id,to:i.id,type:J.Connection})}b.length>0&&j(S=>[...S,...b]),v([]),z([])}else oe==="connect"?(ge("select"),Be(null)):(ge("connect"),L.length===1?(c.find(r=>r.id===L[0]),Be(L[0])):(Be(null),v([])),z([]));else if(l.key.toLowerCase()==="k")oe==="manualCreate"?ge("select"):(ge("manualCreate"),Be(null),v([]),z([]));else if(l.key==="Escape")ge("select"),Be(null),v([]),z([]);else if(l.key.toLowerCase()==="m")te.length>=2?(F(te),z([])):alert("The 'M' hotkey merges multiple selected text items into one. Select at least 2 text items first.");else if(l.key.toLowerCase()==="n"){const r=c.filter(I=>L.includes(I.id)),b=O.filter(I=>te.includes(I.id)),S=[...r,...b];S.length>0?(ne(S),v([]),z([])):alert("Select tags or text items first, then press 'N' to create a description.")}else if(l.key.toLowerCase()==="h"){const r=c.filter(I=>L.includes(I.id)),b=O.filter(I=>te.includes(I.id)),S=[...r,...b];S.length>0?(ye(S),v([]),z([])):alert("Select tags or text items first, then press 'H' to create a hold description.")}else if(l.key.toLowerCase()==="p"){const r=c.filter(i=>L.includes(i.id)),b=O.filter(i=>te.includes(i.id)),S=[...r,...b],I=r.filter(i=>i.category===a.Equipment);I.length===1&&S.length>1?(K(S),v([]),z([])):I.length===0?alert("Select exactly one Equipment tag and some text items, then press 'P' to create an Equipment Short Spec."):I.length>1?alert("Select only one Equipment tag to create an Equipment Short Spec."):alert("Select an Equipment tag and some text items, then press 'P' to create an Equipment Short Spec.")}else if(l.key.toLowerCase()==="r"&&oe==="select"&&(L.length>0||te.length>0)){const r=[],b=c.filter(i=>L.includes(i.id)),S=[a.Equipment,a.Line,a.Instrument],I=b.filter(i=>S.includes(i.category));if(I.length>1){alert("Please select only one Equipment, Line, or Instrument tag at a time to create relationships.");return}if(I.length===1){const i=I[0],E=b.filter(q=>q.category===a.NotesAndHolds);for(const q of E)r.push({id:Fe(),from:i.id,to:q.id,type:J.Note});for(const q of te)r.push({id:Fe(),from:i.id,to:q,type:J.Annotation})}if(r.length>0){const i=new Set(C.map(q=>`${q.from}-${q.to}-${q.type}`)),E=r.filter(q=>!i.has(`${q.from}-${q.to}-${q.type}`));E.length>0&&j(q=>[...q,...E]),v([]),z([])}}else if(l.key.toLowerCase()==="i"&&oe==="select"&&L.length>1){const r=c.filter(I=>L.includes(I.id)),b=r.filter(I=>I.category===a.Equipment||I.category===a.Line),S=r.filter(I=>I.category===a.Instrument);if(b.length===1&&S.length>=1){const I=b[0],i=S.map(pe=>({id:Fe(),from:pe.id,to:I.id,type:J.Installation})),E=new Set(C.map(pe=>`${pe.from}-${pe.to}-${pe.type}`)),q=i.filter(pe=>!E.has(`${pe.from}-${pe.to}-${pe.type}`));q.length>0&&j(pe=>[...pe,...q]),v([])}}else if(l.key.toLowerCase()==="l"&&oe==="select"&&L.length>=2)c.filter(b=>L.includes(b.id)&&b.category===a.Instrument).length>=2&&R&&(R(L),v([]));else if(l.key.toLowerCase()==="v"){const b=!Object.values(je.relationships).every(Boolean);D({relationships:{connection:b,installation:b,annotation:b,note:b}})}else l.key.toLowerCase()==="q"&&o?U(r=>Math.max(1,r-1)):l.key.toLowerCase()==="w"&&o&&U(r=>Math.min(o.numPages,r+1))};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[oe,L,c,C,j,v,O,te,fe,ne,ye,z,T,F,R,ge,Be,p,o,U]),t.useEffect(()=>{const s=Ve.current;if(!s)return;const l=g=>{if(g.ctrlKey||g.metaKey){g.preventDefault();const r=g.deltaY>0?-.25:.25;le(b=>Math.min(10,Math.max(.25,b+r)))}};return s.addEventListener("wheel",l,{passive:!1}),()=>{s.removeEventListener("wheel",l)}},[p]),t.useLayoutEffect(()=>{if(L.length===1&&ve.current&&k){const s=L[0],l=c.find(g=>g.id===s);l&&l.page===N&&setTimeout(()=>{Ne({tagId:l.id,timestamp:Date.now()}),setTimeout(()=>Ne(null),100)},50)}},[L,N,k,c,p,Ne]),t.useLayoutEffect(()=>{if(Y.length===1&&ve.current&&k){const s=Y[0],l=_.find(g=>g.id===s);l&&l.page===N&&setTimeout(()=>{Ne({descriptionId:l.id,timestamp:Date.now()}),setTimeout(()=>Ne(null),100)},50)}},[Y,_,N,k,p,Ne]),t.useLayoutEffect(()=>{if(se.length===1&&ve.current&&k){const s=se[0],l=ie.find(g=>g.id===s);l&&l.page===N&&setTimeout(()=>{Ne({equipmentShortSpecId:l.id,timestamp:Date.now()}),setTimeout(()=>Ne(null),100)},50)}},[se,ie,N,k,p,Ne]);const Gt=(s,l)=>{s.stopPropagation(),Ee.current=!0;const g=s.ctrlKey||s.metaKey;if(oe==="select"){const r=c.find(b=>b.id===l);if(r&&(console.log(`🏷️ TAG CLICKED: "${r.text}" (Category: ${r.category})`),console.log(`📍 Position: X=${r.bbox.x1.toFixed(1)}-${r.bbox.x2.toFixed(1)}, Y=${r.bbox.y1.toFixed(1)}-${r.bbox.y2.toFixed(1)}, Page: ${r.page}`)),r&&r.category===a.DrawingNumber&&(console.log(`🎯 DRAWING NUMBER DEBUG - Selected: "${r.text}"`),console.log(`📍 Position: X=${r.bbox.x1.toFixed(1)}-${r.bbox.x2.toFixed(1)}, Y=${r.bbox.y1.toFixed(1)}-${r.bbox.y2.toFixed(1)}`),console.log(`📄 Page: ${r.page}`),o&&o.getPage(r.page).then(b=>{const S=b.getViewport({scale:1}),I=S.rotation||0,{width:i,height:E}=S;let q;switch(I){case 0:q={x:i,y:0};break;case 90:q={x:E,y:0};break;case 180:q={x:0,y:E};break;case 270:q={x:0,y:i};break;default:q={x:i,y:0};break}const pe=q.x-r.bbox.x2;let Re;switch(I){case 0:case 90:Re=Math.min(r.bbox.y1,r.bbox.y2);break;case 180:case 270:Re=Math.max(r.bbox.y1,r.bbox.y2);break;default:Re=Math.min(r.bbox.y1,r.bbox.y2);break}const qe=q.y-Re,G=Math.sqrt(pe*pe+qe*qe);console.log(`📏 Distance to right-bottom corner: ${G.toFixed(2)} (dx=${pe.toFixed(1)}, dy=${qe.toFixed(1)})`),console.log(`🔄 Page rotation: ${I}°`),console.log(`📐 Page dimensions: ${i.toFixed(1)} x ${E.toFixed(1)}`),console.log(`🎯 Right-bottom corner: (${q.x.toFixed(1)}, ${q.y.toFixed(1)})`),console.log("────────────────────────────────")}).catch(b=>{console.log(`❌ Error calculating distance: ${b.message}`)})),r&&r.category===a.OffPageConnector&&_e&&_e(r.text),r&&r.category===a.OffPageConnector){const b=C.find(S=>S.type===J.OffPageConnection&&(S.from===l||S.to===l));if(b){const S=b.from===l?b.to:b.from,I=c.find(i=>i.id===S);if(I&&I.page!==N){s.currentTarget.getBoundingClientRect();const i={tagId:l,x:s.clientX,y:s.clientY,targetTagId:S,targetPage:I.page,referenceText:r.text};Zt(i)}}}g?v(b=>b.includes(l)?b.filter(S=>S!==l):[...b,l]):(v([l]),z([]))}else oe==="connect"&&(We?We!==l&&(c.find(b=>b.id===We),c.find(b=>b.id===l),C.some(b=>b.from===We&&b.to===l&&b.type===J.Connection)||j(b=>[...b,{id:Fe(),from:We,to:l,type:J.Connection}]),Be(l),v([l])):(c.find(r=>r.id===l),Be(l),v([l])))},Lt=(s,l)=>{s.stopPropagation(),Ee.current=!0;const g=s.ctrlKey||s.metaKey,r=O.find(b=>b.id===l);r&&(console.log(`📝 RAW TEXT CLICKED: "${r.text}"`),console.log(`📍 Position: X=${r.bbox.x1.toFixed(1)}-${r.bbox.x2.toFixed(1)}, Y=${r.bbox.y1.toFixed(1)}-${r.bbox.y2.toFixed(1)}, Page: ${r.page}`),/[A-Z\d-]{5,}-[A-Z\d-]{5,}-\d{3,}/i.test(r.text)&&console.log("🎯 This raw text matches Drawing Number pattern!")),g?z(b=>b.includes(l)?b.filter(S=>S!==l):[...b,l]):(z([l]),v([]))},Qe=t.useMemo(()=>c.filter(s=>s.page===N),[c,N]),Ft=t.useMemo(()=>O.filter(s=>s.page===N),[O,N]),zt=t.useMemo(()=>_.filter(s=>s.page===N),[_,N]),lt=t.useMemo(()=>ie.filter(s=>s.page===N),[ie,N]),kt=s=>{if(s.target.closest("[data-tag-id]")||s.target.closest("[data-raw-text-id]")||s.target.closest("[data-equipment-short-spec-id]"))return;if(Ee.current=!1,Tt.current=!1,Zt(null),oe==="manualCreate"&&Ve.current){const g=Ve.current.getBoundingClientRect();Xe.current={x:s.clientX-g.left,y:s.clientY-g.top},Te(!0),Je({...Xe.current,width:0,height:0});return}const l=s.ctrlKey||s.metaKey;if(l&&oe==="select"&&Ve.current){const g=Ve.current.getBoundingClientRect();Xe.current={x:s.clientX-g.left,y:s.clientY-g.top},Te(!0),Je({...Xe.current,width:0,height:0})}else!l&&oe==="select"&&ve.current&&(Nt(!0),Ce.current={scrollX:ve.current.scrollLeft,scrollY:ve.current.scrollTop,clientX:s.clientX,clientY:s.clientY},s.preventDefault())},es=s=>{if((bt||me)&&(Tt.current=!0),bt&&ve.current){const l=s.clientX-Ce.current.clientX,g=s.clientY-Ce.current.clientY;ve.current.scrollLeft=Ce.current.scrollX-l,ve.current.scrollTop=Ce.current.scrollY-g;return}if(me&&Ve.current){const l=Ve.current.getBoundingClientRect(),g=s.clientX-l.left,r=s.clientY-l.top,b=Math.min(Xe.current.x,g),S=Math.min(Xe.current.y,r),I=Math.abs(Xe.current.x-g),i=Math.abs(Xe.current.y-r);Je({x:b,y:S,width:I,height:i})}},Vt=s=>{if(Ee.current){me&&(Te(!1),Je(null));return}if(bt&&Nt(!1),!Tt.current&&!me&&(v([]),z([])),!me||!Ae||!k){me&&Te(!1);return}if(oe==="manualCreate"){if(Te(!1),Ae.width>5&&Ae.height>5){const{x:r,y:b,width:S,height:I}=Ae,i={x1:r/p,y1:b/p,x2:(r+S)/p,y2:(b+I)/p};M(i,N)}Je(null),ge("select");return}Te(!1);const l=new Set;for(const r of Qe){const{x1:b,y1:S,x2:I,y2:i}=r.bbox,E={x:b*p,y:S*p,width:(I-b)*p,height:(i-S)*p};Ae.x<E.x+E.width&&Ae.x+Ae.width>E.x&&Ae.y<E.y+E.height&&Ae.y+Ae.height>E.y&&l.add(r.id)}l.size>0&&v(r=>Array.from(new Set([...r,...l])));const g=new Set;for(const r of Ft){const{x1:b,y1:S,x2:I,y2:i}=r.bbox,E={x:b*p,y:S*p,width:(I-b)*p,height:(i-S)*p};Ae.x<E.x+E.width&&Ae.x+Ae.width>E.x&&Ae.y<E.y+E.height&&Ae.y+Ae.height>E.y&&g.add(r.id)}g.size>0&&z(r=>Array.from(new Set([...r,...g]))),Je(null)},u=s=>{if(!k||!s||!s.bbox)return{x:0,y:0};const l=(s.bbox.x1+s.bbox.x2)/2,g=(s.bbox.y1+s.bbox.y2)/2;let r,b;switch(ke){case 90:r=g*p,b=l*p;break;case 180:r=l*p,b=g*p;break;case 270:r=l*p,b=g*p;break;default:r=l*p,b=g*p;break}return{x:r,y:b}},d=t.useMemo(()=>new Map(c.map(s=>[s.id,s])),[c]),x=t.useMemo(()=>new Map(O.map(s=>[s.id,s])),[O]),h=t.useMemo(()=>{if(!De)return[];const s=[];for(const l of C){if(l.type!==J.Connection&&l.type!==J.Installation||!Mt(l))continue;const g=d.get(l.from);if((g==null?void 0:g.page)!==N)continue;const r=d.get(l.to);if(!(!r||r.page!==N)){if(Oe&&L.length>0){const b=L.includes(g.id),S=L.includes(r.id);if(!b&&!S)continue}s.push({rel:l,fromTag:g,toItem:r,isAnnotation:!1})}}return s},[C,d,N,je.relationships,De,Oe,L]),m=s=>{if(!k)return{x:0,y:0};const l=x.get(s);if(!l)return{x:0,y:0};const g=(l.bbox.x1+l.bbox.x2)/2,r=(l.bbox.y1+l.bbox.y2)/2;let b,S;switch(ke){case 90:b=r*p,S=g*p;break;case 180:b=(k.width/p-g)*p,S=(k.height/p-r)*p;break;case 270:b=g*p,S=r*p;break;default:b=g*p,S=r*p;break}return{x:b,y:S}},f=(s,l)=>{if(!k)return{x:0,y:0};let g,r;switch(ke){case 90:g=s*p,r=l*p;break;case 180:g=s*p,r=l*p;break;case 270:g=s*p,r=l*p;break;default:g=s*p,r=l*p;break}return{x:g,y:r}},w=(s,l,g,r)=>{if(!k)return{rectX:0,rectY:0,rectWidth:0,rectHeight:0};let b,S,I,i;switch(ke){case 90:b=s*p,S=l*p,I=(g-s)*p,i=(r-l)*p;break;case 180:b=s*p,S=l*p,I=(g-s)*p,i=(r-l)*p;break;case 270:b=s*p,S=l*p,I=(g-s)*p,i=(r-l)*p;break;default:b=s*p,S=l*p,I=(g-s)*p,i=(r-l)*p;break}return{rectX:b,rectY:S,rectWidth:I,rectHeight:i}},W=()=>{switch(oe){case"connect":return"cursor-crosshair ring-2 ring-blue-500";case"manualCreate":return"cursor-crosshair ring-2 ring-green-500";default:return""}};return e.jsxs("div",{className:"relative h-full w-full",children:[e.jsx("div",{ref:ve,className:`h-full w-full overflow-auto ${bt?"cursor-grabbing":"cursor-grab"}`,children:e.jsx("div",{className:"p-4 grid place-items-center min-h-full",children:e.jsxs("div",{ref:Ve,className:`relative shadow-2xl ${W()}`,onMouseDown:kt,onMouseMove:es,onMouseUp:Vt,onMouseLeave:Vt,children:[e.jsx("canvas",{ref:Se}),k&&e.jsxs("svg",{className:"absolute top-0 left-0",width:k.width,height:k.height,style:{overflow:"visible"},children:[e.jsxs("defs",{children:[e.jsx("marker",{id:"arrowhead-connect",markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:"auto",children:e.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:Me.relationships.connection})}),e.jsx("marker",{id:"arrowhead-install",markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:"auto",children:e.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:Me.relationships.installation})})]}),Ft.map(s=>{const{x1:l,y1:g,x2:r,y2:b}=s.bbox,{rectX:S,rectY:I,rectWidth:i,rectHeight:E}=w(l,g,r,b),q=te.includes(s.id),pe=ct.has(s.id),Re=Bt.has(s.id),qe=()=>q?{fill:"rgb(56 189 248 / 0.5)",stroke:"#38bdf8",strokeWidth:"2.5",strokeDasharray:"none"}:pe?{fill:"rgb(139 69 255 / 0.6)",stroke:"#8b5cf6",strokeWidth:"2.5",strokeDasharray:"none"}:Re?{fill:`${Me.relationships.annotation}4D`,stroke:Me.relationships.annotation,strokeWidth:"1.5",strokeDasharray:"none"}:{fill:"transparent",stroke:"#64748b",strokeWidth:"2",strokeDasharray:"3 3",className:"group-hover:stroke-sky-400 group-hover:fill-sky-400/30 transition-all"};return e.jsx("g",{"data-raw-text-id":s.id,onMouseDown:G=>Lt(G,s.id),className:"cursor-pointer group",children:e.jsx("rect",{x:S,y:I,width:i,height:E,...qe()})},s.id)}),h.map(({rel:s,fromTag:l,toItem:g,isAnnotation:r})=>{if(!l||!g)return null;const b=u(l);let S,I,i;r?(S=m(s.to),I=At(s.type),i=""):(S=u(g),I=At(s.type),s.type===J.Connection?i="url(#arrowhead-connect)":s.type===J.Installation?i="url(#arrowhead-install)":i="");const E=y===s.id;return e.jsx(nn,{rel:s,start:b,end:S,strokeColor:I,marker:i,isPinged:E},s.id)}),Qe.map(s=>{const{x1:l,y1:g,x2:r,y2:b}=s.bbox,{rectX:S,rectY:I,rectWidth:i,rectHeight:E}=w(l,g,r,b),q=L.includes(s.id),pe=gt.has(s.id),Re=s.id===We,qe=yt.has(s.id),G=_t(s);return Ut(s.category),e.jsx("g",{"data-tag-id":s.id,onMouseDown:$e=>Gt($e,s.id),className:"cursor-pointer",children:s.category===a.OffPageConnector?(()=>{const nt=C.some(Rt=>Rt.type===J.OffPageConnection&&(Rt.from===s.id||Rt.to===s.id))?"#10b981":"#ef4444";return e.jsxs(e.Fragment,{children:[e.jsx("circle",{cx:S+i/2,cy:I+E/2,r:Math.max(i,E)/2+5,stroke:G?nt:"transparent",strokeWidth:q?"4":"2",className:`transition-all duration-150 ${pe?"animate-pulse":""}`,fill:G?q?`${nt}CC`:`${nt}33`:"rgba(255, 255, 255, 0.003)",strokeDasharray:Re?"4 2":"none",style:{pointerEvents:"all"}}),q&&G&&e.jsx("circle",{cx:S+i/2,cy:I+E/2,r:Math.max(i,E)/2+10,fill:"none",stroke:"#60a5fa",strokeWidth:"2",strokeOpacity:"0.8"}),e.jsx(ls,{bbox:{x1:S,y1:I,x2:S+i,y2:I+E},type:qe&&!pe?"related":"primary",effect:Ts(q,!1,qe),isSelected:q&&G,isHighlighted:pe&&G,isMultiSelection:L.length>1,colorSettings:Me})]})})():e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:S,y:I,width:i,height:E,stroke:G?Ut(s.category):"transparent",strokeWidth:q?"4":"2",className:"transition-all duration-150",fill:G?q?`${Ut(s.category)}CC`:`${Ut(s.category)}33`:"rgba(255, 255, 255, 0.003)",strokeDasharray:Re?"4 2":"none",style:{pointerEvents:"all"}}),e.jsx(ls,{bbox:{x1:S,y1:I,x2:S+i,y2:I+E},type:qe&&!pe?"related":"primary",effect:Ts(q,!1,qe),isSelected:q&&G,isHighlighted:pe&&G,isMultiSelection:L.length>1,colorSettings:Me})]})},s.id)}),he&&(()=>{const s=Qe.find(q=>q.id===he);if(!s)return null;const{x1:l,y1:g,x2:r,y2:b}=s.bbox,{rectX:S,rectY:I,rectWidth:i,rectHeight:E}=w(l,g,r,b);return e.jsx(ls,{bbox:{x1:S,y1:I,x2:S+i,y2:I+E},type:"primary",effect:"box",isPinged:!0,colorSettings:Me})})(),je.descriptions&&zt.map(s=>{var pe,Re,qe;const{x1:l,y1:g,x2:r,y2:b}=s.bbox,{rectX:S,rectY:I,rectWidth:i,rectHeight:E}=w(l,g,r,b),q=Y.includes(s.id);return e.jsx("g",{children:e.jsx("rect",{x:S,y:I,width:i,height:E,fill:q?`${((pe=Me.entities)==null?void 0:pe.description)||et.entities.description}4D`:`${((Re=Me.entities)==null?void 0:Re.description)||et.entities.description}26`,stroke:((qe=Me.entities)==null?void 0:qe.description)||et.entities.description,strokeWidth:"2",className:"cursor-pointer hover:opacity-80 transition-opacity",onClick:G=>{G.stopPropagation();const $e=G.ctrlKey||G.metaKey;H($e?q?nt=>nt.filter(Rt=>Rt!==s.id):nt=>[...nt,s.id]:[s.id])},rx:"3"})},s.id)}),ue&&(()=>{const s=_.find(q=>q.id===ue);if(!s||s.page!==N)return null;const{x1:l,y1:g,x2:r,y2:b}=s.bbox,{rectX:S,rectY:I,rectWidth:i,rectHeight:E}=w(l,g,r,b);return e.jsx(ls,{bbox:{x1:S,y1:I,x2:S+i,y2:I+E},type:"description",effect:"box",isPinged:!0,colorSettings:Me})})(),we&&(()=>{const s=ie.find(q=>q.id===we);if(!s||s.page!==N)return null;const{x1:l,y1:g,x2:r,y2:b}=s.bbox,{rectX:S,rectY:I,rectWidth:i,rectHeight:E}=w(l,g,r,b);return e.jsx(ls,{bbox:{x1:S,y1:I,x2:S+i,y2:I+E},type:"equipment",effect:"box",isPinged:!0,colorSettings:Me})})(),je.equipmentShortSpecs&&lt.map(s=>{var pe,Re,qe;const{x1:l,y1:g,x2:r,y2:b}=s.bbox,{rectX:S,rectY:I,rectWidth:i,rectHeight:E}=w(l,g,r,b),q=se.includes(s.id);return e.jsx("g",{children:e.jsx("rect",{"data-equipment-short-spec-id":s.id,x:S,y:I,width:i,height:E,fill:q?`${((pe=Me.entities)==null?void 0:pe.equipmentShortSpec)||et.entities.equipmentShortSpec}4D`:`${((Re=Me.entities)==null?void 0:Re.equipmentShortSpec)||et.entities.equipmentShortSpec}26`,stroke:((qe=Me.entities)==null?void 0:qe.equipmentShortSpec)||et.entities.equipmentShortSpec,strokeWidth:"2",className:"cursor-pointer hover:opacity-80 transition-opacity",onClick:G=>{G.stopPropagation();const $e=G.ctrlKey||G.metaKey;Q($e?q?nt=>nt.filter(Rt=>Rt!==s.id):nt=>[...nt,s.id]:[s.id])},rx:"3"})},s.id)}),Ze&&Ie&&(($=Ie[a.Instrument])==null?void 0:$.autoLinkDistance)&&Qe.filter(s=>s.category===a.Instrument).map(s=>{const l=Ie[a.Instrument].autoLinkDistance,{x1:g,y1:r,x2:b,y2:S}=s.bbox,I=(g+b)/2,i=(r+S)/2;let E,q,pe;switch(ke){case 90:E=I*p,q=i*p,pe=l*p;break;case 180:E=(k.width-I)*p,q=(k.height-i)*p,pe=l*p;break;case 270:E=(k.height-i)*p,q=I*p,pe=l*p;break;default:E=I*p,q=i*p,pe=l*p;break}return e.jsx("circle",{cx:E,cy:q,r:pe,fill:"none",stroke:"#3b82f6",strokeWidth:"2",strokeDasharray:"5,5",opacity:"0.6",pointerEvents:"none"},`range-${s.id}`)}),Ae&&e.jsx("rect",{x:Ae.x,y:Ae.y,width:Ae.width,height:Ae.height,className:`stroke-2 ${oe==="manualCreate"?"fill-green-400/20 stroke-green-400":"fill-sky-400/20 stroke-sky-400"}`})]}),(it||rt)&&(()=>{let s=null;if(it?s=c.find(q=>q.id===it&&q.page===N):rt&&(s=O.find(q=>q.id===rt&&q.page===N)),!s||!k)return null;const{x1:l,y1:g,x2:r,y2:b}=s.bbox,{rectX:S,rectY:I,rectWidth:i,rectHeight:E}=w(l,g,r,b);return e.jsxs("div",{className:"absolute bg-white border-2 border-blue-500 rounded shadow-lg z-50 flex items-center gap-1 px-2 py-1",style:{left:S,top:I-35,minWidth:Math.max(i,120)},children:[e.jsx("input",{ref:ft,type:"text",value:St,onChange:q=>Pt(q.target.value),onKeyDown:Kt,className:"flex-1 border-none outline-none bg-white text-gray-800 text-sm font-mono px-1 py-0.5",style:{fontSize:"13px",color:"#1f2937",backgroundColor:"#ffffff"},autoComplete:"off",spellCheck:"false"}),e.jsx("button",{onClick:()=>Ht(!0),className:"p-1 hover:bg-green-100 rounded text-green-600 hover:text-green-700 transition-colors",title:"저장 (Enter)",onMouseDown:q=>q.preventDefault(),children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("button",{onClick:()=>Ht(!1),className:"p-1 hover:bg-red-100 rounded text-red-500 hover:text-red-600 transition-colors",title:"취소 (Esc)",onMouseDown:q=>q.preventDefault(),children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})()]})})}),xt&&e.jsx("div",{className:"fixed z-50 pointer-events-none",style:{left:xt.x+10,top:xt.y-10},children:e.jsxs("button",{onClick:Yt,className:"pointer-events-auto bg-violet-600 hover:bg-violet-500 text-white px-3 py-2 rounded-lg shadow-lg flex items-center space-x-2 transition-all duration-200 animate-fade-in",children:[e.jsxs("span",{className:"text-sm font-medium",children:["Go to ",xt.referenceText]}),e.jsxs("span",{className:"text-xs bg-white/20 px-1.5 py-0.5 rounded",children:["P",xt.targetPage]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 7l5 5m0 0l-5 5m5-5H6"})})]})})]})},rn=ot.memo(on,(o,c)=>o.currentPage===c.currentPage&&o.scale===c.scale&&o.mode===c.mode&&o.tags===c.tags&&o.relationships===c.relationships&&o.rawTextItems===c.rawTextItems&&o.descriptions===c.descriptions&&o.equipmentShortSpecs===c.equipmentShortSpecs&&o.selectedTagIds===c.selectedTagIds&&o.selectedRawTextItemIds===c.selectedRawTextItemIds&&o.selectedDescriptionIds===c.selectedDescriptionIds&&o.selectedEquipmentShortSpecIds===c.selectedEquipmentShortSpecIds&&o.visibilitySettings===c.visibilitySettings&&o.showAutoLinkRanges===c.showAutoLinkRanges),an=(o,c,A,C=[],j=[],N=[],U=[])=>{const L=o.filter(y=>y.category===a.Equipment),v=o.filter(y=>y.category===a.Line),Y=o.filter(y=>y.category===a.Instrument),H=o.filter(y=>y.category===a.SpecialItem),se=o.filter(y=>y.category===a.DrawingNumber),Q=o.filter(y=>y.category===a.OffPageConnector),O=new Map(se.map(y=>[y.page,y.text])),_=new Map(A.map(y=>[y.id,y.text])),ie=y=>{var ae;return((ae=o.find(be=>be.id===y))==null?void 0:ae.text)||""},fe=y=>{const ae=N.find(be=>be.tagIds.includes(y));return ae?ae.id:""},ne=y=>c.filter(ae=>ae.from===y&&ae.type===J.Annotation).map(ae=>_.get(ae.to)).filter(Boolean).join(" | "),ye=y=>c.filter(ae=>ae.from===y&&ae.type===J.Note).map(ae=>ie(ae.to)).filter(Boolean).join(", "),K=y=>{const ae=U.filter(be=>be.targetId===y);return ae.length===0?"":ae.map(be=>{const Ne=be.priority==="high"?"🔴":be.priority==="medium"?"🟡":"⚪",Ze=be.isResolved?"✅":"🕐";return`${Ne} ${Ze} ${be.content} (${be.author})`}).join(" | ")},te=L.map(y=>{const ae=c.filter(De=>De.to===y.id&&De.type===J.Installation).map(De=>ie(De.from)).filter(Boolean).join(", "),be=O.get(y.page)||"",Ne=ne(y.id),Ze=ye(y.id),Ie=fe(y.id);return{Tag:y.text,"Loop No":Ie,Page:y.page,"Drawing Number":be,"Instruments Installed":ae,Related:Ne,"Note & Hold":Ze,Comments:K(y.id)}}),z=v.map(y=>{const ae=c.filter(Oe=>Oe.to===y.id&&Oe.type===J.Connection).map(Oe=>ie(Oe.from)).filter(Boolean).join(", "),be=c.filter(Oe=>Oe.from===y.id&&Oe.type===J.Connection).map(Oe=>ie(Oe.to)).filter(Boolean).join(", "),Ne=c.filter(Oe=>Oe.to===y.id&&Oe.type===J.Installation).map(Oe=>ie(Oe.from)).filter(Boolean).join(", "),Ze=O.get(y.page)||"",Ie=ne(y.id),De=ye(y.id),Ue=fe(y.id);return{Tag:y.text,"Loop No":Ue,Page:y.page,"Drawing Number":Ze,From:ae,To:be,"Instruments Installed":Ne,Related:Ie,"Note & Hold":De,Comments:K(y.id)}}),T=Y.map(y=>{const ae=c.filter(De=>De.from===y.id&&De.type===J.Installation).map(De=>ie(De.to)).filter(Boolean).join(", "),be=O.get(y.page)||"",Ne=ne(y.id),Ze=ye(y.id),Ie=fe(y.id);return{Tag:y.text,"Loop No":Ie,Page:y.page,"Drawing Number":be,"Installed On":ae,Related:Ne,"Note & Hold":Ze,Comments:K(y.id)}}),F=H.map(y=>{const ae=c.filter(De=>De.to===y.id&&De.type===J.Installation).map(De=>ie(De.from)).filter(Boolean).join(", "),be=O.get(y.page)||"",Ne=ne(y.id),Ze=ye(y.id),Ie=fe(y.id);return{Tag:y.text,"Loop No":Ie,Page:y.page,"Drawing Number":be,"Instruments Installed":ae,Related:Ne,"Note & Hold":Ze,Comments:K(y.id)}}),R=C.map(y=>{const ae=O.get(y.page)||"";return{Type:y.metadata.type,Number:y.metadata.number,Scope:y.metadata.scope,Text:y.text,Page:y.page,"Drawing Number":ae,Comments:K(y.id)}}),M=j.map(y=>{const ae=O.get(y.page)||"";return{"Equipment Tag":y.metadata.originalEquipmentTag.text,Service:y.metadata.service||"","Short Spec":y.text,Page:y.page,"Drawing Number":ae,Comments:K(y.id)}}),Z=U.map(y=>{const be=((Ie,De)=>{switch(De){case"tag":const Ue=o.find(Ee=>Ee.id===Ie);return{name:Ue?Ue.text:"Unknown Tag",page:Ue?Ue.page:"",category:Ue?Ue.category:""};case"description":const Oe=C.find(Ee=>Ee.id===Ie);return{name:Oe?`${Oe.metadata.type} ${Oe.metadata.number}`:"Unknown Description",page:Oe?Oe.page:"",category:"Description"};case"equipmentSpec":const Ge=j.find(Ee=>Ee.id===Ie);return{name:Ge?Ge.metadata.originalEquipmentTag.text:"Unknown Equipment Spec",page:Ge?Ge.page:"",category:"Equipment Spec"};case"loop":const _e=N.find(Ee=>Ee.id===Ie),Se=_e?_e.tagIds.map(Ee=>o.find(k=>k.id===Ee)).filter(Boolean):[];return{name:_e?_e.name||_e.id:"Unknown Loop",page:Se.length>0?Se.map(Ee=>Ee.page).filter((Ee,k,X)=>X.indexOf(Ee)===k).sort((Ee,k)=>Ee-k).join(", "):"",category:"Loop"};case"relationship":const Ve=c.find(Ee=>Ee.id===Ie);if(!Ve)return{name:"Unknown Relationship",page:"",category:"Relationship"};const ve=[...o,...C].find(Ee=>Ee.id===Ve.from),Xe=[...o,...C].find(Ee=>Ee.id===Ve.to);return{name:`${(ve==null?void 0:ve.text)||"Unknown"} → ${(Xe==null?void 0:Xe.text)||"Unknown"}`,page:ve?ve.page:Xe?Xe.page:"",category:"Relationship"};default:return{name:"Unknown",page:"",category:"Unknown"}}})(y.targetId,y.targetType),Ne=be.page&&O.get(be.page)||"";return{"Target Type":(Ie=>{switch(Ie){case"tag":return"Tags";case"description":return"Notes";case"equipmentSpec":return"Equipment Specs";case"relationship":return"Relations";case"loop":return"Loops";default:return Ie}})(y.targetType),"Target Name":be.name,Category:be.category,Page:be.page,"Drawing Number":Ne,Priority:y.priority.toUpperCase(),Status:y.isResolved?"Resolved":"Open",Content:y.content,Author:y.author,Created:new Date(y.timestamp).toLocaleString()}}),xe=[],p=c.filter(y=>y.type===J.OffPageConnection),le=new Map;Q.forEach(y=>{const ae=y.text;le.has(ae)||le.set(ae,[]),le.get(ae).push(y)}),le.forEach((y,ae)=>{if(y.length===2){const[be,Ne]=y,Ze=p.some(Ie=>Ie.from===be.id&&Ie.to===Ne.id||Ie.from===Ne.id&&Ie.to===be.id);xe.push({Reference:ae,"Page 1":be.page,"Drawing Number 1":O.get(be.page)||"","Page 2":Ne.page,"Drawing Number 2":O.get(Ne.page)||"",Status:Ze?"Connected":"Not Connected","Location 1":`(${Math.round(be.bbox.x1)}, ${Math.round(be.bbox.y1)})`,"Location 2":`(${Math.round(Ne.bbox.x1)}, ${Math.round(Ne.bbox.y1)})`,"Comments 1":K(be.id),"Comments 2":K(Ne.id)})}else y.forEach((be,Ne)=>{xe.push({Reference:ae,"Page 1":be.page,"Drawing Number 1":O.get(be.page)||"","Page 2":"","Drawing Number 2":"",Status:y.length===1?"Unmatched":`Multiple (${y.length} found)`,"Location 1":`(${Math.round(be.bbox.x1)}, ${Math.round(be.bbox.y1)})`,"Location 2":"","Comments 1":K(be.id),"Comments 2":""})})});const oe=mt.book_new(),ge=mt.json_to_sheet(te);mt.book_append_sheet(oe,ge,"Equipment List");const We=mt.json_to_sheet(z);mt.book_append_sheet(oe,We,"Line List");const Be=mt.json_to_sheet(T);mt.book_append_sheet(oe,Be,"Instrument List");const je=mt.json_to_sheet(F);mt.book_append_sheet(oe,je,"Special Item List");const D=mt.json_to_sheet(R);mt.book_append_sheet(oe,D,"Descriptions");const he=mt.json_to_sheet(M);mt.book_append_sheet(oe,he,"Equipment Short Specs");const ue=mt.json_to_sheet(Z);mt.book_append_sheet(oe,ue,"Comments");const we=mt.json_to_sheet(xe);mt.book_append_sheet(oe,we,"OPC Connections"),Vs(oe,"P&ID_Tag_Export.xlsx")},ln={high:"text-red-400 bg-red-500/20 border-red-500/30",medium:"text-yellow-400 bg-yellow-500/20 border-yellow-500/30",low:"text-slate-400 bg-slate-500/20 border-slate-500/30"},cn={high:"🔴 HIGH",medium:"🟡 MED",low:"⚪ LOW"},dn=({isOpen:o,targetId:c,targetName:A,targetType:C,comments:j,onClose:N,onCreateComment:U,onUpdateComment:L,onDeleteComment:v})=>{const[Y,H]=t.useState(""),[se,Q]=t.useState("medium"),[O,_]=t.useState(null),[ie,fe]=t.useState(""),[ne,ye]=t.useState("medium"),K=t.useRef(null);if(t.useEffect(()=>{const Z=p=>{p.key==="Escape"&&N()},xe=p=>{K.current&&!K.current.contains(p.target)&&N()};return o&&(document.addEventListener("keydown",Z),document.addEventListener("mousedown",xe)),()=>{document.removeEventListener("keydown",Z),document.removeEventListener("mousedown",xe)}},[o,N]),!o)return null;const te=()=>{Y.trim()&&(U(Y.trim(),se),H(""),Q("medium"))},z=Z=>{_(Z.id),fe(Z.content),ye(Z.priority)},T=()=>{O&&ie.trim()&&(L(O,{content:ie.trim(),priority:ne}),_(null),fe(""))},F=()=>{_(null),fe("")},R=[...j].sort((Z,xe)=>{if(Z.isResolved!==xe.isResolved)return Z.isResolved?1:-1;const p={high:3,medium:2,low:1};return p[Z.priority]!==p[xe.priority]?p[xe.priority]-p[Z.priority]:xe.timestamp-Z.timestamp}),M=j.filter(Z=>!Z.isResolved).length;return e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 animate-fade-in-up",children:e.jsxs("div",{ref:K,className:"bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col text-white",children:[e.jsx("div",{className:"flex-shrink-0 p-6 border-b border-slate-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold mb-1",children:"Comments"}),e.jsxs("p",{className:"text-slate-400",children:[C,": ",e.jsx("span",{className:"text-sky-400",children:A})]}),j.length>0&&e.jsxs("p",{className:"text-sm text-slate-500 mt-1",children:[j.length," total • ",M," unresolved"]})]}),e.jsx("button",{onClick:N,className:"text-slate-400 hover:text-white transition-colors p-1",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:R.length===0?e.jsx("p",{className:"text-slate-500 text-center py-8",children:"No comments yet"}):e.jsx("div",{className:"space-y-4",children:R.map(Z=>e.jsx("div",{className:`p-4 rounded-lg border ${Z.isResolved?"bg-slate-700/30 border-slate-600/50":"bg-slate-700/50 border-slate-600"}`,children:O===Z.id?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("select",{value:ne,onChange:xe=>ye(xe.target.value),className:"px-3 py-1 bg-slate-800 border border-slate-600 rounded text-sm",children:[e.jsx("option",{value:"high",children:"🔴 HIGH"}),e.jsx("option",{value:"medium",children:"🟡 MEDIUM"}),e.jsx("option",{value:"low",children:"⚪ LOW"})]})}),e.jsx("textarea",{value:ie,onChange:xe=>fe(xe.target.value),className:"w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white placeholder-slate-400 resize-none",rows:3,placeholder:"Edit comment...",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:T,className:"px-4 py-2 bg-sky-600 hover:bg-sky-700 rounded-lg text-sm font-medium transition-colors",children:"Save"}),e.jsx("button",{onClick:F,className:"px-4 py-2 bg-slate-600 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors",children:"Cancel"})]})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs font-semibold border ${ln[Z.priority]}`,children:cn[Z.priority]}),e.jsxs("span",{className:"text-slate-400 text-sm",children:[Z.author," • ",new Date(Z.timestamp).toLocaleString()]}),Z.isResolved&&e.jsx("span",{className:"text-green-400 text-sm",children:"✅ Resolved"})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>z(Z),className:"p-1 text-slate-400 hover:text-sky-400 transition-colors",title:"Edit",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),e.jsx("button",{onClick:()=>L(Z.id,{isResolved:!Z.isResolved}),className:`p-1 transition-colors ${Z.isResolved?"text-green-400 hover:text-green-300":"text-slate-400 hover:text-green-400"}`,title:Z.isResolved?"Mark as unresolved":"Mark as resolved",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("button",{onClick:()=>v(Z.id),className:"p-1 text-slate-400 hover:text-red-400 transition-colors",title:"Delete",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]}),e.jsx("p",{className:`${Z.isResolved?"text-slate-400":"text-white"} whitespace-pre-wrap`,children:Z.content})]})},Z.id))})}),e.jsx("div",{className:"flex-shrink-0 p-6 border-t border-slate-700",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("select",{value:se,onChange:Z=>Q(Z.target.value),className:"px-3 py-2 bg-slate-800 border border-slate-600 rounded text-sm",children:[e.jsx("option",{value:"high",children:"🔴 HIGH"}),e.jsx("option",{value:"medium",children:"🟡 MEDIUM"}),e.jsx("option",{value:"low",children:"⚪ LOW"})]})}),e.jsx("textarea",{value:Y,onChange:Z=>H(Z.target.value),className:"w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white placeholder-slate-400 resize-none",rows:3,placeholder:"Add a comment..."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:te,disabled:!Y.trim(),className:"px-6 py-2 bg-sky-600 hover:bg-sky-700 disabled:bg-slate-600 disabled:cursor-not-allowed rounded-lg font-medium transition-colors",children:"Add Comment"}),e.jsx("button",{onClick:N,className:"px-6 py-2 bg-slate-600 hover:bg-slate-700 rounded-lg font-medium transition-colors",children:"Close"})]})]})})]})})},rs=({comments:o,onClick:c,size:A="sm",className:C=""})=>{const j=o.filter(Y=>!Y.isResolved),N={high:o.filter(Y=>Y.priority==="high"&&!Y.isResolved).length,medium:o.filter(Y=>Y.priority==="medium"&&!Y.isResolved).length,low:o.filter(Y=>Y.priority==="low"&&!Y.isResolved).length},U=j.length>0,L=o.length,v={sm:"text-xs px-1.5 py-0.5",md:"text-sm px-2 py-1"};return e.jsxs("div",{className:`inline-flex items-center gap-1 ${C}`,children:[e.jsxs("button",{onClick:c,className:`
          inline-flex items-center gap-1 rounded-md font-medium transition-colors
          ${v[A]}
          ${L===0?"bg-slate-500/20 text-slate-400 border border-slate-500/30 hover:bg-slate-500/30":U?"bg-amber-500/20 text-amber-400 border border-amber-500/30 hover:bg-amber-500/30":"bg-green-500/20 text-green-400 border border-green-500/30 hover:bg-green-500/30"}
        `,title:L===0?"Click to add comment":`${L} comment(s) - ${j.length} unresolved`,children:["💬",L===0&&e.jsx("span",{className:"text-xs",children:"+"}),e.jsx("span",{children:L}),U&&e.jsxs("span",{className:"text-amber-300",children:["(",j.length,")"]})]}),U&&(N.high>0||N.medium>0)&&e.jsxs("div",{className:"inline-flex items-center gap-0.5",children:[N.high>0&&e.jsxs("span",{className:"inline-flex items-center gap-0.5 px-1 py-0.5 bg-red-500/20 text-red-400 border border-red-500/30 rounded text-xs font-medium",children:["🔴",N.high]}),N.medium>0&&e.jsxs("span",{className:"inline-flex items-center gap-0.5 px-1 py-0.5 bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded text-xs font-medium",children:["🟡",N.medium]})]})]})},qt=ot.memo(({onClick:o})=>e.jsx("button",{onClick:c=>{c.stopPropagation(),o()},className:"ml-2 p-0.5 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors",title:"Delete relationship",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),ys=ot.memo(({onClick:o})=>e.jsx("button",{onClick:c=>{c.stopPropagation(),o()},className:"p-1 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100",title:"Delete tag",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})),fs=ot.memo(({onClick:o,title:c="Edit"})=>e.jsx("button",{onClick:A=>{A.stopPropagation(),o()},className:"p-1 rounded-full text-slate-500 hover:bg-sky-500/20 hover:text-sky-400 transition-colors opacity-0 group-hover:opacity-100",title:c,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{d:"M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"}),e.jsx("path",{fillRule:"evenodd",d:"M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z",clipRule:"evenodd"})]})})),gs=ot.memo(({onClick:o,title:c="Save"})=>e.jsx("button",{onClick:A=>{A.stopPropagation(),o()},className:"p-1 rounded-full text-green-400 hover:text-green-300 transition-colors",title:c,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})),bs=ot.memo(({onClick:o,title:c="Cancel"})=>e.jsx("button",{onClick:A=>{A.stopPropagation(),o()},className:"p-1 rounded-full text-slate-400 hover:text-slate-300 transition-colors",title:c,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),Bs=fs,xn=ot.memo(({item:o,relId:c,onDeleteRelationship:A,onDeleteItem:C,onUpdateItemText:j})=>{const[N,U]=t.useState(!1),[L,v]=t.useState(o.text),Y=t.useRef(null);t.useEffect(()=>{N&&Y.current&&(Y.current.focus(),Y.current.select())},[N]),t.useEffect(()=>{v(o.text)},[o.text]);const H=()=>{const Q=L.trim();Q&&Q!==o.text&&j(o.id,Q),U(!1)},se=Q=>{Q.key==="Enter"?H():Q.key==="Escape"&&(v(o.text),U(!1))};return e.jsxs("div",{className:"group flex items-center justify-between",onClick:Q=>{N&&Q.stopPropagation()},children:[e.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",title:o.text,children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 text-slate-500 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z",clipRule:"evenodd"})}),N?e.jsx("input",{ref:Y,type:"text",value:L,onChange:Q=>v(Q.target.value),onBlur:H,onKeyDown:se,onClick:Q=>Q.stopPropagation(),className:"font-mono text-sm text-white bg-slate-600 border border-sky-500 rounded px-1 w-full"}):e.jsx("span",{className:"text-slate-300 font-mono truncate max-w-[180px]",children:o.text})]}),e.jsxs("div",{className:"flex items-center flex-shrink-0",children:[e.jsx(Bs,{onClick:()=>U(!0)}),e.jsx(ys,{onClick:()=>C(o.id)}),e.jsx(qt,{onClick:()=>A(c)})]})]})}),mn=ot.memo(({tag:o,isSelected:c,onItemClick:A,onGoToTag:C,relationships:j,allTags:N,allRawTextItems:U,descriptions:L,equipmentShortSpecs:v,loops:Y,onToggleReviewStatus:H,onDeleteRelationship:se,onDeleteTag:Q,onUpdateTagText:O,onDeleteItem:_,onUpdateItemText:ie,onUpdateLoop:fe,showDetails:ne,comments:ye,onOpenComments:K,getCommentsForTarget:te})=>{const[z,T]=t.useState(!1),[F,R]=t.useState(o.text),[M,Z]=t.useState(new Set),[xe,p]=t.useState(new Set),[le,oe]=t.useState(new Set),[ge,We]=t.useState(new Set),Be=t.useRef(null),je=t.useRef(!1),D=xs[o.category],he={[a.Equipment]:"E",[a.Line]:"L",[a.Instrument]:"I",[a.DrawingNumber]:"D",[a.NotesAndHolds]:"N",[a.SpecialItem]:"S",[a.Uncategorized]:"U"},ue=t.useMemo(()=>new Map(N.map(k=>[k.id,k])),[N]),we=t.useMemo(()=>new Map(U.map(k=>[k.id,k])),[U]);t.useEffect(()=>{z&&Be.current&&(Be.current.focus(),Be.current.select())},[z]),t.useEffect(()=>{R(o.text)},[o.text]);const y=()=>{const k=F.trim();k&&k!==o.text&&O(o.id,k),T(!1)},ae=k=>{k.key==="Enter"?y():k.key==="Escape"&&(R(o.text),T(!1))},be=(k,X)=>{k.stopPropagation();const ke=ue.get(X)||N.find(Le=>Le.id===X);ke&&C(ke)},Ne=(k,X)=>e.jsx("span",{onClick:ke=>be(ke,k),className:"text-sky-400 hover:text-sky-300 hover:underline cursor-pointer font-mono",children:X}),Ze=t.useMemo(()=>{const k=N.filter(X=>X.page===o.page&&X.category===a.DrawingNumber);return k.length>0?k[0]:null},[N,o.page]),Ie=j.filter(k=>k.from===o.id&&k.type===J.Connection),De=j.filter(k=>k.to===o.id&&k.type===J.Connection),Ue=j.find(k=>k.from===o.id&&k.type===J.Installation),Oe=j.filter(k=>k.to===o.id&&k.type===J.Installation),Ge=j.filter(k=>k.from===o.id&&k.type===J.Annotation),_e=j.filter(k=>k.from===o.id&&k.type===J.Note),Se=j.filter(k=>k.to===o.id&&k.type===J.Note),Ve=j.filter(k=>k.from===o.id&&k.type===J.Description),ve=j.filter(k=>k.to===o.id&&k.type===J.Description),Xe=j.filter(k=>k.from===o.id&&k.type===J.EquipmentShortSpec),Ee=Ie.length>0||De.length>0||Ue||Oe.length>0||Ge.length>0||_e.length>0||Se.length>0||Ve.length>0||ve.length>0||Xe.length>0;return e.jsxs("li",{"data-tag-id":o.id,onClick:k=>{z||A(k)},className:`group p-2 rounded-md cursor-pointer transition-colors ${c?"bg-red-500/30 ring-1 ring-red-500":"hover:bg-slate-700/50"}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-grow mr-2",children:[z?e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("input",{ref:Be,type:"text",value:F,onChange:k=>R(k.target.value),onKeyDown:ae,onClick:k=>k.stopPropagation(),className:"font-mono text-sm text-white bg-slate-600 border border-sky-500 rounded px-1 flex-grow"}),e.jsx(gs,{onClick:y}),e.jsx(bs,{onClick:()=>{R(o.text),T(!1)}})]}):e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center space-x-2 flex-grow min-w-0",children:[e.jsx("input",{type:"checkbox",checked:o.isReviewed||!1,onChange:k=>{k.stopPropagation(),H(o.id)},className:"w-4 h-4 text-sky-600 bg-slate-700 border-slate-500 rounded focus:ring-sky-500 focus:ring-2",title:"Mark as reviewed"}),e.jsx("span",{className:`inline-flex items-center justify-center w-5 h-5 rounded text-xs font-bold text-white ${D.bg} ${D.border} border flex-shrink-0`,title:o.category,children:he[o.category]}),e.jsx("span",{className:"font-mono text-sm text-white truncate",children:o.text})]}),e.jsx(rs,{comments:te(o.id),onClick:()=>K(o.id,o.text,"tag"),size:"sm",className:"flex-shrink-0 ml-2"})]}),o.category!==a.DrawingNumber&&Ze&&e.jsxs("div",{className:"text-xs text-slate-500 mt-0.5 font-mono",children:["DWG: ",Ze.text]}),o.category===a.Instrument&&ne&&(()=>{const k=Y.filter(X=>X.tagIds.includes(o.id));return k.length>0&&e.jsx("div",{className:"mt-1",children:k.map(X=>{const ke=ge.has(X.id),Le=X.tagIds.map(me=>N.find(Te=>Te.id===me)).filter(Boolean);return e.jsxs("div",{className:"mb-1",children:[e.jsxs("div",{className:"flex items-center justify-between cursor-pointer hover:bg-slate-700/20 rounded px-1 py-0.5 transition-colors",onClick:me=>{me.stopPropagation(),We(Te=>{const Ae=new Set(Te);return Ae.has(X.id)?Ae.delete(X.id):Ae.add(X.id),Ae})},children:[e.jsxs("span",{className:"text-xs text-blue-400 font-mono",children:["Loop: ",X.name||X.id]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-3 w-3 text-slate-400 transition-transform ${ke?"rotate-180":""}`,viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z",clipRule:"evenodd"})})]}),ke&&e.jsxs("div",{className:"mt-1 ml-2 p-2 border border-slate-600/50 rounded-md bg-slate-800/30",children:[e.jsx("div",{className:"flex items-center space-x-2 mb-2",children:e.jsxs("span",{className:"text-xs text-slate-400",children:["(",Le.length," tags)",Le.length>0&&` P. ${Le.map(me=>me.page).filter((me,Te,Ae)=>Ae.indexOf(me)===Te).sort((me,Te)=>me-Te).join(", ")}`]})}),e.jsx("div",{className:"flex flex-wrap gap-1",children:Le.map(me=>e.jsxs("div",{className:`inline-flex items-center bg-slate-600/50 text-slate-300 rounded text-xs font-mono overflow-hidden ${me.id===o.id?"ring-1 ring-blue-400":""}`,children:[e.jsxs("span",{onClick:Te=>{Te.stopPropagation(),C(me)},className:"px-2 py-1 cursor-pointer hover:bg-slate-500/50 transition-colors",title:`Click to center on tag: ${me.text}`,children:[me.text," ",e.jsxs("span",{className:"text-slate-400",children:["P.",me.page]})]}),me.id!==o.id&&e.jsx("button",{onClick:Te=>{Te.stopPropagation(),fe(X.id,{...X,tagIds:X.tagIds.filter(Ae=>Ae!==me.id)})},className:"px-1 py-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 transition-colors",title:`Remove ${me.text} from loop`,children:"✕"})]},me.id))})]})]},X.id)})})})()]}),e.jsxs("div",{className:"flex items-center space-x-1 flex-shrink-0",children:[e.jsxs("span",{className:"text-xs text-slate-400",children:["P. ",o.page]}),e.jsx(Bs,{onClick:()=>T(!0)}),e.jsx(ys,{onClick:()=>Q(o.id)})]})]}),ne&&Ee&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-slate-700/50 space-y-1 text-xs text-slate-300",children:[Ie.map(k=>{const X=ue.get(k.to);return X?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-slate-300 text-xs",children:"To"}),Ne(X.id,X.text)]}),e.jsx(qt,{onClick:()=>se(k.id)})]},k.id):null}),De.map(k=>{const X=ue.get(k.from);return X?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-slate-300 text-xs",children:"From"}),Ne(X.id,X.text)]}),e.jsx(qt,{onClick:()=>se(k.id)})]},k.id):null}),Ue&&ue.get(Ue.to)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"Installation",children:"📌"}),e.jsx("span",{className:"text-slate-400",children:"Installed on:"}),Ne(Ue.to,ue.get(Ue.to).text)]}),e.jsx(qt,{onClick:()=>se(Ue.id)})]}),Oe.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Installed Instruments:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:Oe.map(k=>{const X=ue.get(k.from);return X?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:Ne(X.id,X.text)}),e.jsx(qt,{onClick:()=>se(k.id)})]},k.id):null})})]}),Ge.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Related Text:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:Ge.map(k=>{const X=we.get(k.to);return X?e.jsx(xn,{item:X,relId:k.id,onDeleteRelationship:se,onDeleteItem:_,onUpdateItemText:ie},k.id):null})})]}),_e.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Notes:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:_e.map(k=>{const X=ue.get(k.to);if(!X)return null;const ke=j.filter(me=>me.from===X.id&&me.type===J.Description).map(me=>L.find(Te=>Te.id===me.to)).filter(Boolean),Le=le.has(X.id);return e.jsxs("div",{className:"border border-slate-600 rounded-md bg-slate-700/20",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:me=>{me.stopPropagation(),je.current=!0;const Te=new Set(le);Le?Te.delete(X.id):Te.add(X.id),oe(Te),setTimeout(()=>{je.current=!1},50)},className:"flex items-center space-x-1.5 text-left flex-grow cursor-pointer",children:[e.jsx("span",{title:"Note",children:"📝"}),e.jsx("span",{className:"text-sky-400 hover:text-sky-300 font-mono",children:X.text}),ke.length>0&&e.jsxs("span",{className:"text-slate-400 text-xs",children:["(",ke.length,") ",Le?"▼":"▶"]})]}),e.jsx(qt,{onClick:()=>se(k.id)})]}),Le&&ke.length>0&&e.jsx("div",{className:"px-3 pb-2 border-t border-slate-600",children:e.jsx("div",{className:"space-y-1 mt-2",children:ke.map(me=>{const Te=j.find(Je=>Je.from===X.id&&Je.to===me.id&&Je.type===J.Description),Ae=M.has(me.id);return e.jsxs("div",{className:"border border-slate-500 rounded-md bg-slate-700/30",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:Je=>{Je.stopPropagation();const yt=new Set(M);Ae?yt.delete(me.id):yt.add(me.id),Z(yt)},className:"flex items-center space-x-1.5 text-purple-300 hover:text-purple-100 text-xs cursor-pointer",children:[e.jsx("span",{children:Ae?"📖":"📄"}),e.jsxs("span",{children:[me.metadata.type," ",me.metadata.number]}),e.jsx("span",{className:"text-slate-400",children:Ae?"▼":"▶"})]}),Te&&e.jsx(qt,{onClick:()=>se(Te.id)})]}),Ae&&e.jsxs("div",{className:"px-3 pb-3 border-t border-slate-500",children:[e.jsx("div",{className:"text-xs text-slate-300 mt-2 leading-relaxed",children:me.text}),e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Page ",me.page," • ",me.metadata.scope]})]})]},me.id)})})})]},k.id)})})]}),Se.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Note for:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:Se.map(k=>{const X=ue.get(k.from);return X?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:Ne(X.id,X.text)}),e.jsx(qt,{onClick:()=>se(k.id)})]},k.id):null})})]}),Ve.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Descriptions:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:Ve.map(k=>{const X=L.find(Le=>Le.id===k.to),ke=M.has(X==null?void 0:X.id);return X?e.jsxs("div",{className:"border border-slate-600 rounded-md bg-slate-700/30",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:Le=>{Le.stopPropagation(),je.current=!0;const me=new Set(M);ke?me.delete(X.id):me.add(X.id),Z(me),setTimeout(()=>{je.current=!1},50)},className:"flex items-center space-x-1.5 text-purple-300 hover:text-purple-100 text-xs cursor-pointer bg-transparent border-none",children:[e.jsx("span",{children:ke?"📖":"📄"}),e.jsxs("span",{children:[X.metadata.type," ",X.metadata.number]}),e.jsx("span",{className:"text-slate-400",children:ke?"▼":"▶"})]}),e.jsx(qt,{onClick:()=>se(k.id)})]}),ke&&e.jsxs("div",{className:"px-3 pb-3 border-t border-slate-600",children:[e.jsx("div",{className:"text-xs text-slate-300 mt-2 leading-relaxed",children:X.text}),e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Page ",X.page," • ",X.metadata.scope]})]})]},k.id):null})})]}),ve.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Described by:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:ve.map(k=>{const X=ue.get(k.from);return X?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:Ne(X.id,X.text)}),e.jsx(qt,{onClick:()=>se(k.id)})]},k.id):null})})]}),Xe.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Equipment Short Specs:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:Xe.map(k=>{const X=v.find(Le=>Le.id===k.to),ke=xe.has(X==null?void 0:X.id);return X?e.jsxs("div",{className:"border border-slate-600 rounded-md bg-slate-700/30",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:Le=>{Le.stopPropagation(),je.current=!0;const me=new Set(xe);ke?me.delete(X.id):me.add(X.id),p(me),setTimeout(()=>{je.current=!1},50)},className:"flex items-center space-x-2 text-left flex-grow text-orange-300 hover:text-orange-200",children:[e.jsx("span",{className:`transition-transform duration-200 ${ke?"rotate-90":""}`,children:"▶"}),e.jsx("span",{className:"font-medium text-xs",children:X.metadata.originalEquipmentTag.text})]}),e.jsx(qt,{onClick:()=>se(k.id)})]}),ke&&e.jsxs("div",{className:"p-2 pt-0 border-t border-slate-600",children:[e.jsxs("div",{className:"text-xs text-slate-400 mb-2",children:["Page ",X.page," • ",X.sourceItems.length," source items"]}),e.jsxs("div",{className:"space-y-2",children:[X.metadata.service&&e.jsxs("div",{className:"p-2 bg-slate-600/30 rounded border-l-4 border-blue-500",children:[e.jsx("div",{className:"text-xs text-blue-300 font-semibold mb-1",children:"Service"}),e.jsx("div",{className:"text-sm text-slate-300",children:X.metadata.service})]}),e.jsxs("div",{className:"p-2 bg-slate-800/50 rounded",children:[e.jsx("div",{className:"text-xs text-orange-300 font-semibold mb-1",children:"Short Spec"}),e.jsx("div",{className:"text-sm text-slate-300 whitespace-pre-wrap",children:X.text})]})]})]})]},k.id):null})})]})]})]})}),un=({tags:o,setTags:c,rawTextItems:A,descriptions:C,equipmentShortSpecs:j,setEquipmentShortSpecs:N,loops:U,setLoops:L,relationships:v,setRelationships:Y,currentPage:H,setCurrentPage:se,selectedTagIds:Q,setSelectedTagIds:O,selectedDescriptionIds:_,setSelectedDescriptionIds:ie,selectedEquipmentShortSpecIds:fe,setSelectedEquipmentShortSpecIds:ne,tagSelectionSource:ye,onDeleteTags:K,onUpdateTagText:te,onDeleteDescriptions:z,onUpdateDescription:T,onDeleteEquipmentShortSpecs:F,onUpdateEquipmentShortSpec:R,onDeleteRawTextItems:M,onUpdateRawTextItemText:Z,onAutoLinkDescriptions:xe,onAutoLinkNotesAndHolds:p,onAutoLinkEquipmentShortSpecs:le,onAutoGenerateLoops:oe,onManualCreateLoop:ge,onDeleteLoops:We,onUpdateLoop:Be,showConfirmation:je,onPingTag:D,onPingDescription:he,onPingEquipmentShortSpec:ue,onPingRelationship:we,visibilitySettings:y,updateVisibilitySettings:ae,toggleTagVisibility:be,toggleRelationshipVisibility:Ne,toggleAllTags:Ze,toggleAllRelationships:Ie,comments:De,onCreateComment:Ue,onUpdateComment:Oe,onDeleteComment:Ge,getCommentsForTarget:_e})=>{const[Se,Ve]=t.useState(!0),[ve,Xe]=t.useState(!0),[Ee,k]=t.useState(""),[X,ke]=t.useState(""),[Le,me]=t.useState("tags"),[Te,Ae]=t.useState(null),[Je,yt]=t.useState(""),[Ye,ct]=t.useState("All"),[tt,it]=t.useState("All"),[dt,rt]=t.useState("All"),[jt,St]=t.useState("default"),[Pt,ft]=t.useState(!1),[st,xt]=t.useState(null),[Zt,vt]=t.useState(""),[Ot,Yt]=t.useState(null),[gt,wt]=t.useState("all"),[Ht,Kt]=t.useState(()=>{const n=localStorage.getItem("sidebarWidth");return n?parseInt(n):320}),[Bt,Me]=t.useState(!1);t.useEffect(()=>{jt==="instrument-number-function"&&Ye!==a.Instrument&&St("default")},[Ye,jt]);const[Ut,At]=t.useState(null),[_t,Mt]=t.useState(null),[Tt,bt]=t.useState(""),[Nt,Ce]=t.useState({}),[at,ht]=t.useState(""),[pt,Et]=t.useState({}),[Gt,Lt]=t.useState({viewOptions:!0}),[Qe,Ft]=t.useState({start:0,end:100}),zt=t.useRef(null),lt=t.useRef(null),kt=t.useRef(-1),es=t.useCallback(n=>{Lt(V=>({...V,[n]:!V[n]}))},[]),Vt=t.useCallback(n=>{Y(V=>V.filter(B=>B.id!==n))},[Y]),u=t.useCallback(n=>{K([n])},[K]),d=t.useCallback(n=>{M([n])},[M]),x=t.useCallback(n=>{c(V=>V.map(B=>B.id===n?{...B,isReviewed:!B.isReviewed}:B))},[c]),h=t.useCallback(n=>{const V=U.find(B=>B.id===n);V&&(Ae(n),yt(V.name||V.id))},[U]),m=t.useCallback(()=>{Te&&Je.trim()&&(Be(Te,{id:Je.trim(),name:Je.trim()}),Ae(null),yt(""))},[Te,Je,Be]),f=t.useCallback(()=>{Ae(null),yt("")},[]),w=t.useCallback((n,V,B)=>{xt(n),vt(V),Yt(B),ft(!0)},[]),W=t.useCallback(()=>{ft(!1),xt(null),vt(""),Yt(null)},[]),$=t.useCallback((n,V)=>{st&&Ot&&Ue(st,Ot,n,V)},[st,Ot,Ue]),s=t.useCallback((n,V)=>{switch(V){case"tag":const B=o.find(He=>He.id===n);return B?B.text:"Unknown Tag";case"description":const ee=C.find(He=>He.id===n);return ee?`${ee.metadata.type} ${ee.metadata.number}`:"Unknown Description";case"equipmentSpec":const P=j.find(He=>He.id===n);return P?P.equipmentTag:"Unknown Equipment Spec";case"relationship":const re=v.find(He=>He.id===n);if(!re)return"Unknown Relationship";const de=o.find(He=>He.id===re.from),Pe=o.find(He=>He.id===re.to);return`From ${(de==null?void 0:de.text)||"Unknown"} To ${(Pe==null?void 0:Pe.text)||"Unknown"}`;default:return"Unknown"}},[o,C,j,v]),l=t.useCallback(n=>{switch(n){case"tag":return"Tags";case"description":return"Notes";case"equipmentSpec":return"Equipment Specs";case"relationship":return"Relations";case"loop":return"Loops";default:return n}},[]),g=t.useCallback((n,V)=>{switch(V){case"tag":const B=o.find(ze=>ze.id===n);return B?{name:B.text,metadata:`Category: ${B.category}, Page: ${B.page}`}:{name:"Unknown Tag",metadata:""};case"description":const ee=C.find(ze=>ze.id===n);return ee?{name:`${ee.metadata.type} ${ee.metadata.number}`,metadata:`Scope: ${ee.metadata.scope}, Page: ${ee.page}`}:{name:"Unknown Description",metadata:""};case"equipmentSpec":const P=j.find(ze=>ze.id===n);return P?{name:P.metadata.originalEquipmentTag.text,metadata:`Service: ${P.metadata.service||"N/A"}, Page: ${P.page}`}:{name:"Unknown Equipment Spec",metadata:""};case"loop":const re=U.find(ze=>ze.id===n);if(!re)return{name:"Unknown Loop",metadata:""};const de=re.tagIds.map(ze=>o.find(ts=>ts.id===ze)).filter(Boolean);return{name:re.name||re.id,metadata:`Tags: ${de.length}, Pages: ${de.map(ze=>ze.page).filter((ze,ts,ce)=>ce.indexOf(ze)===ts).sort((ze,ts)=>ze-ts).join(", ")}`};case"relationship":const Pe=v.find(ze=>ze.id===n);if(!Pe)return{name:"Unknown Relationship",metadata:""};const He=o.find(ze=>ze.id===Pe.from),Ke=o.find(ze=>ze.id===Pe.to);return{name:`From ${(He==null?void 0:He.text)||"Unknown"} To ${(Ke==null?void 0:Ke.text)||"Unknown"}`,metadata:`Type: ${Pe.type}`};default:return{name:"Unknown",metadata:""}}},[o,C,j,U,v]),r=t.useCallback(n=>{Me(!0),n.preventDefault()},[]),b=t.useCallback(n=>{if(!Bt)return;const V=n.clientX;V>=280&&V<=600&&(Kt(V),localStorage.setItem("sidebarWidth",V.toString()))},[Bt]),S=t.useCallback(()=>{Me(!1)},[]);t.useEffect(()=>(Bt&&(document.addEventListener("mousemove",b),document.addEventListener("mouseup",S),document.body.style.cursor="col-resize",document.body.style.userSelect="none"),()=>{document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",S),document.body.style.cursor="",document.body.style.userSelect=""}),[Bt,b,S]);const I=t.useMemo(()=>{let n=[...De];switch(gt){case"unresolved":n=n.filter(V=>!V.isResolved);break;case"resolved":n=n.filter(V=>V.isResolved);break;case"high":n=n.filter(V=>V.priority==="high");break;case"medium":n=n.filter(V=>V.priority==="medium");break;case"low":n=n.filter(V=>V.priority==="low");break}return n.sort((V,B)=>{const ee={high:3,medium:2,low:1};return ee[V.priority]!==ee[B.priority]?ee[B.priority]-ee[V.priority]:B.timestamp-V.timestamp}),n},[De,gt]),i=t.useMemo(()=>{const V=o.filter(B=>B.category!==a.OffPageConnector).filter(B=>!Se||B.page===H).filter(B=>Ye==="All"||B.category===Ye).filter(B=>tt==="All"?!0:tt==="Reviewed"?B.isReviewed===!0:tt==="NotReviewed"?B.isReviewed!==!0:!0).filter(B=>{if(dt==="All")return!0;const ee=De.filter(P=>P.targetId===B.id);return dt==="WithComments"?ee.length>0:dt==="WithoutComments"?ee.length===0:!0}).filter(B=>B.text.toLowerCase().includes(Ee.toLowerCase()));switch(jt){case"length-asc":return[...V].sort((B,ee)=>B.text.length-ee.text.length);case"length-desc":return[...V].sort((B,ee)=>ee.text.length-B.text.length);case"pos-top-bottom":return[...V].sort((B,ee)=>{if(B.page!==ee.page)return B.page-ee.page;const P=ee.bbox.y2-B.bbox.y2;return Math.abs(P)<1?B.bbox.x1-ee.bbox.x1:P});case"pos-left-right":return[...V].sort((B,ee)=>{if(B.page!==ee.page)return B.page-ee.page;const P=B.bbox.x1-ee.bbox.x1;return Math.abs(P)<1?ee.bbox.y2-B.bbox.y2:P});case"instrument-number-function":return[...V].sort((B,ee)=>{if(B.page!==ee.page)return B.page-ee.page;const P=Pe=>{const He=Pe.trim(),Ke=He.match(/^([A-Z]{2,4})-?(\d+)[\s]*([A-Z]*)$/);if(Ke)return{function:Ke[1].trim(),number:parseInt(Ke[2]),suffix:Ke[3].trim()};const ze=He.match(/^([A-Z]{2,4})(\d+)([A-Z]*)$/);return ze?{function:ze[1].trim(),number:parseInt(ze[2]),suffix:ze[3].trim()}:{function:Pe,number:99999,suffix:""}},re=P(B.text),de=P(ee.text);return re.number!==de.number?re.number-de.number:re.function!==de.function?re.function.localeCompare(de.function):re.suffix.localeCompare(de.suffix)});case"default":default:return[...V].sort((B,ee)=>B.page!==ee.page?B.page-ee.page:B.text.localeCompare(ee.text))}},[o,Se,H,Ye,tt,dt,Ee,jt,De]),E=t.useMemo(()=>{if(i.length<=100)return i;if(Q.length===1){const B=i.findIndex(ee=>ee.id===Q[0]);if(B!==-1){const P=Math.max(0,B-30),re=Math.min(i.length,B+60);(B<Qe.start||B>=Qe.end)&&Ft({start:P,end:re})}}const n=Math.max(0,Math.min(Qe.start,i.length)),V=Math.max(n,Math.min(Qe.end,i.length));return i.slice(n,V)},[i,Qe,Q]),q=t.useMemo(()=>C.filter(n=>!Se||n.page===H),[C,Se,H]);t.useEffect(()=>{Wt.current&&(clearTimeout(Wt.current),Wt.current=null),ns.current=!1,vs.current=0,Ft({start:0,end:100})},[Se,Ye,Ee]),t.useEffect(()=>()=>{Wt.current&&clearTimeout(Wt.current)},[]);const pe=t.useMemo(()=>j.filter(n=>!Se||n.page===H),[j,Se,H]),Re=t.useMemo(()=>U.filter(n=>!Se||n.tagIds.some(V=>{const B=o.find(ee=>ee.id===V);return B&&B.page===H})),[U,Se,H,o]),qe=t.useMemo(()=>Se?v.filter(n=>{const V=o.find(Ke=>Ke.id===n.from),B=o.find(Ke=>Ke.id===n.to),ee=C.find(Ke=>Ke.id===n.from),P=C.find(Ke=>Ke.id===n.to),re=A.find(Ke=>Ke.id===n.from),de=A.find(Ke=>Ke.id===n.to),Pe=(V==null?void 0:V.page)||(ee==null?void 0:ee.page)||(re==null?void 0:re.page),He=(B==null?void 0:B.page)||(P==null?void 0:P.page)||(de==null?void 0:de.page);return!Se||Pe===H||He===H}):v,[v,Se,H,o,C,A]);t.useEffect(()=>{if(ye==="pdf"&&Q.length===1&&Le==="tags"&&zt.current){const n=Q[0];setTimeout(()=>{const V=zt.current.querySelector(`[data-tag-id='${n}']`);V&&V.scrollIntoView({behavior:"smooth",block:"center"})},100)}},[Q,ye,Le,i]),t.useEffect(()=>{if(Le==="descriptions"&&_.length===1&&lt.current){const n=_[0],V=lt.current.querySelector(`[data-description-id='${n}']`);V&&V.scrollIntoView({behavior:"smooth",block:"center"})}},[_,Le,q]);const G=t.useCallback((n,V,B)=>{const ee=B.ctrlKey||B.metaKey;if(B.shiftKey&&kt.current!==-1){const re=Math.min(kt.current,V),de=Math.max(kt.current,V),Pe=i.slice(re,de+1).map(He=>He.id);O(ee?He=>Array.from(new Set([...He,...Pe])):Pe)}else ee?(O(re=>re.includes(n.id)?re.filter(de=>de!==n.id):[...re,n.id]),kt.current=V):(se(n.page),O([n.id]),kt.current=V,D(n.id))},[i,Q,O,se,D]),$e=t.useCallback(n=>{Le!=="tags"&&me("tags");const V=!Se||n.page===H,B=Ye==="All"||n.category===Ye,ee=n.text.toLowerCase().includes(Ee.toLowerCase());V||Ve(!1),B||ct("All"),!ee&&Ee&&k(""),se(n.page),O([n.id]),D(n.id),setTimeout(()=>{if(zt.current){const P=zt.current.querySelector(`[data-tag-id='${n.id}']`);P&&P.scrollIntoView({behavior:"smooth",block:"center"})}},100)},[se,O,Le,me,o,Se,H,Ye,Ee,Ve,ct,k,D]),nt=t.useCallback(()=>{Q.length>0&&(K(Q),O([]),kt.current=-1)},[Q,K,O]),Rt=t.useCallback(()=>{an(o,v,A,C,j,U,De)},[o,v,A,C,j,U,De]),ms=t.useCallback(n=>{ie([n.id]),n.page!==H&&se(n.page),he(n.id)},[H,se,ie,he]),js=t.useCallback(n=>{fe.includes(n.id)?ne(V=>V.filter(B=>B!==n.id)):(ne([n.id]),n.page!==H&&se(n.page),ue(n.id))},[fe,H,se,ne,ue]),Wt=t.useRef(null),vs=t.useRef(0),ns=t.useRef(!1),Jt=t.useCallback(n=>{Q.length>1||i.length<=100||(Wt.current&&clearTimeout(Wt.current),Wt.current=setTimeout(()=>{const{scrollTop:V,clientHeight:B}=n.target,ee=90,P=30,re=Math.floor(V/ee),de=Math.ceil(B/ee),Pe=Math.max(0,re-P),He=Math.min(i.length,re+de+P);Ft({start:Pe,end:He}),Wt.current=null},50))},[i.length,Q.length]),ws=t.useCallback(({relationships:n})=>{const[V,B]=t.useState(""),[ee,P]=t.useState("All"),re=t.useMemo(()=>({tags:new Map(o.map(ce=>[ce.id,ce])),descriptions:new Map(C.map(ce=>[ce.id,ce])),rawTextItems:new Map(A.map(ce=>[ce.id,ce])),equipmentShortSpecs:new Map(j.map(ce=>[ce.id,ce]))}),[o,C,A,j]),de=t.useCallback(ce=>re.tags.get(ce)||re.descriptions.get(ce)||re.rawTextItems.get(ce)||re.equipmentShortSpecs.get(ce),[re]),Pe=t.useCallback(ce=>ce?ce.text?ce.text:ce.equipmentTag?ce.equipmentTag:"Unknown":"Unknown",[]),He=t.useMemo(()=>ee==="All"?n:n.filter(ce=>ce.type===ee),[n,ee]),Ke=t.useMemo(()=>{if(!V)return He;const ce=V.toLowerCase();return He.filter(Ct=>{const $t=de(Ct.from),Qt=de(Ct.to),ks=Pe($t).toLowerCase(),Ls=Pe(Qt).toLowerCase();return ks.includes(ce)||Ls.includes(ce)})},[V,He,de,Pe]),ze=t.useMemo(()=>{const ce={};return Object.values(J).forEach(Ct=>{ce[Ct]=n.filter($t=>$t.type===Ct).length}),ce.All=n.length,ce},[n]),ts=t.useCallback(ce=>{const Ct=de(ce.from),$t=de(ce.to);if(Ct&&$t){const Qt=Ct.page||$t.page;Qt&&Qt!==H&&se(Qt),we(ce.id),re.tags.has(ce.from)&&D(ce.from),re.tags.has(ce.to)&&D(ce.to),re.descriptions.has(ce.from)&&he(ce.from),re.descriptions.has(ce.to)&&he(ce.to),re.equipmentShortSpecs.has(ce.from)&&ue(ce.from),re.equipmentShortSpecs.has(ce.to)&&ue(ce.to)}},[de,H,se,re,D,he,ue,we]);return e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-2 border-b border-slate-700 flex-shrink-0 space-y-2",children:[e.jsx("input",{type:"text",placeholder:"Search relationships...",value:V,onChange:ce=>B(ce.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md px-2 py-1.5 text-sm focus:ring-sky-500 focus:border-sky-500"}),e.jsx("div",{className:"flex flex-wrap gap-1 text-xs",children:["All",...Object.values(J)].map(ce=>e.jsxs("button",{onClick:()=>P(ce),className:`px-2 py-1 rounded font-medium ${ee===ce?"bg-sky-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"}`,children:[ce," (",ze[ce]||0,")"]},ce))})]}),e.jsxs("ul",{className:"flex-grow overflow-y-auto p-2 space-y-2",children:[Ke.length===0&&e.jsx("li",{className:"text-center text-slate-400 py-4",children:"No relationships found."}),Ke.map(ce=>{const Ct=de(ce.from),$t=de(ce.to);if(!Ct||!$t)return null;const Qt=Dt=>{const Cs=Pe(Dt),Ss=()=>{re.tags.has(Dt.id)?$e(Dt):re.descriptions.has(Dt.id)?(he(Dt.id),se(Dt.page)):re.equipmentShortSpecs.has(Dt.id)&&(ue(Dt.id),se(Dt.page))};return e.jsx("span",{onClick:Ss,className:"font-mono text-sky-400 hover:underline cursor-pointer",children:Cs})},ks=Dt=>{switch(Dt){case J.Connection:return{icon:"⟶",title:"Connection"};case J.Installation:return{icon:"📌",title:"Installation"};case J.Annotation:return{icon:"📝",title:"Annotation"};case J.Note:return{icon:"🏷️",title:"Note"};case J.Description:return{icon:"📄",title:"Description"};case J.EquipmentShortSpec:return{icon:"⚙️",title:"Equipment Spec"};default:return{icon:"🔗",title:"Unknown"}}},{icon:Ls,title:zs}=ks(ce.type);return e.jsxs("li",{className:"p-2 bg-slate-700/30 rounded-md text-sm text-slate-300 flex items-center justify-between hover:bg-slate-700/50 cursor-pointer transition-colors",onClick:()=>ts(ce),title:`Click to highlight in PDF: ${zs}`,children:[e.jsxs("div",{className:"flex items-center space-x-2 flex-grow",children:[e.jsx("span",{className:"text-xs text-slate-500 font-medium",children:ce.type}),e.jsx("span",{className:"text-slate-300 text-xs",children:"From"}),Qt(Ct),e.jsx("span",{className:"text-slate-300 text-xs",children:"To"}),Qt($t),e.jsx(rs,{comments:_e(ce.id),onClick:Dt=>{Dt.stopPropagation();const Cs=(Ct==null?void 0:Ct.text)||"Unknown",Ss=($t==null?void 0:$t.text)||"Unknown";w(ce.id,`From ${Cs} To ${Ss}`,"relationship")},size:"sm",className:"ml-2"})]}),e.jsx(qt,{onClick:()=>{Vt(ce.id)}})]},ce.id)})]})]})},[o,C,A,j,H,se,D,he,ue,we,$e,Vt]),Ns=["All",a.Equipment,a.Line,a.SpecialItem,a.Instrument,a.NotesAndHolds,a.DrawingNumber],Fs=t.useMemo(()=>o.filter(n=>n.category!==a.OffPageConnector).filter(n=>!Se||n.page===H).length,[o,Se,H]);return e.jsxs("aside",{className:"h-full bg-slate-800 border-r border-slate-700 flex flex-col flex-shrink-0 relative",style:{width:`${Ht}px`},children:[e.jsxs("div",{className:"border-b border-slate-700 flex text-xs",children:[e.jsxs("button",{onClick:()=>me("tags"),className:`flex-1 py-2 px-1 font-semibold ${Le==="tags"?"bg-slate-700/50 text-sky-400":"text-slate-300"}`,children:["Tags (",Fs,")"]}),e.jsxs("button",{onClick:()=>me("descriptions"),className:`flex-1 py-2 px-1 font-semibold ${Le==="descriptions"?"bg-slate-700/50 text-sky-400":"text-slate-300"}`,children:["Notes (",q.length,")"]}),e.jsxs("button",{onClick:()=>me("equipmentShortSpecs"),className:`flex-1 py-2 px-1 font-semibold ${Le==="equipmentShortSpecs"?"bg-slate-700/50 text-sky-400":"text-slate-300"}`,children:["Equipment Specs (",pe.length,")"]}),e.jsxs("button",{onClick:()=>me("loops"),className:`flex-1 py-2 px-1 font-semibold ${Le==="loops"?"bg-slate-700/50 text-sky-400":"text-slate-300"}`,children:["Loops (",Re.length,")"]}),e.jsxs("button",{onClick:()=>me("relationships"),className:`flex-1 py-2 px-1 font-semibold ${Le==="relationships"?"bg-slate-700/50 text-sky-400":"text-slate-300"}`,children:["Relations (",qe.length,")"]}),e.jsxs("button",{onClick:()=>me("comments"),className:`flex-1 py-2 px-1 font-semibold ${Le==="comments"?"bg-slate-700/50 text-sky-400":"text-slate-300"}`,children:["💬 (",De.length,")"]})]}),Le==="tags"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-3 space-y-2 border-b border-slate-700 flex-shrink-0",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search tags...",value:Ee,onChange:n=>k(n.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md px-2 py-1.5 pr-8 text-sm focus:ring-sky-500 focus:border-sky-500"}),Ee&&e.jsx("button",{onClick:()=>k(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white transition-colors p-0.5 rounded",title:"Clear search",children:e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("hr",{className:"border-slate-700"}),e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>es("viewOptions"),className:"w-full flex justify-between items-center text-left py-1",children:[e.jsx("h4",{className:"text-sm font-semibold text-slate-400",children:"View Options"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-4 w-4 text-slate-400 transition-transform ${Gt.viewOptions?"rotate-180":""}`,viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z",clipRule:"evenodd"})})]}),Gt.viewOptions&&e.jsxs("div",{className:"space-y-1.5 mt-1.5 animate-fade-in-up",style:{animationDuration:"0.2s"},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer text-sm text-slate-300",children:[e.jsx("input",{type:"checkbox",checked:Se,onChange:n=>Ve(n.target.checked),className:"rounded bg-slate-700 border-slate-500 text-sky-500 focus:ring-sky-600"}),e.jsx("span",{children:"Show page only"})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer text-sm text-slate-300",children:[e.jsx("input",{type:"checkbox",checked:ve,onChange:n=>Xe(n.target.checked),className:"rounded bg-slate-700 border-slate-500 text-sky-500 focus:ring-sky-600"}),e.jsx("span",{children:"Show list details"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("label",{htmlFor:"sort-order",className:"text-sm text-slate-400",children:"Sort:"}),e.jsxs("select",{id:"sort-order",value:jt,onChange:n=>St(n.target.value),className:"flex-1 bg-slate-700 border-slate-600 rounded-md px-2 py-1 text-sm focus:ring-sky-500 focus:border-sky-500",children:[e.jsx("option",{value:"default",children:"Default (A-Z)"}),e.jsx("option",{value:"pos-top-bottom",children:"Position (Top → Bottom)"}),e.jsx("option",{value:"pos-left-right",children:"Position (Left → Right)"}),e.jsx("option",{value:"length-asc",children:"Length (Short → Long)"}),e.jsx("option",{value:"length-desc",children:"Length (Long → Short)"}),Ye===a.Instrument&&e.jsx("option",{value:"instrument-number-function",children:"Instrument (Number → Function)"})]})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-semibold text-slate-400 mb-1.5",children:"Review & Comments"}),e.jsx("div",{className:"flex text-xs border border-slate-600 rounded",children:[{key:"All",display:"All",tooltip:"Show all tags"},{key:"Reviewed",display:"✅",tooltip:"Show reviewed tags only"},{key:"NotReviewed",display:"☐",tooltip:"Show unreviewed tags only"},{key:"WithComments",display:"💬+",tooltip:"Show tags with comments only"},{key:"WithoutComments",display:"💬-",tooltip:"Show tags without comments only"}].map((n,V)=>{const B=o.filter(de=>de.category!==a.OffPageConnector).filter(de=>!Se||de.page===H).filter(de=>Ye==="All"||de.category===Ye);let ee=0,P=!1;n.key==="All"?(ee=B.length,P=tt==="All"&&dt==="All"):n.key==="Reviewed"?(ee=B.filter(de=>de.isReviewed===!0).length,P=tt==="Reviewed"):n.key==="NotReviewed"?(ee=B.filter(de=>de.isReviewed!==!0).length,P=tt==="NotReviewed"):n.key==="WithComments"?(ee=B.filter(Pe=>tt==="All"?!0:tt==="Reviewed"?Pe.isReviewed===!0:tt==="NotReviewed"?Pe.isReviewed!==!0:!0).filter(Pe=>De.some(He=>He.targetId===Pe.id)).length,P=dt==="WithComments"):n.key==="WithoutComments"&&(ee=B.filter(Pe=>tt==="All"?!0:tt==="Reviewed"?Pe.isReviewed===!0:tt==="NotReviewed"?Pe.isReviewed!==!0:!0).filter(Pe=>!De.some(He=>He.targetId===Pe.id)).length,P=dt==="WithoutComments");const re=()=>{n.key==="All"?(it("All"),rt("All")):n.key==="Reviewed"||n.key==="NotReviewed"?it(n.key):rt(n.key)};return e.jsxs("button",{onClick:re,className:`group relative flex-1 py-1.5 px-1 font-semibold text-center ${V>0?"border-l border-slate-600":""} ${P?"bg-slate-700/50 text-sky-400":"text-slate-300 hover:bg-slate-700/30"}`,children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-xs leading-tight",children:n.display}),e.jsxs("span",{className:"text-xs text-slate-400 leading-tight",children:["(",ee,")"]})]}),e.jsxs("div",{className:"absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50 border border-slate-600",children:[n.tooltip,e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-900"})]})]},n.key)})})]})]})]}),e.jsx("hr",{className:"border-slate-700"}),e.jsx("div",{className:"border-b border-slate-700 flex text-xs",children:Ns.map((n,V)=>{const B=o.filter(de=>de.category!==a.OffPageConnector).filter(de=>!Se||de.page===H),ee=n==="All"?B.length:B.filter(de=>de.category===n).length,P=Ye===n,re=n==="Equipment"?"Equip":n==="Instrument"?"Instr":n==="DrawingNumber"?"PID NO":n==="NotesAndHolds"?"Notes":n==="SpecialItem"?"Special":n;return e.jsx("button",{onClick:()=>ct(n),className:`flex-1 py-1.5 px-1 font-semibold text-center border-r border-slate-600 last:border-r-0 ${P?"bg-slate-700/50 text-sky-400":"text-slate-300"}`,disabled:ee===0&&n!=="All",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-xs leading-tight",children:re}),e.jsxs("span",{className:"text-xs text-slate-400 leading-tight",children:["(",ee,")"]})]})},n)})})]}),Q.length>1&&e.jsx("div",{className:"p-2 flex-shrink-0",children:e.jsxs("button",{onClick:nt,className:"w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-1.5 px-2 rounded-md transition-colors text-sm",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),e.jsxs("span",{children:["Delete Selected (",Q.length,")"]})]})}),e.jsxs("ul",{ref:zt,className:"flex-grow overflow-y-auto p-2 divide-y divide-slate-700/80",onScroll:Jt,children:[i.length>100&&e.jsx("div",{style:{height:`${Qe.start*90}px`}}),E.map((n,V)=>{const B=i.length>100?Qe.start+V:V;return e.jsx(mn,{tag:n,isSelected:Q.includes(n.id),onItemClick:ee=>G(n,B,ee),onGoToTag:$e,relationships:v,allTags:o,allRawTextItems:A,descriptions:C,equipmentShortSpecs:j,onToggleReviewStatus:x,onDeleteRelationship:Vt,onDeleteTag:u,onUpdateTagText:te,onDeleteItem:d,onUpdateItemText:Z,loops:U,onUpdateLoop:Be,showDetails:ve,comments:De,onOpenComments:w,getCommentsForTarget:_e},n.id)}),i.length>100&&e.jsx("div",{style:{height:`${Math.max(0,(i.length-Qe.end)*90)}px`}})]})]}),Le==="descriptions"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-3 border-b border-slate-700",children:e.jsx("div",{className:"text-xs text-slate-400 mb-2",children:"Press 'N' to create descriptions from selected items"})}),e.jsx("div",{ref:lt,className:"flex-grow overflow-y-auto p-3 space-y-2",children:q.length===0?e.jsxs("div",{className:"text-center text-slate-500 mt-8",children:[e.jsx("div",{className:"text-lg mb-2",children:"📝"}),e.jsx("div",{className:"text-sm",children:Se&&C.length>0?`No descriptions on page ${H}`:"No descriptions yet"}),e.jsx("div",{className:"text-xs mt-1",children:"Select items and press 'N' to create"})]}):q.map(n=>{const V=_.includes(n.id),B=Ut===n.id,ee=v.filter(P=>P.to===n.id&&P.type===J.Description).map(P=>o.find(re=>re.id===P.from)).filter(Boolean);return e.jsxs("div",{"data-description-id":n.id,className:`group border rounded-lg p-3 hover:bg-slate-700/50 transition-colors ${V?"bg-purple-600/30 border-purple-400":"bg-slate-700/30 border-slate-600"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-slate-400",children:[n.metadata.type," ",n.metadata.number," - ",n.metadata.scope]}),e.jsx(rs,{comments:_e(n.id),onClick:()=>w(n.id,`${n.metadata.type} ${n.metadata.number}`,"description"),size:"sm"})]}),ee.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:ee.map(P=>e.jsxs("span",{onClick:re=>{re.stopPropagation(),D(P.id)},className:"inline-flex items-center space-x-1 px-2 py-0.5 bg-sky-600/30 text-sky-300 rounded text-xs border border-sky-600/50 hover:bg-sky-500/40 hover:text-sky-200 cursor-pointer transition-colors",title:`Click to focus on note tag: ${P.text}`,children:[e.jsx("span",{children:"📝"}),e.jsx("span",{className:"font-mono",children:P.text})]},P.id))})]}),e.jsxs("div",{className:"flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(fs,{onClick:()=>{B||(At(n.id),ht(n.text),Et(n.metadata))},title:"Edit description"}),e.jsx(ys,{onClick:()=>z([n.id])})]})]}),B?e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:at,onChange:P=>ht(P.target.value),className:"w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white resize-none",rows:3,placeholder:"Enter description text...",autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs",children:[e.jsxs("select",{value:pt.type,onChange:P=>Et({...pt,type:P.target.value}),className:"bg-slate-800 border border-slate-600 rounded px-2 py-1 text-white",children:[e.jsx("option",{value:"Note",children:"Note"}),e.jsx("option",{value:"Hold",children:"Hold"})]}),e.jsxs("select",{value:pt.scope,onChange:P=>Et({...pt,scope:P.target.value}),className:"bg-slate-800 border border-slate-600 rounded px-2 py-1 text-white",children:[e.jsx("option",{value:"General",children:"General"}),e.jsx("option",{value:"Specific",children:"Specific"})]}),e.jsx("input",{type:"number",min:"1",value:pt.number,onChange:P=>Et({...pt,number:parseInt(P.target.value)||1}),className:"bg-slate-800 border border-slate-600 rounded px-2 py-1 text-white"})]}),e.jsxs("div",{className:"text-xs text-slate-500",children:["Page ",n.page," • ",n.sourceItems.length," source items"]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(bs,{onClick:()=>{At(null),ht(""),Et({})}}),e.jsx(gs,{onClick:()=>{T(n.id,at,pt),At(null),ht(""),Et({})}})]})]}):e.jsxs("div",{className:"cursor-pointer",onClick:()=>ms(n),children:[e.jsx("div",{className:"text-xs text-slate-200 leading-relaxed mb-2",children:n.text}),e.jsxs("div",{className:"text-xs text-slate-500",children:["Page ",n.page," • ",n.sourceItems.length," source items"]})]})]},n.id)})})]}),Le==="equipmentShortSpecs"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-3 border-b border-slate-700",children:e.jsx("div",{className:"text-xs text-slate-400 mb-2",children:"Press 'P' to create Equipment Short Specs from selected Equipment tag and text items"})}),e.jsx("div",{className:"flex-grow overflow-y-auto p-3 space-y-2",children:pe.length===0?e.jsxs("div",{className:"text-center text-slate-500 mt-8",children:[e.jsx("div",{className:"text-lg mb-2",children:"⚙️"}),e.jsx("div",{className:"text-sm",children:Se&&j.length>0?`No Equipment Short Specs on page ${H}`:"No Equipment Short Specs yet"}),e.jsx("div",{className:"text-xs mt-1",children:"Select Equipment tag and text items, then press 'P' to create"})]}):pe.map(n=>{var ee;const V=fe.includes(n.id),B=_t===n.id;return e.jsxs("div",{className:`group border rounded-lg p-3 hover:bg-slate-700/50 transition-colors ${V?"bg-orange-600/30 border-orange-400":"bg-slate-700/30 border-slate-600"}`,onClick:()=>js(n),children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("div",{className:"flex-grow",children:e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`inline-block px-2 py-1 rounded text-xs font-semibold ${xs.Equipment.bg} ${xs.Equipment.text}`,children:n.metadata.originalEquipmentTag.text}),e.jsxs("span",{className:"text-xs text-slate-400",children:["Page ",n.page]}),e.jsx(rs,{comments:_e(n.id),onClick:()=>w(n.id,n.equipmentTag||n.metadata.originalEquipmentTag.text,"equipmentSpec"),size:"sm"}),(()=>{const P=v.filter(de=>de.type===J.EquipmentShortSpec&&de.to===n.id).map(de=>de.from),re=o.filter(de=>P.includes(de.id));return re.length>0?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-xs text-slate-500",children:"🔗"}),e.jsx("div",{className:"flex gap-1 flex-wrap",children:re.map(de=>e.jsx("span",{onClick:Pe=>{Pe.stopPropagation(),D(de.id)},className:"inline-block px-1.5 py-0.5 bg-green-600/30 text-green-300 rounded text-xs border border-green-600/50 hover:bg-green-500/40 hover:text-green-200 cursor-pointer transition-colors",title:`Click to focus on equipment tag: ${de.text}`,children:de.text},de.id))})]}):e.jsx("span",{className:"text-xs text-slate-500",title:"No Equipment tags connected",children:"⚠️ Unlinked"})})()]})}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(fs,{onClick:()=>{B||(Mt(n.id),bt(n.text),Ce(n.metadata))},title:"Edit Equipment Short Spec"}),e.jsx(ys,{onClick:()=>F([n.id])})]})]}),e.jsx("div",{className:"text-sm text-slate-300 break-words leading-relaxed",children:B?e.jsxs("div",{onClick:P=>P.stopPropagation(),children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Original Equipment Tag"}),e.jsx("input",{type:"text",value:((ee=Nt.originalEquipmentTag)==null?void 0:ee.text)||"",onChange:P=>Ce({...Nt,originalEquipmentTag:{...Nt.originalEquipmentTag,text:P.target.value}}),className:"w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs text-slate-300 placeholder-slate-500 focus:outline-none focus:ring-1 focus:ring-orange-500",placeholder:"Equipment tag name..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Service"}),e.jsx("input",{type:"text",value:Nt.service||"",onChange:P=>Ce({...Nt,service:P.target.value}),className:"w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs text-slate-300 placeholder-slate-500 focus:outline-none focus:ring-1 focus:ring-orange-500",placeholder:"Service description..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Short Specification"}),e.jsx("textarea",{value:Tt,onChange:P=>bt(P.target.value),className:"w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-slate-300 placeholder-slate-500 focus:outline-none focus:ring-1 focus:ring-orange-500",style:{minHeight:"80px"},placeholder:"Equipment short spec...",autoFocus:!0})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-2",children:[e.jsx(bs,{onClick:()=>{Mt(null),bt(""),Ce({})}}),e.jsx(gs,{onClick:()=>{R(n.id,Tt,Nt),Mt(null),bt(""),Ce({})}})]})]}):e.jsxs("div",{className:"space-y-2",children:[n.metadata.service&&e.jsxs("div",{className:"p-2 bg-slate-600/30 rounded border-l-4 border-blue-500",children:[e.jsx("div",{className:"text-xs text-blue-300 font-semibold mb-1",children:"Service"}),e.jsx("div",{className:"text-sm text-slate-300",children:n.metadata.service})]}),e.jsxs("div",{className:"p-2 bg-slate-700/30 rounded",children:[e.jsx("div",{className:"text-xs text-orange-300 font-semibold mb-1",children:"Short Specification"}),e.jsx("div",{className:"whitespace-pre-wrap text-sm text-slate-300",children:n.text||"No specification entered yet"})]})]})})]},n.id)})})]}),Le==="loops"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-3 space-y-2 border-b border-slate-700",children:[e.jsx("input",{type:"text",placeholder:"Search loops...",value:X,onChange:n=>ke(n.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md px-2 py-1.5 text-sm focus:ring-sky-500 focus:border-sky-500"}),e.jsx("div",{className:"text-xs text-slate-400",children:"Press 'L' to create loops from selected instrument tags"})]}),e.jsx("div",{className:"flex-grow overflow-y-auto p-3 space-y-2",children:Re.length===0?e.jsxs("div",{className:"text-center text-slate-500 mt-8",children:[e.jsx("div",{className:"text-lg mb-2",children:"🔗"}),e.jsx("div",{className:"text-sm",children:"No loops created yet"}),e.jsx("div",{className:"text-xs mt-1",children:"Select instrument tags and press 'L' to create"})]}):Re.filter(n=>X?(n.name||n.id).toLowerCase().includes(X.toLowerCase()):!0).sort((n,V)=>{const B=n.name||n.id,ee=V.name||V.id;return B.localeCompare(ee)}).map(n=>{const V=n.tagIds.map(P=>o.find(re=>re.id===P)).filter(Boolean),B=()=>V.length===0?null:V.reduce((P,re)=>re.bbox.y1<P.bbox.y1||re.bbox.y1===P.bbox.y1&&re.bbox.x1<P.bbox.x1?re:P),ee=()=>{O(n.tagIds);const P=B();P&&D(P.id)};return e.jsxs("div",{className:"group border border-slate-600 rounded-lg p-3 bg-slate-700/30 cursor-pointer hover:bg-slate-600/30 transition-colors",onClick:ee,title:"Click to select all tags in this loop",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"flex items-center space-x-2 flex-grow",children:Te===n.id?e.jsxs("div",{className:"flex items-center space-x-2 flex-grow",children:[e.jsx("input",{type:"text",value:Je,onChange:P=>{P.stopPropagation(),yt(P.target.value)},onKeyDown:P=>{P.stopPropagation(),P.key==="Enter"?m():P.key==="Escape"&&f()},className:"bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sky-300 font-mono font-semibold text-sm flex-grow focus:ring-sky-500 focus:border-sky-500",autoFocus:!0,onClick:P=>P.stopPropagation()}),e.jsx(gs,{onClick:m}),e.jsx(bs,{onClick:f})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-sky-300 font-mono font-semibold text-sm",children:n.name||n.id}),e.jsxs("span",{className:"text-xs text-slate-400",children:["(",V.length," tags)",V.length>0&&` P. ${V.map(P=>P.page).filter((P,re,de)=>de.indexOf(P)===re).sort((P,re)=>P-re).join(", ")}`]}),e.jsx(rs,{comments:_e(n.id),onClick:P=>{P.stopPropagation(),w(n.id,n.name||n.id,"loop")},size:"sm"}),e.jsx(fs,{onClick:()=>h(n.id),title:"Edit loop name"})]})}),Te!==n.id&&e.jsx("button",{onClick:P=>{P.stopPropagation(),We([n.id])},className:"text-red-400 hover:text-red-300 p-1",title:"Delete loop",children:"✕"})]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:V.map(P=>e.jsxs("div",{className:"inline-flex items-center bg-slate-600/50 text-slate-300 rounded text-xs font-mono overflow-hidden",children:[e.jsxs("span",{onClick:re=>{re.stopPropagation(),D(P.id)},className:"px-2 py-1 cursor-pointer hover:bg-slate-500/50 transition-colors",title:`Click to center on tag: ${P.text}`,children:[P.text," ",e.jsxs("span",{className:"text-slate-400",children:["P.",P.page]})]}),e.jsx("button",{onClick:re=>{re.stopPropagation(),Be(n.id,{...n,tagIds:n.tagIds.filter(de=>de!==P.id)})},className:"px-1 py-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 transition-colors",title:`Remove ${P.text} from loop`,children:"✕"})]},P.id))})]},n.id)})})]}),Le==="relationships"&&e.jsx(ws,{relationships:qe}),Le==="comments"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-3 border-b border-slate-700 flex-shrink-0",children:e.jsxs("div",{className:"flex gap-1 text-xs",children:[e.jsxs("button",{onClick:()=>wt("all"),className:`px-2 py-1 rounded ${gt==="all"?"bg-sky-600 text-white":"bg-slate-700 text-slate-300"}`,children:["All (",De.length,")"]}),e.jsxs("button",{onClick:()=>wt("unresolved"),className:`px-2 py-1 rounded ${gt==="unresolved"?"bg-amber-600 text-white":"bg-slate-700 text-slate-300"}`,children:["Unresolved (",De.filter(n=>!n.isResolved).length,")"]}),e.jsxs("button",{onClick:()=>wt("high"),className:`px-2 py-1 rounded ${gt==="high"?"bg-red-600 text-white":"bg-slate-700 text-slate-300"}`,children:["🔴 High (",De.filter(n=>n.priority==="high").length,")"]})]})}),e.jsx("div",{className:"flex-grow overflow-y-auto",children:I.length===0?e.jsx("div",{className:"p-4 text-center text-slate-500",children:gt==="all"?"No comments yet":`No ${gt} comments`}):e.jsx("div",{className:"space-y-2 p-3",children:I.map(n=>e.jsxs("div",{className:`p-3 rounded-lg border cursor-pointer hover:bg-slate-700/30 transition-colors ${n.isResolved?"bg-slate-700/20 border-slate-600/50":"bg-slate-700/40 border-slate-600"}`,onClick:()=>w(n.targetId,s(n.targetId,n.targetType),n.targetType),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs font-semibold ${n.priority==="high"?"bg-red-500/20 text-red-400 border border-red-500/30":n.priority==="medium"?"bg-yellow-500/20 text-yellow-400 border border-yellow-500/30":"bg-slate-500/20 text-slate-400 border border-slate-500/30"}`,children:n.priority==="high"?"🔴 HIGH":n.priority==="medium"?"🟡 MED":"⚪ LOW"}),n.isResolved&&e.jsx("span",{className:"text-green-400 text-sm",children:"✅"})]}),e.jsx("span",{className:"text-xs text-slate-500",children:new Date(n.timestamp).toLocaleDateString()})]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs("p",{className:"text-sm text-sky-400 font-medium",children:[l(n.targetType),": ",g(n.targetId,n.targetType).name]}),g(n.targetId,n.targetType).metadata&&e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:g(n.targetId,n.targetType).metadata})]}),e.jsx("p",{className:`text-sm ${n.isResolved?"text-slate-400":"text-white"} line-clamp-3`,children:n.content})]},n.id))})})]}),e.jsx("div",{className:"p-4 border-t border-slate-700 flex-shrink-0",children:e.jsxs("button",{onClick:Rt,className:"w-full flex items-center justify-center space-x-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition-colors",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z",clipRule:"evenodd"})}),e.jsx("span",{children:"Export to Excel"})]})}),Pt&&st&&e.jsx(dn,{isOpen:Pt,targetId:st,targetName:Zt,targetType:Ot,comments:_e(st),onClose:W,onCreateComment:$,onUpdateComment:Oe,onDeleteComment:Ge}),e.jsx("div",{className:`absolute top-0 right-0 w-1 h-full cursor-col-resize group hover:bg-sky-500/50 transition-colors ${Bt?"bg-sky-500":"bg-transparent"}`,onMouseDown:r,title:"Drag to resize sidebar",children:e.jsx("div",{className:"absolute top-1/2 right-0 transform -translate-y-1/2 translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs("div",{className:"flex flex-col items-center justify-center w-3 h-8 bg-slate-700 border border-slate-600 rounded-sm",children:[e.jsx("div",{className:"w-0.5 h-1 bg-slate-400 mb-0.5"}),e.jsx("div",{className:"w-0.5 h-1 bg-slate-400 mb-0.5"}),e.jsx("div",{className:"w-0.5 h-1 bg-slate-400"})]})})})]})},hn=ot.memo(({onClick:o,title:c="Edit"})=>e.jsx("button",{onClick:A=>{A.stopPropagation(),o()},className:"p-1 rounded-full text-slate-500 hover:bg-sky-500/20 hover:text-sky-400 transition-colors opacity-0 group-hover:opacity-100",title:c,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{d:"M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"}),e.jsx("path",{fillRule:"evenodd",d:"M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z",clipRule:"evenodd"})]})})),pn=ot.memo(({onClick:o,title:c="Delete"})=>e.jsx("button",{onClick:A=>{A.stopPropagation(),o()},className:"p-1 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100",title:c,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})}));ot.memo(({onClick:o,title:c="Delete relationship"})=>e.jsx("button",{onClick:A=>{A.stopPropagation(),o()},className:"p-0.5 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100",title:c,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})}));const fn=ot.memo(({onClick:o,title:c="Save"})=>e.jsx("button",{onClick:A=>{A.stopPropagation(),o()},className:"p-1 rounded-full text-green-400 hover:text-green-300 transition-colors",title:c,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})),gn=ot.memo(({onClick:o,title:c="Cancel"})=>e.jsx("button",{onClick:A=>{A.stopPropagation(),o()},className:"p-1 rounded-full text-slate-400 hover:text-slate-300 transition-colors",title:c,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),bn=({tags:o,relationships:c,setRelationships:A,currentPage:C,setCurrentPage:j,isVisible:N,onUpdateTagText:U,onDeleteTags:L,onPingTag:v,focusOPCConnection:Y})=>{const[H,se]=t.useState(""),[Q,O]=t.useState(!0),[_,ie]=t.useState({connected:!0,ready:!0,invalid:!0}),[fe,ne]=t.useState(new Set),[ye,K]=t.useState(null),[te,z]=t.useState(""),T=t.useRef(null),F=t.useMemo(()=>{const D=o.filter(we=>we.category===a.OffPageConnector),he=c.filter(we=>we.type===J.OffPageConnection),ue={};return D.forEach(we=>{const y=we.text;ue[y]||(ue[y]={referenceText:y,tags:[],status:"invalid",pages:[],relationship:void 0}),ue[y].tags.push(we),ue[y].pages.includes(we.page)||ue[y].pages.push(we.page)}),Object.values(ue).forEach(we=>{if(we.tags.length===2&&we.pages.length===2){const[y,ae]=we.tags,be=he.find(Ne=>Ne.from===y.id&&Ne.to===ae.id||Ne.from===ae.id&&Ne.to===y.id);be?(we.status="connected",we.relationship=be):we.status="ready"}else we.status="invalid"}),Object.values(ue).sort((we,y)=>we.referenceText.localeCompare(y.referenceText))},[o,c]),R=t.useMemo(()=>{let D=F;if(Q&&(D=D.filter(he=>he.pages.includes(C))),H.trim()){const he=H.toLowerCase();D=D.filter(ue=>ue.referenceText.toLowerCase().includes(he)||ue.pages.some(we=>we.toString().includes(he)))}return D=D.filter(he=>_[he.status]),D},[F,H,Q,C,_]),M=D=>{j(D)},Z=()=>{se("")},xe=D=>{ne(he=>{const ue=new Set(he);return ue.has(D)?ue.delete(D):ue.add(D),ue})},p=D=>{if(D.tags.length===2&&D.status==="ready"){const[he,ue]=D.tags,we={id:Fe(),type:J.OffPageConnection,from:he.id,to:ue.id};A(y=>[...y,we])}},le=D=>{D.relationship&&A(he=>he.filter(ue=>{var we;return ue.id!==((we=D.relationship)==null?void 0:we.id)}))},oe=(D,he)=>{K(D),z(he)},ge=()=>{ye&&te.trim()&&(U(ye,te.trim()),K(null),z(""))},We=()=>{K(null),z("")},Be=D=>{if(window.confirm("Are you sure you want to delete this OPC tag?")){const he=c.filter(ue=>ue.type===J.OffPageConnection&&(ue.from===D||ue.to===D));he.length>0&&A(ue=>ue.filter(we=>!he.some(y=>y.id===we.id))),L([D])}},je=D=>{j(D.page),v(D.id)};return t.useEffect(()=>{if(Y&&N){const D=F.find(he=>he.tags.some(ue=>ue.text===Y));D&&(ne(he=>new Set([...he,D.referenceText])),setTimeout(()=>{const he=document.querySelector(`[data-connection-ref="${D.referenceText}"]`);he&&T.current&&(he.scrollIntoView({behavior:"smooth",block:"center"}),he.classList.add("animate-pulse","bg-violet-500/20"),setTimeout(()=>{he.classList.remove("animate-pulse","bg-violet-500/20")},2e3))},100))}},[Y,N,F]),N?e.jsxs("div",{className:"bg-slate-800 border-l border-slate-700 flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-slate-700",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-3",children:"OPC Connections"}),e.jsxs("div",{className:"relative mb-3",children:[e.jsx("input",{type:"text",placeholder:"Search OPC references...",value:H,onChange:D=>se(D.target.value),className:"w-full px-3 py-2 pr-8 bg-slate-900 border border-slate-600 rounded text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-1 focus:ring-violet-500 focus:border-violet-500"}),H&&e.jsx("button",{onClick:Z,className:"absolute right-2 top-2 text-slate-400 hover:text-white",children:"×"})]}),e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Q,onChange:D=>O(D.target.checked),className:"w-4 h-4 text-violet-600 bg-slate-900 border-slate-600 rounded focus:ring-violet-500 focus:ring-1"}),e.jsx("span",{className:"text-sm text-slate-300",children:"Current Page Only"})]}),Q&&e.jsxs("span",{className:"text-xs text-violet-400 font-medium",children:["Page ",C]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("span",{className:"text-sm text-slate-400 font-medium",children:"Status Filter:"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:_.connected,onChange:D=>ie(he=>({...he,connected:D.target.checked})),className:"w-4 h-4 text-green-600 bg-slate-900 border-slate-600 rounded focus:ring-green-500 focus:ring-1"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),e.jsx("span",{className:"text-sm text-slate-300",children:"Connected"})]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:_.ready,onChange:D=>ie(he=>({...he,ready:D.target.checked})),className:"w-4 h-4 text-yellow-600 bg-slate-900 border-slate-600 rounded focus:ring-yellow-500 focus:ring-1"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500"}),e.jsx("span",{className:"text-sm text-slate-300",children:"Ready"})]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:_.invalid,onChange:D=>ie(he=>({...he,invalid:D.target.checked})),className:"w-4 h-4 text-red-600 bg-slate-900 border-slate-600 rounded focus:ring-red-500 focus:ring-1"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),e.jsx("span",{className:"text-sm text-slate-300",children:"Invalid"})]})]})]})]})]}),e.jsx("div",{className:"px-4 py-3 bg-slate-900/50 border-b border-slate-700 text-sm",children:e.jsxs("div",{className:"flex justify-between text-slate-300",children:[e.jsxs("span",{children:[Q?"Current Page":"Total",": ",R.length]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs("span",{className:"text-green-400",children:["Connected: ",R.filter(D=>D.status==="connected").length]}),e.jsxs("span",{className:"text-yellow-400",children:["Ready: ",R.filter(D=>D.status==="ready").length]}),e.jsxs("span",{className:"text-red-400",children:["Invalid: ",R.filter(D=>D.status==="invalid").length]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",ref:T,children:R.length===0?e.jsx("div",{className:"p-4 text-center text-slate-400",children:H?"No OPC connections match your search":"No OPC connections found"}):e.jsx("div",{className:"space-y-2 p-2",children:R.map(D=>{const he=fe.has(D.referenceText),we={connected:{dot:"bg-green-500",text:"text-green-400",label:"Connected"},ready:{dot:"bg-yellow-500",text:"text-yellow-400",label:"Ready to Connect"},invalid:{dot:"bg-red-500",text:"text-red-400",label:"Invalid"}}[D.status];return e.jsxs("div",{"data-connection-ref":D.referenceText,className:"bg-slate-900 rounded-lg border border-slate-700 overflow-hidden",children:[e.jsx("div",{className:"p-2 hover:bg-slate-800/50 transition-colors cursor-pointer",onClick:()=>xe(D.referenceText),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:`transition-transform duration-200 text-xs ${he?"rotate-90":""}`,children:"▶"}),e.jsx("span",{className:"text-sm font-mono text-white",children:D.referenceText}),e.jsx("div",{className:`w-2 h-2 rounded-full ${we.dot}`}),e.jsx("span",{className:`text-xs ${we.text}`,children:we.label}),D.status==="connected"&&e.jsx("button",{onClick:y=>{y.stopPropagation(),le(D)},className:"ml-2 p-1 rounded-full text-slate-400 hover:text-red-400 hover:bg-red-500/20 transition-colors",title:"Disconnect",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"flex items-center space-x-1",children:D.pages.sort((y,ae)=>y-ae).map(y=>e.jsxs("button",{onClick:ae=>{ae.stopPropagation(),M(y)},className:`px-2 py-1 rounded text-xs font-medium transition-colors ${y===C?"bg-violet-500/20 text-violet-400 border border-violet-400":"bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white"}`,children:["P",y]},y))})]})}),he&&e.jsxs("div",{className:"border-t border-slate-700 p-3 bg-slate-800/30",children:[e.jsxs("div",{className:"space-y-2 mb-3",children:[D.tags.sort((y,ae)=>y.page-ae.page).map(y=>e.jsx("div",{className:"group flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-xs text-slate-400",children:["P",y.page,":"]}),ye===y.id?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",value:te,onChange:ae=>z(ae.target.value),onKeyDown:ae=>{ae.key==="Enter"&&ge(),ae.key==="Escape"&&We()},className:"px-2 py-1 text-xs bg-slate-700 border border-violet-400 rounded text-white focus:outline-none focus:ring-1 focus:ring-violet-500",autoFocus:!0}),e.jsx(fn,{onClick:ge}),e.jsx(gn,{onClick:We})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-sm text-white font-mono cursor-pointer hover:text-blue-400 hover:underline transition-colors",onClick:ae=>{ae.stopPropagation(),je(y)},title:`Click to go to page ${y.page} and center on tag`,children:y.text}),e.jsx(hn,{onClick:()=>oe(y.id,y.text)}),e.jsx(pn,{onClick:()=>Be(y.id)})]})]})},y.id)),D.status==="invalid"&&D.tags.length===1&&e.jsxs("div",{className:"flex items-center space-x-2 text-red-400",children:[e.jsxs("span",{className:"text-xs",children:["P",D.tags[0].page===1?2:1,":"]}),e.jsx("span",{className:"text-xs italic",children:"(Missing OPC tag)"})]})]}),D.status==="ready"&&e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:()=>p(D),className:"px-3 py-1.5 bg-green-500/20 text-green-400 hover:bg-green-500/30 border border-green-400/50 rounded text-sm font-medium transition-colors",children:"Connect"})})]})]},D.referenceText)})})}),e.jsx("div",{className:"p-3 border-t border-slate-700 bg-slate-900/50",children:e.jsx("div",{className:"text-xs text-slate-400 text-center",children:"Click OPC entries to navigate between pages"})})]}):null},yn=({selectedTagIds:o,setSelectedTagIds:c,allTags:A,relationships:C,onDeselect:j,onClear:N,rawTextItems:U,selectedRawTextItemIds:L,onDeselectRawTextItem:v,onCreateTag:Y,manualCreationData:H,onManualTagCreate:se,onClearManualCreation:Q})=>{const[O,_]=t.useState(""),[ie,fe]=t.useState(!1);t.useEffect(()=>{H&&_("")},[H]);const ne=o.length>0,ye=L.length>0;if(H){const K=te=>{O.trim()?se({text:O.trim(),category:te}):alert("Please enter text for the tag.")};return e.jsx("div",{className:"absolute bottom-5 left-1/2 -translate-x-1/2 w-full max-w-3xl z-20 px-4 animate-fade-in-up",children:e.jsxs("div",{className:"bg-slate-800/80 backdrop-blur-lg border border-slate-700 rounded-xl shadow-2xl p-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsx("h3",{className:"font-bold text-md text-white",children:"Create Manual Tag"}),e.jsx("button",{onClick:Q,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"Cancel"})]}),e.jsx("div",{className:"mb-3",children:e.jsx("input",{type:"text",placeholder:"Enter tag text...",value:O,onChange:te=>_(te.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md px-3 py-2 text-sm focus:ring-sky-500 focus:border-sky-500",autoFocus:!0})}),e.jsxs("div",{className:"flex items-center justify-between border-t border-slate-700 pt-2",children:[e.jsx("span",{className:"text-sm font-semibold text-slate-300",children:"Select category:"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:()=>K(a.Equipment),className:"px-3 py-1.5 text-sm font-semibold text-white bg-orange-600 rounded-md hover:bg-orange-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"1"}),e.jsx("span",{children:"Equipment"})]}),e.jsxs("button",{onClick:()=>K(a.Line),className:"px-3 py-1.5 text-sm font-semibold text-white bg-rose-600 rounded-md hover:bg-rose-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"2"}),e.jsx("span",{children:"Line"})]}),e.jsxs("button",{onClick:()=>K(a.SpecialItem),className:"px-3 py-1.5 text-sm font-semibold text-white bg-purple-600 rounded-md hover:bg-purple-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"3"}),e.jsx("span",{children:"Special Item"})]}),e.jsxs("button",{onClick:()=>K(a.Instrument),className:"px-3 py-1.5 text-sm font-semibold text-white bg-amber-500 rounded-md hover:bg-amber-600 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"4"}),e.jsx("span",{children:"Instrument"})]}),e.jsxs("button",{onClick:()=>K(a.NotesAndHolds),className:"px-3 py-1.5 text-sm font-semibold text-white bg-teal-600 rounded-md hover:bg-teal-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"5"}),e.jsx("span",{children:"Note/Hold"})]}),e.jsxs("button",{onClick:()=>K(a.OffPageConnector),className:"px-3 py-1.5 text-sm font-semibold text-white bg-violet-600 rounded-md hover:bg-violet-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"6"}),e.jsx("span",{children:"OPC"})]}),e.jsx("button",{onClick:()=>K(a.DrawingNumber),className:"px-3 py-1.5 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors",children:"Drawing No."})]})]})]})})}return!ne&&!ye?null:e.jsx("div",{className:"absolute bottom-5 left-1/2 -translate-x-1/2 w-full max-w-4xl z-20 px-4 animate-fade-in-up",children:e.jsx("div",{className:"bg-slate-800/80 backdrop-blur-lg border border-slate-700 rounded-xl shadow-2xl p-3",children:e.jsxs("div",{className:"flex flex-col space-y-3 max-h-72 overflow-y-auto pr-1",children:[ye&&(()=>{let K=L.map(z=>U.find(T=>T.id===z)).filter(Boolean);ie&&(K=[...K].sort((z,T)=>z.text.localeCompare(T.text)));const te=z=>{Y(K,z),N()};return e.jsxs("div",{className:ne?"pb-3 mb-3 border-b border-slate-700":"",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("h3",{className:"font-bold text-md text-white",children:[K.length," text piece(s) selected"]}),e.jsx("button",{onClick:()=>fe(!ie),className:`p-1.5 rounded-md transition-colors ${ie?"bg-sky-600 text-white hover:bg-sky-500":"bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-slate-300"}`,title:`Sort: ${ie?"Alphabetical":"Selection Order"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"})})})]}),!ne&&e.jsx("button",{onClick:N,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"Clear Selection"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-20 overflow-y-auto pr-2 mb-3",children:K.map(z=>e.jsxs("div",{className:"flex items-center bg-slate-700 rounded-full py-1 pl-3 pr-2 text-sm",children:[e.jsx("span",{className:"font-mono text-white mr-2",children:z.text}),e.jsx("button",{onClick:()=>v(z.id),className:"w-5 h-5 flex items-center justify-center rounded-full bg-slate-600 hover:bg-red-500 transition-colors","aria-label":`Deselect ${z.text}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]},z.id))}),!ne&&e.jsxs("div",{className:"flex items-center justify-between border-t border-slate-700 pt-2",children:[e.jsx("span",{className:"text-sm font-semibold text-slate-300",children:"Create new tag:"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:()=>te(a.Equipment),className:"px-3 py-1.5 text-sm font-semibold text-white bg-orange-600 rounded-md hover:bg-orange-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"1"}),e.jsx("span",{children:"Equipment"})]}),e.jsxs("button",{onClick:()=>te(a.Line),className:"px-3 py-1.5 text-sm font-semibold text-white bg-rose-600 rounded-md hover:bg-rose-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"2"}),e.jsx("span",{children:"Line"})]}),e.jsxs("button",{onClick:()=>te(a.SpecialItem),className:"px-3 py-1.5 text-sm font-semibold text-white bg-purple-600 rounded-md hover:bg-purple-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"3"}),e.jsx("span",{children:"Special Item"})]}),e.jsxs("button",{onClick:()=>te(a.Instrument),className:"px-3 py-1.5 text-sm font-semibold text-white bg-amber-500 rounded-md hover:bg-amber-600 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"4"}),e.jsx("span",{children:"Instrument"})]}),e.jsxs("button",{onClick:()=>te(a.NotesAndHolds),className:"px-3 py-1.5 text-sm font-semibold text-white bg-teal-600 rounded-md hover:bg-teal-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"5"}),e.jsx("span",{children:"Note/Hold"})]}),e.jsxs("button",{onClick:()=>te(a.OffPageConnector),className:"px-3 py-1.5 text-sm font-semibold text-white bg-violet-600 rounded-md hover:bg-violet-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"6"}),e.jsx("span",{children:"OPC"})]}),e.jsx("button",{onClick:()=>te(a.DrawingNumber),className:"px-3 py-1.5 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors",children:"Drawing No."})]})]})]})})(),ne&&(()=>{let K=o.map(R=>A.find(M=>M.id===R)).filter(R=>!!R);if(ie){const R={[a.Equipment]:0,[a.Line]:1,[a.SpecialItem]:2,[a.Instrument]:3,[a.NotesAndHolds]:4,[a.DrawingNumber]:5,[a.Uncategorized]:6};K=[...K].sort((M,Z)=>{const xe=R[M.category]??99,p=R[Z.category]??99;return xe!==p?xe-p:M.text.localeCompare(Z.text)})}const te=o.length===1?A.find(R=>R.id===o[0]):null;let z=[];te&&(te.category===a.Equipment||te.category===a.Line)&&(z=C.filter(R=>R.type===J.Installation&&R.to===te.id).map(R=>A.find(M=>M.id===R.from)).filter(Boolean));const T=R=>{o.includes(R)||c(M=>[...M,R])},F=()=>{const R=z.map(M=>M.id);c(M=>[...new Set([...M,...R])])};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("h3",{className:"font-bold text-md text-white",children:[K.length," tag(s) selected"]}),e.jsx("button",{onClick:()=>fe(!ie),className:`p-1.5 rounded-md transition-colors ${ie?"bg-sky-600 text-white hover:bg-sky-500":"bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-slate-300"}`,title:`Sort: ${ie?"Alphabetical":"Selection Order"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"})})})]}),e.jsx("button",{onClick:N,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"Clear Selection"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-28 overflow-y-auto pr-2",children:K.map(R=>e.jsxs("div",{className:"flex items-center bg-slate-700 rounded-full py-1 pl-3 pr-2 text-sm",children:[e.jsx("span",{className:"font-mono text-white mr-2",children:R.text}),e.jsx("button",{onClick:()=>j(R.id),className:"w-5 h-5 flex items-center justify-center rounded-full bg-slate-600 hover:bg-red-500 transition-colors","aria-label":`Deselect ${R.text}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]},R.id))}),z.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-700",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsxs("h4",{className:"font-semibold text-sm text-white",children:["Installed Instruments (",z.length,")"]}),e.jsx("button",{onClick:F,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"Select All"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-28 overflow-y-auto pr-2",children:z.map(R=>{const M=o.includes(R.id);return e.jsxs("div",{className:`flex items-center rounded-full py-1 pl-3 pr-2 text-sm transition-colors ${M?"bg-slate-600":"bg-slate-700"}`,children:[e.jsx("span",{className:`font-mono mr-2 ${M?"text-slate-400":"text-white"}`,children:R.text}),!M&&e.jsx("button",{onClick:()=>T(R.id),className:"w-5 h-5 flex items-center justify-center rounded-full bg-slate-600 hover:bg-sky-500 transition-colors","aria-label":`Select ${R.text}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})})})]},R.id)})})]})]})})()]})})})},Xt=ot.memo(({onClick:o})=>e.jsx("button",{onClick:c=>{c.stopPropagation(),o()},className:"p-0.5 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors",title:"Delete relationship",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),$s=ot.memo(({onClick:o,title:c="Edit"})=>e.jsx("button",{onClick:A=>{A.stopPropagation(),o()},className:"p-1 rounded-full text-slate-500 hover:bg-sky-500/20 hover:text-sky-400 transition-colors opacity-0 group-hover:opacity-100",title:c,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{d:"M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"}),e.jsx("path",{d:"M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"})]})})),Is=ot.memo(({onClick:o})=>e.jsx("button",{onClick:c=>{c.stopPropagation(),o()},className:"p-1 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100",title:"Delete",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})),jn=({pdfDoc:o,tags:c,setTags:A,relationships:C,setRelationships:j,rawTextItems:N,descriptions:U,setDescriptions:L,equipmentShortSpecs:v,setEquipmentShortSpecs:Y,loops:H,setLoops:se,onCreateTag:Q,onCreateManualTag:O,onCreateDescription:_,onCreateHoldDescription:ie,onCreateEquipmentShortSpec:fe,onDeleteTags:ne,onUpdateTagText:ye,onDeleteDescriptions:K,onUpdateDescription:te,onDeleteEquipmentShortSpecs:z,onUpdateEquipmentShortSpec:T,onMergeRawTextItems:F,onDeleteRawTextItems:R,onUpdateRawTextItemText:M,onAutoLinkDescriptions:Z,onAutoLinkNotesAndHolds:xe,onAutoLinkEquipmentShortSpecs:p,onAutoGenerateLoops:le,onManualCreateLoop:oe,onDeleteLoops:ge,onUpdateLoop:We,showConfirmation:Be,currentPage:je,setCurrentPage:D,scale:he,setScale:ue,mode:we,setMode:y,relationshipStartTag:ae,setRelationshipStartTag:be,visibilitySettings:Ne,updateVisibilitySettings:Ze,toggleTagVisibility:Ie,toggleRelationshipVisibility:De,toggleAllTags:Ue,toggleAllRelationships:Oe,isSidePanelVisible:Ge,isOPCPanelVisible:_e,showAutoLinkRanges:Se,tolerances:Ve,comments:ve,onCreateComment:Xe,onUpdateComment:Ee,onDeleteComment:k,getCommentsForTarget:X,colorSettings:ke,focusOPCConnection:Le,onOPCTagClick:me,showAllRelationships:Te,setShowAllRelationships:Ae,showOnlySelectedRelationships:Je,setShowOnlySelectedRelationships:yt})=>{var d,x;const[Ye,ct]=t.useState([]),[tt,it]=t.useState([]),[dt,rt]=t.useState([]),[jt,St]=t.useState([]),[Pt,ft]=t.useState(null),[st,xt]=t.useState(null),[Zt,vt]=t.useState(null),[Ot,Yt]=t.useState(null),[gt,wt]=t.useState(null),[Ht,Kt]=t.useState(null),[Bt,Me]=t.useState(null),[Ut,At]=t.useState(!1),[_t,Mt]=t.useState(""),[Tt,bt]=t.useState(new Set),Nt=!Ge&&Ye.length===1,Ce=Nt?c.find(h=>h.id===Ye[0]):null,at=h=>{ct(m=>m.filter(f=>f!==h)),Ye.length<=1&&ft(null)},ht=h=>{it(m=>m.filter(f=>f!==h))},pt=()=>{ct([]),it([]),rt([]),ft(null)},Et=(h,m)=>{xt({bbox:h,page:m})},Gt=({text:h,category:m})=>{st&&(O({...st,text:h,category:m}),xt(null))},Lt=()=>{xt(null)},Qe=h=>{At(!0),Mt(h.text)},Ft=()=>{_t.trim()&&_t!==Ce.text&&Ce&&ye(Ce.id,_t.trim()),At(!1),Mt("")},zt=()=>{At(!1),Mt("")},lt=h=>{j(m=>m.filter(f=>f.id!==h))},kt=t.useCallback(h=>{const m=c.find(f=>f.id===h);m&&m.page!==je&&D(m.page),vt(h),setTimeout(()=>vt(null),2e3),Me({tagId:h,timestamp:Date.now()}),setTimeout(()=>Me(null),100)},[c,je,D]),es=t.useCallback(h=>{const m=U.find(f=>f.id===h);m&&m.page!==je&&D(m.page),Yt(h),setTimeout(()=>Yt(null),2e3),m&&(Me({descriptionId:h,timestamp:Date.now()}),setTimeout(()=>Me(null),100))},[U,je,D]),Vt=t.useCallback(h=>{const m=v.find(f=>f.id===h);m&&m.page!==je&&D(m.page),wt(h),setTimeout(()=>wt(null),2e3),m&&(Me({equipmentShortSpecId:h,timestamp:Date.now()}),setTimeout(()=>Me(null),100))},[v,je,D]),u=t.useCallback(h=>{const m=C.find(f=>f.id===h);if(m){const f=[...c,...U,...N,...v].find($=>$.id===m.from),w=[...c,...U,...N,...v].find($=>$.id===m.to),W=(f==null?void 0:f.page)||(w==null?void 0:w.page);W&&W!==je&&D(W)}Kt(h),setTimeout(()=>Kt(null),2e3)},[C,c,U,N,v,je,D]);return e.jsxs("div",{className:"flex h-full bg-slate-900 relative",children:[Ge&&e.jsx(un,{tags:c,setTags:A,rawTextItems:N,descriptions:U,equipmentShortSpecs:v,setEquipmentShortSpecs:Y,loops:H,setLoops:se,currentPage:je,setCurrentPage:D,selectedTagIds:Ye,setSelectedTagIds:h=>{ct(h),ft("panel")},tagSelectionSource:Pt,selectedDescriptionIds:dt,setSelectedDescriptionIds:rt,selectedEquipmentShortSpecIds:jt,setSelectedEquipmentShortSpecIds:St,relationships:C,setRelationships:j,onDeleteTags:ne,onUpdateTagText:ye,onDeleteDescriptions:K,onUpdateDescription:te,onDeleteEquipmentShortSpecs:z,onUpdateEquipmentShortSpec:T,onMergeRawTextItems:F,onDeleteRawTextItems:R,onUpdateRawTextItemText:M,onAutoLinkDescriptions:Z,onAutoLinkNotesAndHolds:xe,onAutoLinkEquipmentShortSpecs:p,onAutoGenerateLoops:le,onManualCreateLoop:oe,onDeleteLoops:ge,onUpdateLoop:We,showConfirmation:Be,onPingTag:kt,onPingDescription:es,onPingEquipmentShortSpec:Vt,onPingRelationship:u,visibilitySettings:Ne,updateVisibilitySettings:Ze,toggleTagVisibility:Ie,toggleRelationshipVisibility:De,toggleAllTags:Ue,toggleAllRelationships:Oe,comments:ve,onCreateComment:Xe,onUpdateComment:Ee,onDeleteComment:k,getCommentsForTarget:X}),e.jsx("div",{className:"flex-grow h-full overflow-auto bg-slate-800/30",children:e.jsx(rn,{pdfDoc:o,tags:c,setTags:A,relationships:C,setRelationships:j,currentPage:je,setCurrentPage:D,selectedTagIds:Ye,setSelectedTagIds:h=>{ct(h),ft("pdf")},selectedDescriptionIds:dt,setSelectedDescriptionIds:rt,selectedEquipmentShortSpecIds:jt,setSelectedEquipmentShortSpecIds:St,rawTextItems:N,descriptions:U,equipmentShortSpecs:v,onCreateTag:Q,onCreateDescription:_,onCreateHoldDescription:ie,onCreateEquipmentShortSpec:fe,selectedRawTextItemIds:tt,setSelectedRawTextItemIds:it,onDeleteTags:ne,onMergeRawTextItems:F,onManualCreateLoop:oe,onManualAreaSelect:Et,onUpdateTagText:ye,onUpdateRawTextItemText:M,scale:he,setScale:ue,mode:we,setMode:y,relationshipStartTag:ae,setRelationshipStartTag:be,visibilitySettings:Ne,updateVisibilitySettings:Ze,pingedTagId:Zt,pingedDescriptionId:Ot,pingedEquipmentShortSpecId:gt,pingedRelationshipId:Ht,colorSettings:ke,scrollToCenter:Bt,setScrollToCenter:Me,showAutoLinkRanges:Se,tolerances:Ve,showAllRelationships:Te,setShowAllRelationships:Ae,showOnlySelectedRelationships:Je,setShowOnlySelectedRelationships:yt,onOPCTagClick:me})}),e.jsx(yn,{selectedTagIds:Ye,setSelectedTagIds:ct,allTags:c,relationships:C,onDeselect:at,onClear:pt,rawTextItems:N,selectedRawTextItemIds:tt,onDeselectRawTextItem:ht,onCreateTag:Q,manualCreationData:st,onManualTagCreate:Gt,onClearManualCreation:Lt}),Nt&&Ce&&e.jsx("div",{className:"fixed left-4 top-20 w-80 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-40 max-h-96 overflow-y-auto",children:e.jsxs("div",{className:"group p-2 rounded-md hover:bg-slate-700/50",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-grow mr-2",children:[e.jsxs("div",{className:"flex items-center space-x-2 flex-grow min-w-0",children:[e.jsx("input",{type:"checkbox",checked:Ce.isReviewed||!1,onChange:h=>{h.stopPropagation(),A(m=>m.map(f=>f.id===Ce.id?{...f,isReviewed:!f.isReviewed}:f))},className:"w-4 h-4 text-sky-600 bg-slate-700 border-slate-500 rounded focus:ring-sky-500 focus:ring-2",title:"Mark as reviewed"}),e.jsx("span",{className:`inline-flex items-center justify-center w-5 h-5 rounded text-xs font-bold text-white ${((d=xs[Ce.category])==null?void 0:d.bg)||"bg-slate-600"} ${((x=xs[Ce.category])==null?void 0:x.border)||"border-slate-600"} border flex-shrink-0`,children:Ce.category==="Equipment"?"E":Ce.category==="Line"?"L":Ce.category==="Instrument"?"I":Ce.category==="DrawingNumber"?"D":Ce.category==="NotesAndHolds"?"N":"U"}),Ut?e.jsx("div",{className:"flex items-center space-x-1 flex-grow",children:e.jsx("input",{type:"text",value:_t,onChange:h=>Mt(h.target.value),onKeyDown:h=>{h.key==="Enter"&&Ft(),h.key==="Escape"&&zt()},onBlur:Ft,autoFocus:!0,className:"font-mono text-sm text-white bg-slate-600 border border-sky-500 rounded px-1 flex-grow"})}):e.jsx("span",{className:"font-mono text-sm text-white truncate",children:Ce.text}),e.jsx(rs,{comments:(X==null?void 0:X(Ce.id))||[],onClick:()=>{},size:"sm",className:"flex-shrink-0 ml-2"})]}),Ce.category==="Instrument"&&(()=>{const h=(H==null?void 0:H.filter(m=>m.tagIds.includes(Ce.id)))||[];return h.length>0&&e.jsx("div",{className:"mt-1",children:h.map(m=>e.jsx("div",{className:"mb-1",children:e.jsxs("span",{className:"text-xs text-blue-400 font-mono ml-8",children:["Loop: ",m.name||m.id]})},m.id))})})(),(()=>{const h=(ve==null?void 0:ve.filter(m=>m.targetType==="tag"&&m.targetId===Ce.id))||[];return h.length>0&&e.jsx("div",{className:"mt-1 ml-8",children:e.jsxs("span",{className:"text-xs text-yellow-400",children:["💬 ",h.length," comment",h.length!==1?"s":""]})})})()]}),e.jsxs("div",{className:"flex items-center space-x-1 flex-shrink-0",children:[e.jsxs("span",{className:"text-xs text-slate-400",children:["P. ",Ce.page]}),e.jsx($s,{onClick:()=>Qe(Ce),title:"Edit tag text"}),e.jsx(Is,{onClick:()=>{confirm(`Delete tag "${Ce.text}"?`)&&(ne([Ce.id]),ct([]))}}),e.jsx("button",{onClick:()=>ct([]),className:"text-slate-400 hover:text-white transition-colors p-1 rounded hover:bg-slate-700 ml-2",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),(()=>{const h=C.filter(i=>i.from===Ce.id&&i.type==="Connection"),m=C.filter(i=>i.to===Ce.id&&i.type==="Connection"),f=C.find(i=>i.from===Ce.id&&i.type==="Installation"),w=C.filter(i=>i.to===Ce.id&&i.type==="Installation"),W=C.filter(i=>(i.from===Ce.id||i.to===Ce.id)&&i.type==="Annotation"),$=C.filter(i=>i.from===Ce.id&&i.type==="Note"),s=C.filter(i=>i.to===Ce.id&&i.type==="Note"),l=C.filter(i=>i.from===Ce.id&&i.type==="Description"),g=C.filter(i=>i.to===Ce.id&&i.type==="Description"),r=C.filter(i=>i.from===Ce.id&&i.type==="EquipmentShortSpec"),b=h.length>0||m.length>0||f||w.length>0||W.length>0||$.length>0||s.length>0||l.length>0||g.length>0||r.length>0,S=(i,E)=>e.jsx("button",{onClick:q=>{q.stopPropagation();const pe=c.find(Re=>Re.id===i);pe&&(ct([pe.id]),D(pe.page),ft("panel"),kt(pe.id))},className:"text-sky-400 hover:text-sky-300 font-mono cursor-pointer",children:E},i),I=new Map(c.map(i=>[i.id,i]));return b&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-slate-700/50 space-y-1 text-xs text-slate-300",children:[h.map(i=>{const E=I.get(i.to);return E?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-slate-300 text-xs",children:"To"}),S(E.id,E.text)]}),e.jsx(Xt,{onClick:()=>lt(i.id)})]},i.id):null}),m.map(i=>{const E=I.get(i.from);return E?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-slate-300 text-xs",children:"From"}),S(E.id,E.text)]}),e.jsx(Xt,{onClick:()=>lt(i.id)})]},i.id):null}),f&&I.get(f.to)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"Installation",children:"📌"}),e.jsx("span",{className:"text-slate-400",children:"Installed on:"}),S(f.to,I.get(f.to).text)]}),e.jsx(Xt,{onClick:()=>lt(f.id)})]}),w.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Installed Instruments:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:w.map(i=>{const E=I.get(i.from);return E?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:S(E.id,E.text)}),e.jsx(Xt,{onClick:()=>lt(i.id)})]},i.id):null})})]}),W.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Related Text:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:W.map(i=>{const E=i.from===Ce.id?i.to:i.from,q=N.find(Re=>Re.id===E),pe=Tt.has(E);return q?e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 text-slate-500 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z",clipRule:"evenodd"})}),pe?e.jsx("input",{type:"text",defaultValue:q.text,onBlur:Re=>{Re.target.value.trim()!==q.text&&M(E,Re.target.value.trim()),bt(qe=>{const G=new Set(qe);return G.delete(E),G})},onKeyDown:Re=>{Re.key==="Enter"&&Re.target.blur(),Re.key==="Escape"&&bt(qe=>{const G=new Set(qe);return G.delete(E),G})},autoFocus:!0,className:"text-slate-300 font-mono bg-slate-600 border border-sky-500 rounded px-1 flex-grow text-xs"}):e.jsxs("span",{className:"text-slate-300 font-mono truncate max-w-[180px]",children:['"',q.text,'"']})]}),e.jsxs("div",{className:"flex items-center flex-shrink-0",children:[e.jsx($s,{onClick:()=>{bt(Re=>{const qe=new Set(Re);return qe.add(E),qe})}}),e.jsx(Is,{onClick:()=>R([E])}),e.jsx(Xt,{onClick:()=>lt(i.id)})]})]},i.id):null})})]}),$.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Notes:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:$.map(i=>{const E=I.get(i.to);return E?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"Note",children:"📝"}),S(E.id,E.text)]}),e.jsx(Xt,{onClick:()=>lt(i.id)})]},i.id):null})})]}),s.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Note for:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:s.map(i=>{const E=I.get(i.from);return E?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:S(E.id,E.text)}),e.jsx(Xt,{onClick:()=>lt(i.id)})]},i.id):null})})]}),(l.length>0||g.length>0)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Descriptions:"}),e.jsxs("div",{className:"pl-3 space-y-0.5 mt-1",children:[l.map(i=>{const E=U.find(q=>q.id===i.to);return E?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-purple-300",children:["📄 ",E.metadata.type," ",E.metadata.number]}),e.jsx(Xt,{onClick:()=>lt(i.id)})]},i.id):null}),g.map(i=>{const E=U.find(q=>q.id===i.from);return E?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-purple-300",children:["📄 ",E.metadata.type," ",E.metadata.number]}),e.jsx(Xt,{onClick:()=>lt(i.id)})]},i.id):null})]})]}),r.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Equipment Specs:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:r.map(i=>{const E=v.find(q=>q.id===i.to);return E?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-orange-300",children:["⚙️ ",E.text]}),e.jsx(Xt,{onClick:()=>lt(i.id)})]},i.id):null})})]})]})})()]})}),_e&&e.jsx("div",{className:"w-80 flex-shrink-0",children:e.jsx(bn,{tags:c,relationships:C,setRelationships:j,currentPage:je,setCurrentPage:D,isVisible:_e,onUpdateTagText:ye,onDeleteTags:ne,onPingTag:kt,focusOPCConnection:Le})})]})},It=({text:o})=>e.jsx("kbd",{className:"px-2 py-1 text-xs font-semibold text-sky-300 bg-slate-700 rounded-md border-b-2 border-slate-600",children:o}),vn=({onClose:o})=>{const c=t.useRef(null);t.useEffect(()=>{const j=N=>{N.key==="Escape"&&(N.preventDefault(),o())};return document.addEventListener("keydown",j),()=>{document.removeEventListener("keydown",j)}},[o]);const A=[{key:"S",desc:e.jsxs(e.Fragment,{children:["Toggle ",e.jsx("span",{className:"text-sky-300 font-bold",children:"S"}),"ide Panel"]})},{key:"O",desc:e.jsxs(e.Fragment,{children:["Toggle ",e.jsx("span",{className:"text-sky-300 font-bold",children:"O"}),"PC Panel"]})},{key:"C",desc:e.jsxs(e.Fragment,{children:["Toggle ",e.jsx("span",{className:"text-sky-300 font-bold",children:"C"}),"onnect Mode"]})},{key:"K",desc:e.jsxs(e.Fragment,{children:["Toggle Manual Ma",e.jsx("span",{className:"text-sky-300 font-bold",children:"k"}),"e Mode"]})},{key:"V",desc:e.jsxs(e.Fragment,{children:["Toggle ",e.jsx("span",{className:"text-sky-300 font-bold",children:"V"}),"isibility Panel"]})},{key:"/",desc:e.jsxs(e.Fragment,{children:["Show Hotkey Help ",e.jsx("span",{className:"text-sky-300 font-bold",children:"/"})]})},{key:"Esc",desc:e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-sky-300 font-bold",children:"Esc"})," Mode / Clear Selection"]})}],C=[{key:"F2",desc:e.jsxs(e.Fragment,{children:["Edit selected tag or text item (",e.jsx("span",{className:"text-sky-300 font-bold",children:"F2"}),")"]})},{key:"M",desc:e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-sky-300 font-bold",children:"M"}),"erge multiple text items into one"]})},{key:"N",desc:e.jsxs(e.Fragment,{children:["Make ",e.jsx("span",{className:"text-sky-300 font-bold",children:"N"}),"ote Description from selected items"]})},{key:"H",desc:e.jsxs(e.Fragment,{children:["Make ",e.jsx("span",{className:"text-sky-300 font-bold",children:"H"}),"old Description from selected items"]})},{key:"P",desc:e.jsxs(e.Fragment,{children:["Make Equipment Short S",e.jsx("span",{className:"text-sky-300 font-bold",children:"p"}),"ec"]})},{key:"L",desc:e.jsxs(e.Fragment,{children:["Make ",e.jsx("span",{className:"text-sky-300 font-bold",children:"L"}),"oop from selected instruments"]})},{key:"I",desc:e.jsxs(e.Fragment,{children:['Make "',e.jsx("span",{className:"text-sky-300 font-bold",children:"I"}),'nstall" relationship']})},{key:"R",desc:e.jsxs(e.Fragment,{children:["Make ",e.jsx("span",{className:"text-sky-300 font-bold",children:"R"}),"elationships (Note/Annotation)"]})},{key:"Delete",desc:e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-sky-300 font-bold",children:"Delete"})," selected tag(s)"]})}];return e.jsxs("div",{ref:c,className:"absolute top-16 right-4 z-20 w-96 bg-slate-800/90 backdrop-blur-sm border border-slate-700 rounded-lg shadow-xl p-4 text-white animate-fade-in-up",style:{animationDuration:"0.2s"},children:[e.jsxs("div",{className:"flex justify-between items-center mb-3 border-b border-slate-600 pb-2",children:[e.jsx("h3",{className:"text-md font-bold",children:"Hotkeys & Controls"}),e.jsx("button",{onClick:o,className:"p-1 rounded-full hover:bg-slate-700 transition-colors",title:"Close (Esc)",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-sm text-slate-400 mb-2",children:"Navigation & Selection"}),e.jsxs("dl",{className:"space-y-2 text-sm text-slate-300",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("dt",{children:"Pan View"}),e.jsx("dd",{children:e.jsx(It,{text:"Drag"})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("dt",{children:"Previous Page"}),e.jsx("dd",{children:e.jsx(It,{text:"Q"})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("dt",{children:"Next Page"}),e.jsx("dd",{children:e.jsx(It,{text:"W"})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("dt",{children:"Area Select"}),e.jsxs("dd",{children:[e.jsx(It,{text:"Ctrl"})," + ",e.jsx(It,{text:"Drag"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-sm text-slate-400 mb-2",children:"Modes"}),e.jsx("dl",{className:"space-y-2 text-sm text-slate-300",children:A.map(j=>e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("dt",{children:j.desc}),e.jsx("dd",{children:e.jsx(It,{text:j.key})})]},j.key))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-sm text-slate-400 mb-2",children:"Tag Creation"}),e.jsxs("dl",{className:"space-y-2 text-sm text-slate-300",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("dt",{children:["Create ",e.jsx("span",{className:"text-orange-400 font-semibold",children:"Equipment"})," Tag"]}),e.jsx("dd",{children:e.jsx(It,{text:"1"})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("dt",{children:["Create ",e.jsx("span",{className:"text-rose-400 font-semibold",children:"Line"})," Tag"]}),e.jsx("dd",{children:e.jsx(It,{text:"2"})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("dt",{children:["Create ",e.jsx("span",{className:"text-purple-400 font-semibold",children:"Special Item"})," Tag"]}),e.jsx("dd",{children:e.jsx(It,{text:"3"})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("dt",{children:["Create ",e.jsx("span",{className:"text-amber-400 font-semibold",children:"Instrument"})," Tag"]}),e.jsx("dd",{children:e.jsx(It,{text:"4"})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("dt",{children:["Create ",e.jsx("span",{className:"text-teal-400 font-semibold",children:"Note/Hold"})," Tag"]}),e.jsx("dd",{children:e.jsx(It,{text:"5"})})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-sm text-slate-400 mb-2",children:"Actions"}),e.jsx("dl",{className:"space-y-2 text-sm text-slate-300",children:C.map(j=>e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("dt",{children:j.desc}),e.jsx("dd",{children:e.jsx(It,{text:j.key})})]},j.key))})]})]})]})},wn=({onClose:o,visibilitySettings:c,toggleTagVisibility:A,toggleRelationshipVisibility:C,toggleAllTags:j,toggleAllRelationships:N,updateVisibilitySettings:U,showAllRelationships:L,setShowAllRelationships:v,showOnlySelectedRelationships:Y,setShowOnlySelectedRelationships:H})=>{const se=t.useRef(null);t.useEffect(()=>{const ie=fe=>{se.current&&!se.current.contains(fe.target)&&o()};return setTimeout(()=>document.addEventListener("mousedown",ie),0),()=>document.removeEventListener("mousedown",ie)},[o]);const Q=Object.values(c.tags).every(Boolean),O=Object.values(c.relationships).every(Boolean),_=({checked:ie,onChange:fe,label:ne})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-slate-300",children:ne}),e.jsx("button",{onClick:()=>fe(!ie),className:`relative inline-flex h-4 w-8 items-center rounded-full transition-colors ${ie?"bg-sky-600":"bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-3 w-3 transform rounded-full bg-white transition-transform ${ie?"translate-x-4":"translate-x-0.5"}`})})]});return e.jsxs("div",{ref:se,className:"absolute top-16 right-4 z-20 w-80 bg-slate-800/90 backdrop-blur-sm border border-slate-700 rounded-lg shadow-xl p-4 text-white animate-fade-in-up",style:{animationDuration:"0.2s"},children:[e.jsx("h3",{className:"text-md font-bold mb-3 border-b border-slate-600 pb-2",children:"Visibility Controls"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-sm text-slate-400",children:"Tags"}),e.jsx("button",{onClick:j,className:"text-xs text-sky-400 hover:text-sky-300",children:Q?"Hide All":"Show All"})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsx(_,{checked:c.tags.equipment,onChange:()=>A("equipment"),label:"Equipment"}),e.jsx(_,{checked:c.tags.line,onChange:()=>A("line"),label:"Line"}),e.jsx(_,{checked:c.tags.specialItem,onChange:()=>A("specialItem"),label:"Special Item"}),e.jsx(_,{checked:c.tags.instrument,onChange:()=>A("instrument"),label:"Instrument"}),e.jsx(_,{checked:c.tags.drawingNumber,onChange:()=>A("drawingNumber"),label:"Drawing Number"}),e.jsx(_,{checked:c.tags.notesAndHolds,onChange:()=>A("notesAndHolds"),label:"Notes & Holds"})]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold text-sm text-slate-400 mb-2 flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Annotations & Specs"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsx(_,{checked:c.descriptions,onChange:()=>U({descriptions:!c.descriptions}),label:"Descriptions (Notes & Holds)"}),e.jsx(_,{checked:c.equipmentShortSpecs,onChange:()=>U({equipmentShortSpecs:!c.equipmentShortSpecs}),label:"Equipment Short Specs"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-sm text-slate-400",children:"Relationships"}),e.jsx("button",{onClick:N,className:"text-xs text-sky-400 hover:text-sky-300",children:O?"Hide All":"Show All"})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsx(_,{checked:c.relationships.connection,onChange:()=>C("connection"),label:"Connection"}),e.jsx(_,{checked:c.relationships.installation,onChange:()=>C("installation"),label:"Installation"}),e.jsx(_,{checked:c.relationships.annotation,onChange:()=>C("annotation"),label:"Annotation"}),e.jsx(_,{checked:c.relationships.note,onChange:()=>C("note"),label:"Note"})]})]}),e.jsxs("div",{className:"bg-slate-900/50 rounded-lg p-3 border border-slate-600",children:[e.jsxs("h4",{className:"font-semibold text-sm text-amber-400 mb-2 flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),"Performance"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsx(_,{checked:L,onChange:v,label:"Show Relationship Lines"}),L&&e.jsxs("div",{className:"ml-4 border-l border-slate-600 pl-3",children:[e.jsx(_,{checked:Y,onChange:H,label:"Smart Mode (Selected Tags Only)"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Shows only relationships connected to selected tags for better performance"})]})]})]})]})]})},Nn=({onReset:o,hasData:c,onOpenSettings:A,onImportProject:C,onExportProject:j,pdfDoc:N,currentPage:U,setCurrentPage:L,scale:v,setScale:Y,mode:H,onToggleSidePanel:se,onToggleOPCPanel:Q,onAutoLinkDescriptions:O,onAutoLinkNotesAndHolds:_,onAutoLinkEquipmentShortSpecs:ie,onAutoLinkAll:fe,onRemoveWhitespace:ne,visibilitySettings:ye,updateVisibilitySettings:K,toggleTagVisibility:te,toggleRelationshipVisibility:z,toggleAllTags:T,toggleAllRelationships:F,showConfirmation:R,showAllRelationships:M,setShowAllRelationships:Z,showOnlySelectedRelationships:xe,setShowOnlySelectedRelationships:p})=>{const le=t.useRef(null),[oe,ge]=t.useState(!1),[We,Be]=t.useState(!1);t.useEffect(()=>{const D=()=>{Be(ue=>!ue)},he=ue=>{const we=ue.target;we.tagName==="INPUT"||we.tagName==="TEXTAREA"||we.tagName==="SELECT"||ue.key==="/"&&(ue.preventDefault(),ge(y=>!y))};return window.addEventListener("toggleVisibilityPanel",D),window.addEventListener("keydown",he),()=>{window.removeEventListener("toggleVisibilityPanel",D),window.removeEventListener("keydown",he)}},[]);const je=D=>{D.target.files&&D.target.files[0]&&(C(D.target.files[0]),D.target.value=null)};return e.jsxs("header",{className:"relative flex-shrink-0 bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 p-2 z-50",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 lg:h-8 lg:w-8 text-sky-400",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("path",{d:"M14 2v6h6"}),e.jsx("circle",{cx:"12",cy:"15",r:"2"}),e.jsx("path",{d:"M12 10v3"}),e.jsx("path",{d:"m15 12-1.5 2.6"}),e.jsx("path",{d:"m9 12 1.5 2.6"})]}),e.jsx("h1",{className:"text-lg lg:text-xl font-bold text-white tracking-tight hidden sm:inline",children:"P&ID Smart Digitizer"}),e.jsx("h1",{className:"text-lg font-bold text-white tracking-tight sm:hidden",children:"P&ID"}),c&&e.jsx("button",{onClick:se,className:"p-1.5 rounded-md text-slate-400 hover:bg-slate-700 hover:text-white transition-colors",title:"Toggle Side Panel (S)",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 lg:h-5 lg:w-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"})]})}),c&&e.jsx("button",{onClick:Q,className:"p-1.5 rounded-md text-slate-400 hover:bg-slate-700 hover:text-white transition-colors",title:"Toggle OPC Panel (O)",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 lg:h-5 lg:w-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"15",y1:"3",x2:"15",y2:"21"}),e.jsx("circle",{cx:"8",cy:"8",r:"2"}),e.jsx("circle",{cx:"8",cy:"16",r:"2"})]})})]}),c&&e.jsxs("div",{className:"flex items-center gap-2",children:[N&&e.jsxs("div",{className:"bg-slate-800/80 p-1 rounded-xl shadow-lg flex items-center gap-2",children:[e.jsx("button",{onClick:()=>L(Math.max(1,U-1)),disabled:U===1,className:"px-2 py-1 bg-slate-700 rounded disabled:opacity-50 hover:bg-slate-600 transition-colors text-sm",children:"←"}),e.jsxs("span",{className:"text-sm whitespace-nowrap",children:["Page ",U,"/",N.numPages]}),e.jsx("button",{onClick:()=>L(Math.min(N.numPages,U+1)),disabled:U===N.numPages,className:"px-2 py-1 bg-slate-700 rounded disabled:opacity-50 hover:bg-slate-600 transition-colors text-sm",children:"→"})]}),e.jsxs("div",{className:"bg-slate-800/80 p-1 rounded-xl shadow-lg flex items-center gap-1",children:[e.jsx("span",{className:"text-xs text-slate-300 hidden sm:inline",children:"Mode:"}),e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-semibold ${H==="select"?"bg-slate-600":H==="connect"?"bg-blue-500":"bg-green-500"}`,children:H})]})]}),c&&e.jsxs("div",{className:"bg-slate-800/80 p-1 rounded-xl shadow-lg flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-xs text-slate-300 hidden sm:inline",children:"Zoom:"}),e.jsx("button",{onClick:()=>Y(D=>Math.max(.25,D-.25)),className:"px-2 py-0.5 bg-slate-700 rounded hover:bg-slate-600 transition-colors text-sm",children:"-"}),e.jsxs("span",{className:"w-12 text-center text-xs font-semibold text-white",children:[(v*100).toFixed(0),"%"]}),e.jsx("button",{onClick:()=>Y(D=>D+.25),className:"px-2 py-0.5 bg-slate-700 rounded hover:bg-slate-600 transition-colors text-sm",children:"+"})]}),e.jsx("div",{className:"h-6 w-px bg-slate-600"}),e.jsx("button",{onClick:()=>Be(D=>!D),className:`px-2 py-0.5 rounded transition-colors ${We?"bg-sky-600 text-white hover:bg-sky-500":"bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-slate-300"}`,title:"Toggle visibility controls (V)",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})})})]}),c&&e.jsxs("div",{className:"bg-slate-800/80 p-1 rounded-xl shadow-lg flex items-center gap-1",children:[e.jsxs("button",{onClick:fe,className:"flex items-center justify-center space-x-1 bg-green-700 hover:bg-green-600 text-green-100 font-semibold py-1 px-2 rounded-md transition-colors text-xs whitespace-nowrap",title:"Run all auto-linking functions",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"})}),e.jsx("span",{className:"hidden md:inline",children:"Auto"})]}),e.jsx("button",{onClick:O,className:"flex items-center justify-center bg-sky-700 hover:bg-sky-600 text-sky-100 font-semibold py-1 px-2 rounded-md transition-colors text-xs whitespace-nowrap",title:"Auto-link nearby text as descriptions to Instrument tags",children:e.jsx("span",{children:"Inst"})}),e.jsx("button",{onClick:_,className:"flex items-center justify-center bg-purple-700 hover:bg-purple-600 text-purple-100 font-semibold py-1 px-2 rounded-md transition-colors text-xs whitespace-nowrap",title:"Auto-link Note & Hold tags to corresponding descriptions",children:e.jsx("span",{children:"N&H"})}),e.jsx("button",{onClick:ie,className:"flex items-center justify-center bg-orange-700 hover:bg-orange-600 text-orange-100 font-semibold py-1 px-2 rounded-md transition-colors text-xs whitespace-nowrap",title:"Auto-link Equipment tags to Equipment Short Specs",children:e.jsx("span",{children:"Equip"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[c&&e.jsxs("div",{className:"bg-slate-800/80 p-1 rounded-xl shadow-lg flex items-center gap-1",children:[e.jsxs("button",{onClick:ne,className:"flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold py-1 px-2 rounded-md transition-colors text-xs whitespace-nowrap",title:"Remove all whitespace from tags",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5"})}),e.jsx("span",{className:"hidden md:inline ml-1",children:"Strip"})]}),e.jsxs("button",{onClick:()=>{var D;return(D=le.current)==null?void 0:D.click()},className:"flex items-center bg-slate-600 hover:bg-slate-700 text-white font-semibold py-1 px-2 rounded-md transition-colors text-xs whitespace-nowrap",title:"Import project data",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),e.jsx("span",{className:"hidden md:inline ml-1",children:"Import"})]}),e.jsx("input",{type:"file",ref:le,className:"hidden",accept:".json,application/json",onChange:je}),e.jsxs("button",{onClick:j,className:"flex items-center bg-slate-600 hover:bg-slate-700 text-white font-semibold py-1 px-2 rounded-md transition-colors text-xs whitespace-nowrap",title:"Export project data",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{className:"hidden md:inline ml-1",children:"Export"})]})]}),e.jsx("button",{onClick:A,className:"p-2 text-sm font-semibold text-white bg-slate-600 rounded-md hover:bg-slate-700 transition-colors",title:"Settings",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z",clipRule:"evenodd"})})}),e.jsx("button",{onClick:D=>{D.stopPropagation(),ge(he=>!he)},className:"p-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors",title:"Help & Hotkeys (/)",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("a",{href:Hs.NOTION_GUIDE,target:"_blank",rel:"noopener noreferrer",className:"p-2 text-sm font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors",title:"User Guide & Feedback",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),c&&e.jsx("button",{onClick:()=>{R("Are you sure you want to reset everything? This will remove all extracted tags, relationships, comments, and project data. This action cannot be undone.",o)},className:"p-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors",title:"Reset All Data",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})]}),oe&&e.jsx(vn,{onClose:()=>ge(!1)}),We&&e.jsx(wn,{onClose:()=>Be(!1),visibilitySettings:ye,toggleTagVisibility:te,toggleRelationshipVisibility:z,toggleAllTags:T,toggleAllRelationships:F,updateVisibilitySettings:K,showAllRelationships:M,setShowAllRelationships:Z,showOnlySelectedRelationships:xe,setShowOnlySelectedRelationships:p})]})},kn=({patterns:o,tolerances:c,appSettings:A,colorSettings:C,onSaveOnly:j,onSaveAndRescan:N,onClose:U})=>{const[L,v]=t.useState(o),[Y,H]=t.useState(c),[se,Q]=t.useState(A),[O,_]=t.useState(C||et),[ie,fe]=t.useState(!1),[ne,ye]=t.useState("patterns");t.useEffect(()=>{const p=le=>{le.key==="Escape"&&U()};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[U]);const K=()=>{j(L,Y,se,O)},te=()=>{N(L,Y,se,O,ne)},z=()=>{ne==="patterns"?(v(os),H(is),Q(cs)):_(et)},T=(p,le)=>{v(oe=>({...oe,[p]:le}))},F=(p,le)=>{v(oe=>({...oe,[a.Instrument]:{...oe[a.Instrument],[p]:le}}))},R=(p,le)=>{const oe=parseInt(le,10);!isNaN(oe)&&oe>=0&&H(ge=>({...ge,[a.Instrument]:{...ge[a.Instrument],[p]:oe}}))},M={[a.Equipment]:{description:"Regular expression pattern for matching equipment tags."},[a.Line]:{description:"Regular expression pattern for matching piping line tags."},[a.Instrument]:{description:"Two-part pattern for matching instrument tags consisting of function and number components."},[a.DrawingNumber]:{description:"Pattern for identifying drawing numbers. Only one match per page, selected from bottom-right corner."},[a.NotesAndHolds]:{description:"Pattern for matching note and hold annotations."},[a.SpecialItem]:{description:"Custom pattern for matching special items."},[a.OffPageConnector]:{description:"Pattern for matching off-page connector reference numbers (e.g., A, B, 1, 2, A1, B2)."}},Z=Y[a.Instrument]||{vertical:0,horizontal:0,autoLinkDistance:50},xe=Y[a.OffPageConnector]||{vertical:0,horizontal:0,autoLinkDistance:30};return e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in-up",style:{animationDuration:"0.2s"},onClick:U,children:e.jsxs("div",{className:"bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-7xl text-white",onClick:p=>p.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-slate-700 flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-bold",children:"Settings"}),e.jsx("button",{onClick:U,className:"p-1 rounded-full text-slate-400 hover:bg-slate-700",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"flex border-b border-slate-700",children:[e.jsx("button",{onClick:()=>ye("patterns"),className:`px-6 py-3 text-sm font-medium transition-colors ${ne==="patterns"?"text-white border-b-2 border-sky-500 bg-slate-900/30":"text-slate-400 hover:text-slate-200"}`,children:"Patterns & Settings"}),e.jsx("button",{onClick:()=>ye("colors"),className:`px-6 py-3 text-sm font-medium transition-colors ${ne==="colors"?"text-white border-b-2 border-sky-500 bg-slate-900/30":"text-slate-400 hover:text-slate-200"}`,children:"Colors & Themes"})]}),e.jsx("div",{className:"p-6 space-y-4 max-h-[70vh] overflow-y-auto",children:ne==="patterns"?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-200",children:"Regex Patterns"}),e.jsx("a",{href:Hs.REGEX_HELPER,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center w-5 h-5 bg-sky-500/20 hover:bg-sky-500/30 rounded-full text-sky-400 hover:text-sky-300 transition-colors",title:"Open Regex Helper (External Link)",children:e.jsx("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-4",children:[(()=>{const p=M[a.Equipment];return e.jsxs("div",{className:"p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("label",{htmlFor:`pattern-${a.Equipment}`,className:"block text-sm font-semibold mb-2 text-slate-200",children:"Equipment"}),e.jsx("input",{id:`pattern-${a.Equipment}`,type:"text",value:L[a.Equipment],onChange:le=>T(a.Equipment,le.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md p-3 text-sm font-mono focus:ring-sky-500 focus:border-sky-500",placeholder:"Enter regex pattern for Equipment..."}),p&&e.jsx("div",{className:"mt-2 text-xs text-slate-400",children:e.jsx("p",{children:p.description})})]},a.Equipment)})(),e.jsxs("div",{className:"p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-semibold mb-3 text-slate-200",children:"Line & Special Item Patterns"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"pattern-Line",className:"block text-xs font-medium text-slate-300 mb-1",children:"Line"}),e.jsx("input",{id:"pattern-Line",type:"text",value:L[a.Line],onChange:p=>T(a.Line,p.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm font-mono focus:ring-sky-500 focus:border-sky-500",placeholder:"Enter regex pattern for Line..."}),e.jsx("div",{className:"mt-1 text-xs text-slate-400",children:e.jsx("p",{children:M[a.Line].description})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pattern-SpecialItem",className:"block text-xs font-medium text-slate-300 mb-1",children:"Special Item"}),e.jsx("input",{id:"pattern-SpecialItem",type:"text",value:L[a.SpecialItem],onChange:p=>T(a.SpecialItem,p.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm font-mono focus:ring-sky-500 focus:border-sky-500",placeholder:"Enter regex pattern for Special Item..."}),e.jsx("div",{className:"mt-1 text-xs text-slate-400",children:e.jsx("p",{children:M[a.SpecialItem].description})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pattern-OffPageConnector",className:"block text-xs font-medium text-slate-300 mb-1",children:"OPC Reference"}),e.jsx("input",{id:"pattern-OffPageConnector",type:"text",value:L[a.OffPageConnector],onChange:p=>T(a.OffPageConnector,p.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm font-mono focus:ring-sky-500 focus:border-sky-500",placeholder:"Enter regex pattern for OPC Reference..."}),e.jsx("div",{className:"mt-1 text-xs text-slate-400",children:e.jsx("p",{children:M[a.OffPageConnector].description})})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{var le,oe;const p=M[a.Instrument];return e.jsxs("div",{className:"p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-semibold mb-2 text-slate-200",children:"Instrument"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pattern-inst-func",className:"block text-xs font-medium text-slate-400 mb-1",children:"Function Part"}),e.jsx("input",{id:"pattern-inst-func",type:"text",value:((le=L[a.Instrument])==null?void 0:le.func)||"",onChange:ge=>F("func",ge.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm font-mono focus:ring-sky-500 focus:border-sky-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pattern-inst-num",className:"block text-xs font-medium text-slate-400 mb-1",children:"Number Part"}),e.jsx("input",{id:"pattern-inst-num",type:"text",value:((oe=L[a.Instrument])==null?void 0:oe.num)||"",onChange:ge=>F("num",ge.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm font-mono focus:ring-sky-500 focus:border-sky-500"})]})]}),p&&e.jsx("div",{className:"mt-3 text-xs text-slate-400",children:e.jsx("p",{children:p.description})})]},a.Instrument)})(),(()=>{const p=M[a.NotesAndHolds];return e.jsxs("div",{className:"p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("label",{htmlFor:`pattern-${a.NotesAndHolds}`,className:"block text-sm font-semibold mb-2 text-slate-200",children:"Notes And Holds"}),e.jsx("input",{id:`pattern-${a.NotesAndHolds}`,type:"text",value:L[a.NotesAndHolds],onChange:le=>T(a.NotesAndHolds,le.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md p-3 text-sm font-mono focus:ring-sky-500 focus:border-sky-500",placeholder:"Enter regex pattern for Notes And Holds..."}),p&&e.jsx("div",{className:"mt-2 text-xs text-slate-400",children:e.jsx("p",{children:p.description})})]},a.NotesAndHolds)})(),(()=>{const p=M[a.DrawingNumber];return e.jsxs("div",{className:"p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("label",{htmlFor:`pattern-${a.DrawingNumber}`,className:"block text-sm font-semibold mb-2 text-slate-200",children:"Drawing Number"}),e.jsx("input",{id:`pattern-${a.DrawingNumber}`,type:"text",value:L[a.DrawingNumber],onChange:le=>T(a.DrawingNumber,le.target.value),className:"w-full bg-slate-900 border border-slate-600 rounded-md p-3 text-sm font-mono focus:ring-sky-500 focus:border-sky-500",placeholder:"Enter regex pattern for Drawing Number..."}),p&&e.jsx("div",{className:"mt-2 text-xs text-slate-400",children:e.jsx("p",{children:p.description})})]},a.DrawingNumber)})()]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-slate-200",children:"Application Settings"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-5 bg-slate-900/40 rounded-lg border border-slate-700/50",children:e.jsxs("div",{className:"flex items-start space-x-3 mb-3",children:[e.jsx("input",{id:"auto-generate-loops",type:"checkbox",checked:se.autoGenerateLoops,onChange:p=>Q(le=>({...le,autoGenerateLoops:p.target.checked})),className:"w-5 h-5 mt-0.5 text-sky-600 bg-slate-900 border-slate-600 rounded focus:ring-sky-500 focus:ring-2"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"auto-generate-loops",className:"text-sm font-semibold text-slate-200 block",children:"Auto-generate loops"}),e.jsx("div",{className:"text-xs text-slate-400 mt-1",children:"Automatically create loops from instrument tags based on function prefix and number matching after PDF processing completes."})]})]})}),e.jsx("div",{className:"p-5 bg-slate-900/40 rounded-lg border border-slate-700/50",children:e.jsxs("div",{className:"flex items-start space-x-3 mb-3",children:[e.jsx("input",{id:"auto-remove-whitespace",type:"checkbox",checked:se.autoRemoveWhitespace,onChange:p=>Q(le=>({...le,autoRemoveWhitespace:p.target.checked})),className:"w-5 h-5 mt-0.5 text-sky-600 bg-slate-900 border-slate-600 rounded focus:ring-sky-500 focus:ring-2"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"auto-remove-whitespace",className:"text-sm font-semibold text-slate-200 block",children:"Auto-remove whitespace"}),e.jsx("div",{className:"text-xs text-slate-400 mt-1",children:"Automatically removes all whitespace from extracted tags (except Notes & Holds tags which preserve original formatting)."})]})]})}),e.jsxs("div",{className:"p-5 bg-slate-900/40 rounded-lg border border-slate-700/50",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-slate-200 mb-1",children:"Hyphen Settings for Multi-Text Tags"}),e.jsx("div",{className:"text-xs text-slate-400 mb-3",children:"When creating tags from multiple text pieces, choose which categories should use hyphens (-) as separators."})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[{key:"equipment",label:"Equipment",color:"text-orange-400"},{key:"line",label:"Line",color:"text-rose-400"},{key:"instrument",label:"Instrument",color:"text-amber-400"},{key:"drawingNumber",label:"Drawing Number",color:"text-indigo-400"},{key:"notesAndHolds",label:"Notes & Holds",color:"text-teal-400"},{key:"specialItem",label:"Special Item",color:"text-purple-400"},{key:"offPageConnector",label:"OPC Tag",color:"text-violet-400"}].map(({key:p,label:le,color:oe})=>{var ge;return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{id:`hyphen-${p}`,type:"checkbox",checked:((ge=se.hyphenSettings)==null?void 0:ge[p])||!1,onChange:We=>{Q(Be=>({...Be,hyphenSettings:{...Be.hyphenSettings||{},[p]:We.target.checked}}))},className:"w-4 h-4 text-sky-600 bg-slate-900 border-slate-600 rounded focus:ring-sky-500 focus:ring-2"}),e.jsx("label",{htmlFor:`hyphen-${p}`,className:`text-sm ${oe} select-none cursor-pointer`,children:le})]},p)})})]}),e.jsxs("div",{className:"p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-medium text-slate-200 mb-3",children:"Instrument Tolerances"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"tolerance-vertical",className:"block text-xs text-slate-400 mb-1",children:["Max Vertical Distance (",Z.vertical,"px)"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{id:"tolerance-vertical",type:"range",min:"0",max:"100",value:Z.vertical,onChange:p=>R("vertical",p.target.value),className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"}),e.jsx("input",{type:"number",value:Z.vertical,onChange:p=>R("vertical",p.target.value),className:"w-16 bg-slate-900 border border-slate-600 rounded-md p-1 text-sm text-center"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"tolerance-horizontal",className:"block text-xs text-slate-400 mb-1",children:["Max Horizontal Distance (",Z.horizontal,"px)"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{id:"tolerance-horizontal",type:"range",min:"0",max:"100",value:Z.horizontal,onChange:p=>R("horizontal",p.target.value),className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"}),e.jsx("input",{type:"number",value:Z.horizontal,onChange:p=>R("horizontal",p.target.value),className:"w-16 bg-slate-900 border border-slate-600 rounded-md p-1 text-sm text-center"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"tolerance-autolink",className:"block text-xs text-slate-400 mb-1",children:["Max Link Distance (",Z.autoLinkDistance,"px)"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{id:"tolerance-autolink",type:"range",min:"0",max:"200",value:Z.autoLinkDistance,onChange:p=>R("autoLinkDistance",p.target.value),className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"}),e.jsx("input",{type:"number",min:"0",max:"200",value:Z.autoLinkDistance,onChange:p=>R("autoLinkDistance",p.target.value),className:"w-16 bg-slate-900 border border-slate-600 rounded-md p-1 text-sm text-center"})]})]})]})]}),e.jsxs("div",{className:"p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-medium text-slate-200 mb-3",children:"OPC Tolerances"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"tolerance-opc-vertical",className:"block text-xs text-slate-400 mb-1",children:["Max Vertical Distance (",xe.vertical,"px)"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{id:"tolerance-opc-vertical",type:"range",min:"0",max:"100",value:xe.vertical,onChange:p=>{H(le=>({...le,[a.OffPageConnector]:{...xe,vertical:parseInt(p.target.value)}}))},className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"}),e.jsx("input",{type:"number",value:xe.vertical,onChange:p=>{H(le=>({...le,[a.OffPageConnector]:{...xe,vertical:parseInt(p.target.value)||0}}))},className:"w-16 bg-slate-900 border border-slate-600 rounded-md p-1 text-sm text-center"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"tolerance-opc-horizontal",className:"block text-xs text-slate-400 mb-1",children:["Max Horizontal Distance (",xe.horizontal,"px)"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{id:"tolerance-opc-horizontal",type:"range",min:"0",max:"100",value:xe.horizontal,onChange:p=>{H(le=>({...le,[a.OffPageConnector]:{...xe,horizontal:parseInt(p.target.value)}}))},className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"}),e.jsx("input",{type:"number",min:"0",max:"100",value:xe.horizontal,onChange:p=>{H(le=>({...le,[a.OffPageConnector]:{...xe,horizontal:parseInt(p.target.value)||0}}))},className:"w-16 bg-slate-900 border border-slate-600 rounded-md p-1 text-sm text-center"})]})]})]})]})]})]})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-2 text-sm text-slate-400 bg-slate-900/50 p-3 rounded-md border border-slate-700",children:e.jsx("p",{children:"Customize colors for different tag categories and relationship types. Click on a color to change it."})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold mb-3 text-slate-200",children:"Entity Colors"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:Object.entries({equipment:"Equipment Tag",line:"Line Tag",instrument:"Instrument Tag",drawingNumber:"Drawing Number",notesAndHolds:"Notes & Holds Tag",specialItem:"Special Item Tag",offPageConnector:"OPC Tag",description:"Note/Hold Description",equipmentShortSpec:"Equipment Short Spec",uncategorized:"Uncategorized"}).map(([p,le])=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("label",{className:"text-sm text-slate-200",children:le}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"color",value:O.entities[p],onChange:oe=>_(ge=>({...ge,entities:{...ge.entities,[p]:oe.target.value}})),className:"w-10 h-10 rounded cursor-pointer border border-slate-600"}),e.jsx("input",{type:"text",value:O.entities[p],onChange:oe=>_(ge=>({...ge,entities:{...ge.entities,[p]:oe.target.value}})),className:"w-24 bg-slate-900 border border-slate-600 rounded-md px-2 py-1 text-xs font-mono"})]})]},p))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold mb-3 text-slate-200",children:"Relationship Line Colors"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:Object.entries({connection:"Connection Arrow",installation:"Installation Arrow",annotation:"Annotation Line & Linked Text",note:"Note Relationship Line"}).map(([p,le])=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("label",{className:"text-sm text-slate-200",children:le}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"color",value:O.relationships[p],onChange:oe=>_(ge=>({...ge,relationships:{...ge.relationships,[p]:oe.target.value}})),className:"w-10 h-10 rounded cursor-pointer border border-slate-600"}),e.jsx("input",{type:"text",value:O.relationships[p],onChange:oe=>_(ge=>({...ge,relationships:{...ge.relationships,[p]:oe.target.value}})),className:"w-24 bg-slate-900 border border-slate-600 rounded-md px-2 py-1 text-xs font-mono"})]})]},p))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold mb-3 text-slate-200",children:"Highlight Colors"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:Object.entries({primary:"Primary Selection/Ping Highlight",note:"Note-Related Item Highlight",equipment:"Equipment-Related Item Highlight",description:"Description Item Highlight",related:"Related Tag Highlight",noteRelated:"Legacy Note-Related Highlight",selected:"Legacy Selected Item Border"}).map(([p,le])=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-900/30 rounded-lg",children:[e.jsx("label",{className:"text-sm text-slate-200",children:le}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"color",value:O.highlights[p],onChange:oe=>_(ge=>({...ge,highlights:{...ge.highlights,[p]:oe.target.value}})),className:"w-10 h-10 rounded cursor-pointer border border-slate-600"}),e.jsx("input",{type:"text",value:O.highlights[p],onChange:oe=>_(ge=>({...ge,highlights:{...ge.highlights,[p]:oe.target.value}})),className:"w-24 bg-slate-900 border border-slate-600 rounded-md px-2 py-1 text-xs font-mono"})]})]},p))})]})]})}),e.jsxs("div",{className:"p-4 border-t border-slate-700 flex justify-between items-center",children:[e.jsx("button",{onClick:z,className:"px-4 py-2 text-sm font-semibold text-white bg-slate-600 rounded-md hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 focus:ring-offset-slate-800",children:"Reset to Defaults"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:U,className:"px-4 py-2 text-sm font-semibold text-slate-300 bg-transparent rounded-md hover:bg-slate-700 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:K,className:"px-4 py-2 text-sm font-semibold text-white bg-sky-600 rounded-md hover:bg-sky-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-slate-800",children:"Save"}),ne==="patterns"&&e.jsx("button",{onClick:te,className:"px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-slate-800",children:"Save and Re-scan"})]})]})]})})};class ds extends t.Component{constructor(c){super(c),this.handleRetry=()=>{this.setState({hasError:!1,error:void 0,errorInfo:void 0})},this.handleReload=()=>{window.location.reload()},this.state={hasError:!1}}static getDerivedStateFromError(c){return{hasError:!0,error:c}}componentDidCatch(c,A){this.setState({error:c,errorInfo:A})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsx("div",{className:"flex items-center justify-center min-h-screen p-4 bg-slate-900",children:e.jsxs("div",{className:"bg-red-900/20 border border-red-500 rounded-lg p-6 max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("svg",{className:"w-6 h-6 text-red-500 mr-3",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("h2",{className:"text-xl font-bold text-red-400",children:"Application Error"})]}),e.jsx("p",{className:"text-red-300 mb-4",children:"Something went wrong while running the application. This error has been logged."}),!1,e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("button",{onClick:this.handleRetry,className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-slate-900",children:"Try Again"}),e.jsx("button",{onClick:this.handleReload,className:"px-4 py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 focus:ring-offset-slate-900",children:"Reload Page"})]})]})}):this.props.children}}const ps=(o,c,A)=>!A||c===a.NotesAndHolds?o:o.replace(/\s+/g,""),ss=(o,c=0,A=0,C=null,j=0)=>{const{transform:N,width:U,height:L}=o,[v,Y,,,H,se]=N,Q=H,O=se,_=Math.atan2(Y,v),ie=L*.2,fe=[{x:0,y:-ie},{x:U,y:-ie},{x:U,y:L},{x:0,y:L}],ne=Math.cos(_),ye=Math.sin(_),K=fe.map(F=>({x:F.x*ne-F.y*ye+Q-c,y:F.x*ye+F.y*ne+O-A})),te=K.map(F=>F.x),z=K.map(F=>F.y),T={x1:Math.min(...te),y1:Math.min(...z),x2:Math.max(...te),y2:Math.max(...z)};if(C&&j===90){const F=C.viewBox||[0,0,C.width,C.height];return F[2],F[3],{x1:T.y1,y1:T.x1,x2:T.y2,y2:T.x2}}else if(C&&j===270){const F=C.viewBox||[0,0,C.width,C.height],R=F[2],M=F[3];return{x1:M-T.y2,y1:R-T.x2,x2:M-T.y1,y2:R-T.x1}}else if(C&&j===180){const F=C.width,R=C.height;return{x1:F-T.x2,y1:R-T.y2,x2:F-T.x1,y2:R-T.y1}}else if(C){const F=C.height;return{x1:T.x1,y1:F-T.y2,x2:T.x2,y2:F-T.y1}}return T},Cn=(o,c)=>{const{width:A,height:C}=o;switch(c){case 0:return{x:A,y:C};case 90:return{x:0,y:C};case 180:return{x:0,y:0};case 270:return{x:C,y:0};default:return{x:A,y:C}}},Sn=async(o,c,A,C,j={autoRemoveWhitespace:!0})=>{const N=await o.getPage(c),U=await N.getTextContent(),L=N.getViewport({scale:1}),v=L.rotation||0,Y=L.viewBox?L.viewBox[0]:0,H=L.viewBox?L.viewBox[1]:0,se=[],Q=[],O=U.items.filter(ne=>"str"in ne&&ne.str.trim()!==""),_=new Set;if(A[a.Instrument]&&A[a.Instrument].func&&A[a.Instrument].num)try{const ne=new RegExp(`^${A[a.Instrument].func}$`),ye=new RegExp(`^${A[a.Instrument].num}$`),K=C[a.Instrument],te=[],z=[];O.forEach((T,F)=>{if(ne.test(T.str)){const R=ss(T,Y,H,L,v);if(te.push({item:T,index:F,bbox:R}),T.str==="TXT"){const M={x:(R.x1+R.x2)/2,y:(R.y1+R.y2)/2}}}else if(ye.test(T.str)){const R=ss(T,Y,H,L,v);if(z.push({item:T,index:F,bbox:R}),T.str==="596B"){const M={x:(R.x1+R.x2)/2,y:(R.y1+R.y2)/2}}}else T.str==="TXT"||T.str});for(const T of te){if(_.has(T.index))continue;let F=null,R=1/0;const M={x:(T.bbox.x1+T.bbox.x2)/2,y:(T.bbox.y1+T.bbox.y2)/2};T.item.str;for(const Z of z){if(_.has(Z.index))continue;const xe={x:(Z.bbox.x1+Z.bbox.x2)/2,y:(Z.bbox.y1+Z.bbox.y2)/2};T.item.str==="TXT"&&Z.item.str;const p=M.y<xe.y;if(T.item.str==="TXT"&&Z.item.str,!p){T.item.str==="TXT"&&Z.item.str;continue}const le=Math.abs(M.x-xe.x),oe=Math.abs(M.y-xe.y);if(T.item.str==="TXT"&&Z.item.str,le<=K.horizontal&&oe<=K.vertical){const ge=le*le+oe*oe;T.item.str==="TXT"&&Z.item.str,ge<R&&(R=ge,F=Z,T.item.str==="TXT"&&Z.item.str)}else T.item.str==="TXT"&&Z.item.str}if(F){const Z=`${T.item.str}-${F.item.str}`,xe=ps(Z,a.Instrument,j.autoRemoveWhitespace),p={x1:Math.min(T.bbox.x1,F.bbox.x1),y1:Math.min(T.bbox.y1,F.bbox.y1),x2:Math.max(T.bbox.x2,F.bbox.x2),y2:Math.max(T.bbox.y2,F.bbox.y2)};se.push({id:Fe(),text:xe,page:c,bbox:p,category:a.Instrument,sourceItems:[{...T.item,id:Fe(),bbox:T.bbox,page:c},{...F.item,id:Fe(),bbox:F.bbox,page:c}]}),_.add(T.index),_.add(F.index)}}}catch{}const ie=[{category:a.Equipment,regex:A[a.Equipment]},{category:a.Line,regex:A[a.Line]},{category:a.NotesAndHolds,regex:A[a.NotesAndHolds]},{category:a.SpecialItem,regex:A[a.SpecialItem]}];for(let ne=0;ne<O.length;ne++){if(_.has(ne))continue;const ye=O[ne];let K=!1;for(const te of ie)if(te.regex)try{const z=new RegExp(te.regex,"gi"),T=ye.str.match(z);if(T){K=!0;for(const F of T){const R=ps(F,te.category,j.autoRemoveWhitespace);se.push({id:Fe(),text:R,page:c,bbox:ss(ye,Y,H,L,v),category:te.category})}}}catch{}K&&_.add(ne)}const fe=A[a.DrawingNumber];if(fe)try{const ne=new RegExp(fe,"i"),ye=Cn(L,v);let K=null,te=1/0;const z=[];for(let T=0;T<O.length;T++){if(_.has(T))continue;const F=O[T],R=F.str.match(ne);if(R){const M=ss(F,Y,H,L,v),Z=ye.x-M.x2;let xe;switch(v){case 0:xe=Math.max(M.y1,M.y2);break;case 90:xe=Math.max(M.y1,M.y2);break;case 180:xe=Math.min(M.y1,M.y2);break;case 270:xe=Math.min(M.y1,M.y2);break;default:xe=Math.max(M.y1,M.y2);break}const p=ye.y-xe,le=Z*Z+p*p,oe=Math.sqrt(le);z.push({item:F,index:T,bbox:M,text:R[0],distance:oe,distanceSq:le,dx:Z,dy:p,targetY:xe,isSelected:!1})}}for(const T of z)T.distanceSq<te&&(te=T.distanceSq,K=T);if(K&&z.forEach(T=>{T.isSelected=T.index===K.index}),z.length>0&&(console.log(`🎯 DRAWING NUMBER DEBUG - Page ${c}`),console.log(`🔄 Page rotation: ${v}°, Right-bottom corner: (${ye.x.toFixed(1)}, ${ye.y.toFixed(1)})`),console.log(`📊 Found ${z.length} candidates:`),[...z].sort((F,R)=>F.distance-R.distance).forEach((F,R)=>{const M=F.isSelected?"🏆 SELECTED:":`${R+1}.`;console.log(`${M} "${F.text}"`),console.log(`   📍 Position: X=${F.bbox.x1.toFixed(1)}-${F.bbox.x2.toFixed(1)}, Y=${F.bbox.y1.toFixed(1)}-${F.bbox.y2.toFixed(1)}`),console.log(`   📏 Distance: ${F.distance.toFixed(2)} (dx=${F.dx.toFixed(1)}, dy=${F.dy.toFixed(1)}, targetY=${F.targetY.toFixed(1)})`)}),console.log("════════════════════════════════════════")),K){const T=ps(K.text,a.DrawingNumber,j.autoRemoveWhitespace);se.push({id:Fe(),text:T,page:c,bbox:K.bbox,category:a.DrawingNumber}),_.add(K.index)}}catch{}if(fe&&A[a.OffPageConnector]){const ne=new RegExp(fe),ye=new RegExp(A[a.OffPageConnector]),K=C[a.OffPageConnector]||{vertical:15,horizontal:20};try{const te=[];for(let z=0;z<O.length;z++){const T=O[z],F=T.str.match(ne);if(F){const R=ss(T,Y,H,L,v);te.push({item:T,index:z,bbox:R,text:F[0],isConsumed:_.has(z)})}}for(const z of te){const T={x:(z.bbox.x1+z.bbox.x2)/2,y:(z.bbox.y1+z.bbox.y2)/2};let F=null,R=1/0;for(let M=0;M<O.length;M++){if(_.has(M)||M===z.index)continue;const Z=O[M],xe=Z.str.match(ye);if(xe){const p=ss(Z,Y,H,L,v),le={x:(p.x1+p.x2)/2,y:(p.y1+p.y2)/2},oe=Math.abs(T.x-le.x),ge=Math.abs(T.y-le.y);if(oe<=K.horizontal&&ge<=K.vertical){const We=oe*oe+ge*ge;We<R&&(R=We,F={item:Z,index:M,bbox:p,text:xe[0]})}}}if(F){const M=ps(F.text,a.OffPageConnector,j.autoRemoveWhitespace);se.push({id:Fe(),text:M,page:c,bbox:F.bbox,category:a.OffPageConnector,sourceItems:[{id:Fe(),text:z.item.str,page:c,bbox:z.bbox},{id:Fe(),text:F.item.str,page:c,bbox:F.bbox}]}),_.add(F.index)}}}catch{}}for(let ne=0;ne<O.length;ne++){if(_.has(ne))continue;const ye=O[ne],K=ss(ye,Y,H,L,v);Q.push({id:Fe(),text:ye.str,page:c,bbox:K})}return{tags:se,rawTextItems:Q}},qs=(o,c)=>{const A=o.filter(N=>N.category===a.OffPageConnector),C=[],j={};return A.forEach(N=>{const U=N.text;j[U]||(j[U]=[]),j[U].push(N)}),Object.entries(j).forEach(([N,U])=>{if(U.length===2){const[L,v]=U;L.page!==v.page&&(C.push({id:Fe(),from:L.id,to:v.id,type:c.OffPageConnection}),C.push({id:Fe(),from:v.id,to:L.id,type:c.OffPageConnection}))}else U.length>2}),C};Us.workerSrc=new URL("/P-ID-Tag-Extractor/pdf.worker.min.mjs",import.meta.url).href;const En=({isOpen:o,message:c,onConfirm:A,onCancel:C})=>o?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 animate-fade-in-up",style:{animationDuration:"0.2s"},onClick:C,children:e.jsxs("div",{className:"bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-md text-white",onClick:j=>j.stopPropagation(),children:[e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Confirm Action"}),e.jsx("div",{className:"text-slate-300 whitespace-pre-line",children:c})]}),e.jsxs("div",{className:"p-4 bg-slate-900/50 rounded-b-xl border-t border-slate-700 flex justify-end items-center space-x-2",children:[e.jsx("button",{onClick:C,className:"px-4 py-2 text-sm font-semibold text-slate-300 bg-transparent rounded-md hover:bg-slate-700 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:A,className:"px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-slate-800",children:"Confirm"})]})]})}):null,Ln=()=>{const[o,c]=t.useState(null),[A,C]=t.useState(null),[j,N]=t.useState([]),[U,L]=t.useState([]),[v,Y]=t.useState([]),[H,se]=t.useState([]),[Q,O]=t.useState([]),[_,ie]=t.useState([]),[fe,ne]=t.useState([]),[ye,K]=t.useState(!1),[te,z]=t.useState({current:0,total:0}),[T,F]=t.useState(!1),[R,M]=t.useState({isOpen:!1,message:"",onConfirm:()=>{}}),[Z,xe]=t.useState(1),[p,le]=t.useState(1.5),[oe,ge]=t.useState("select"),[We,Be]=t.useState(null),[je,D]=t.useState({tags:{equipment:!0,line:!0,instrument:!0,drawingNumber:!0,notesAndHolds:!0,specialItem:!0,offPageConnector:!0},descriptions:!0,equipmentShortSpecs:!0,relationships:{connection:!0,installation:!0,annotation:!1,note:!1,offPageConnection:!1}});Object.values(je.relationships).some(Boolean);const[he,ue]=t.useState(!0),[we,y]=t.useState(!1),[ae,be]=t.useState(!1),[Ne,Ze]=t.useState(null),[Ie,De]=t.useState(()=>localStorage.getItem("pid-tagger-showAllRelationships")!=="false"),[Ue,Oe]=t.useState(()=>localStorage.getItem("pid-tagger-showOnlySelectedRelationships")==="true"),[Ge,_e]=t.useState(()=>{try{const u=localStorage.getItem("pid-tagger-patterns");let d=u?JSON.parse(u):os;if(typeof d=="object"&&d!==null&&!Array.isArray(d)){let x=!1;for(const h in os)d.hasOwnProperty(h)||(d[h]=os[h],x=!0);if(typeof d[a.Instrument]=="string"){const h=d[a.Instrument],m="\\s?",f=h.indexOf(m);f>-1?d[a.Instrument]={func:h.substring(0,f),num:h.substring(f+m.length)}:d[a.Instrument]={func:h,num:""},x=!0}return d}return os}catch{return os}}),[Se,Ve]=t.useState(()=>{try{const u=localStorage.getItem("pid-tagger-tolerances");let d=u?JSON.parse(u):is;return typeof d=="object"&&d!==null&&!Array.isArray(d)?(d[a.Instrument]?d[a.Instrument].hasOwnProperty("autoLinkDistance")||(d[a.Instrument].autoLinkDistance=is[a.Instrument].autoLinkDistance):d[a.Instrument]={...is[a.Instrument]},d):is}catch{return is}}),[ve,Xe]=t.useState(()=>{try{const u=localStorage.getItem("pid-tagger-app-settings");if(u){const d=JSON.parse(u);return{...cs,...d,hyphenSettings:{...cs.hyphenSettings,...d.hyphenSettings||{}}}}return cs}catch{return cs}}),[Ee,k]=t.useState(()=>{var u,d,x,h,m,f,w;try{const W=localStorage.getItem("pid-tagger-color-settings");if(W){const $=JSON.parse(W);if($.tags&&!$.entities)return{entities:{...$.tags,description:((u=$.relationships)==null?void 0:u.description)||et.entities.description,equipmentShortSpec:((d=$.relationships)==null?void 0:d.equipmentShortSpec)||et.entities.equipmentShortSpec},relationships:{connection:((x=$.relationships)==null?void 0:x.connection)||et.relationships.connection,installation:((h=$.relationships)==null?void 0:h.installation)||et.relationships.installation,annotation:((m=$.relationships)==null?void 0:m.annotation)||et.relationships.annotation,note:((f=$.relationships)==null?void 0:f.note)||et.relationships.note},highlights:{noteRelated:((w=$.relationships)==null?void 0:w.noteRelated)||et.highlights.noteRelated,selected:et.highlights.selected}};if($.entities)return $}return et}catch{return et}});t.useEffect(()=>{try{localStorage.setItem("pid-tagger-patterns",JSON.stringify(Ge))}catch{}},[Ge]),t.useEffect(()=>{try{localStorage.setItem("pid-tagger-tolerances",JSON.stringify(Se))}catch{}},[Se]),t.useEffect(()=>{try{localStorage.setItem("pid-tagger-app-settings",JSON.stringify(ve))}catch{}},[ve]),t.useEffect(()=>{try{localStorage.setItem("pid-tagger-color-settings",JSON.stringify(Ee))}catch{}},[Ee]),t.useEffect(()=>{localStorage.setItem("pid-tagger-showAllRelationships",Ie.toString())},[Ie]),t.useEffect(()=>{localStorage.setItem("pid-tagger-showOnlySelectedRelationships",Ue.toString())},[Ue]),t.useEffect(()=>{const u=d=>{const x=d.target;x.tagName==="INPUT"||x.tagName==="TEXTAREA"||x.tagName==="SELECT"||(d.key.toLowerCase()==="s"?(d.preventDefault(),ue(h=>!h)):d.key.toLowerCase()==="o"?(d.preventDefault(),y(h=>!h)):d.key.toLowerCase()==="v"&&(d.preventDefault(),window.dispatchEvent(new CustomEvent("toggleVisibilityPanel"))))};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)},[]),t.useEffect(()=>{if(j.filter(d=>d.category===a.OffPageConnector).length>0){const d=qs(j,J);d.length>0&&Y(x=>[...x.filter(m=>m.type!==J.OffPageConnection),...d])}},[j]);const X=t.useCallback(u=>{Ze(u),setTimeout(()=>Ze(null),100)},[]),ke=(u,d)=>{M({isOpen:!0,message:u,onConfirm:d})},Le=()=>{M({isOpen:!1,message:"",onConfirm:()=>{}}),be(!1)},me=()=>{R.onConfirm(),Le()},Te=t.useCallback(async(u,d,x,h)=>{K(!0),N([]),L([]),Y([]),ne([]),ie([]),O([]),z({current:0,total:u.numPages}),xe(1);try{let m=[],f=[];for(let W=1;W<=u.numPages;W++){const{tags:$,rawTextItems:s}=await Sn(u,W,d,x,ve);m=[...m,...$],f=[...f,...s],z(l=>({...l,current:W}))}N(m),L(f);const w=qs(m,J);Y(w),(h!=null&&h.autoGenerateLoops||ve.autoGenerateLoops)&&setTimeout(()=>{Ft(m)},100)}catch{}finally{K(!1)}},[ve]),Ae=t.useCallback(async u=>{c(u),K(!0),N([]),L([]),Y([]),z({current:0,total:0}),xe(1);try{const d=await u.arrayBuffer(),h=await _s({data:d}).promise;C(h),await Te(h,Ge,Se,ve)}catch{K(!1)}},[Ge,Se,ve,Te]),Je=(u,d,x,h)=>{_e(u),Ve(d),Xe(x),k(h),F(!1),localStorage.setItem("pid-tagger-patterns",JSON.stringify(u)),localStorage.setItem("pid-tagger-tolerances",JSON.stringify(d)),localStorage.setItem("pid-tagger-app-settings",JSON.stringify(x)),localStorage.setItem("pid-tagger-color-settings",JSON.stringify(h))},yt=async(u,d,x,h,m)=>{_e(u),Ve(d),Xe(x),k(h),F(!1),localStorage.setItem("pid-tagger-patterns",JSON.stringify(u)),localStorage.setItem("pid-tagger-tolerances",JSON.stringify(d)),localStorage.setItem("pid-tagger-app-settings",JSON.stringify(x)),localStorage.setItem("pid-tagger-color-settings",JSON.stringify(h)),m==="patterns"&&A&&(v.length>0||fe.length>0||_.length>0||j.some(w=>w.isReviewed)||Q.length>0?ke(`Pattern settings have been changed and require PDF rescanning.

⚠️ Rescanning will delete all manually created content:

• Tag relationships (Connection, Installation, Note, etc.)
• User comments and notes
• Manually created loops
• Tag review status (✓ checkmarks)
• Equipment Short Spec data

✅ Note & Hold descriptions will be preserved.

💡 If you have important work, please Export your project as backup first.

Do you want to continue?`,()=>Te(A,u,d,x)):await Te(A,u,d,x))},Ye=()=>{c(null),C(null),N([]),L([]),Y([]),se([]),O([]),ne([]),K(!1),z({current:0,total:0}),xe(1),le(1.5),ge("select")},ct=t.useCallback(u=>{D(d=>({...d,...u,tags:u.tags?{...d.tags,...u.tags}:d.tags,relationships:u.relationships?{...d.relationships,...u.relationships}:d.relationships}))},[]),tt=t.useCallback(u=>{D(d=>({...d,tags:{...d.tags,[u]:!d.tags[u]}}))},[]),it=t.useCallback(u=>{D(d=>({...d,relationships:{...d.relationships,[u]:!d.relationships[u]}}))},[]),dt=t.useCallback(()=>{const d=!Object.values(je.tags).every(Boolean);D(x=>({...x,tags:{equipment:d,line:d,instrument:d,drawingNumber:d,notesAndHolds:d}}))},[je.tags]),rt=t.useCallback(()=>{const d=!Object.values(je.relationships).every(Boolean);D(x=>({...x,relationships:{connection:d,installation:d,annotation:d,note:d,description:d,equipmentShortSpec:d}}))},[je.relationships]),jt=t.useCallback((u,d)=>{if(!u||u.length===0)return;const x=u[0].page;if(u.some(l=>l.page!==x))return;const h=[...u].sort((l,g)=>{const r=l.bbox.y1-g.bbox.y1;return Math.abs(r)>5?r:l.bbox.x1-g.bbox.x1}),f=(()=>{switch(d){case a.Equipment:return ve.hyphenSettings.equipment;case a.Line:return ve.hyphenSettings.line;case a.Instrument:return ve.hyphenSettings.instrument;case a.DrawingNumber:return ve.hyphenSettings.drawingNumber;case a.NotesAndHolds:return ve.hyphenSettings.notesAndHolds;case a.SpecialItem:return ve.hyphenSettings.specialItem;default:return!1}})()?h.map(l=>l.text).join("-"):h.map(l=>l.text).join(""),w=ve.autoRemoveWhitespace&&d!==a.NotesAndHolds?f.replace(/\s+/g,""):f,W=u.reduce((l,g)=>({x1:Math.min(l.x1,g.bbox.x1),y1:Math.min(l.y1,g.bbox.y1),x2:Math.max(l.x2,g.bbox.x2),y2:Math.max(l.y2,g.bbox.y2)}),{x1:1/0,y1:1/0,x2:-1/0,y2:-1/0}),$={id:Fe(),text:w,page:x,bbox:W,category:d,sourceItems:u};N(l=>[...l,$]);const s=new Set(u.map(l=>l.id));L(l=>l.filter(g=>!s.has(g.id))),Y(l=>l.filter(g=>!(g.type===J.Annotation&&s.has(g.to))))},[ve.autoRemoveWhitespace,ve.hyphenSettings]),St=t.useCallback(u=>{const{text:d,bbox:x,page:h,category:m}=u;if(!d||!x||!h||!m)return;const f=ve.autoRemoveWhitespace&&m!==a.NotesAndHolds?d.replace(/\s+/g,""):d,w={id:Fe(),text:f,page:h,bbox:x,category:m,sourceItems:[]};N(W=>[...W,w])},[ve.autoRemoveWhitespace]),Pt=t.useCallback(u=>{const d=new Set(u),x=j.filter(m=>d.has(m.id)),h=[];for(const m of x)if(m.sourceItems&&m.sourceItems.length>0){const f=m.sourceItems.map(w=>({id:Fe(),text:w.str||w.text,page:m.page,bbox:w.bbox||{x1:w.transform[4],y1:w.transform[5]-w.height,x2:w.transform[4]+w.width,y2:w.transform[5]}}));h.push(...f)}else{const f={id:Fe(),text:m.text,page:m.page,bbox:m.bbox};h.push(f)}N(m=>m.filter(f=>!d.has(f.id))),L(m=>[...m,...h]),Y(m=>m.filter(f=>!d.has(f.from)&&!d.has(f.to))),ne(m=>m.filter(f=>!d.has(f.targetId)))},[j]),ft=t.useCallback(u=>{if(!u||u.length<2)return;const d=U.filter($=>u.includes($.id));if(d.length<2)return;const x=d[0].page;if(d.some($=>$.page!==x))return;const m=[...d].sort(($,s)=>{const l=$.bbox.y1-s.bbox.y1;return Math.abs(l)>5?l:$.bbox.x1-s.bbox.x1}).map($=>$.text).join(" "),f=d.reduce(($,s)=>({x1:Math.min($.x1,s.bbox.x1),y1:Math.min($.y1,s.bbox.y1),x2:Math.max($.x2,s.bbox.x2),y2:Math.max($.y2,s.bbox.y2)}),{x1:1/0,y1:1/0,x2:-1/0,y2:-1/0}),w={id:Fe(),text:m,page:x,bbox:f},W=new Set(u);L($=>[...$.filter(s=>!W.has(s.id)),w]),Y($=>$.filter(s=>!W.has(s.to)))},[U]),st=t.useCallback(u=>{const d=new Set(u);L(x=>x.filter(h=>!d.has(h.id))),Y(x=>x.filter(h=>!d.has(h.to)))},[]),xt=t.useCallback((u,d)=>{N(x=>x.map(h=>h.id===u?{...h,text:d}:h))},[]),Zt=t.useCallback((u,d)=>{L(x=>x.map(h=>h.id===u?{...h,text:d}:h))},[]),vt=t.useCallback((u,d="Note")=>{if(!u||u.length===0)return;const x=[...u].sort((i,E)=>i.bbox.y1-E.bbox.y1),h=x.map(i=>i.text).join(" "),m={x1:Math.min(...x.map(i=>i.bbox.x1)),y1:Math.min(...x.map(i=>i.bbox.y1)),x2:Math.max(...x.map(i=>i.bbox.x2)),y2:Math.max(...x.map(i=>i.bbox.y2))},f=x[0].page,w=d,W=H.filter(i=>i.metadata.type===w&&i.page===f).map(i=>i.metadata.number),$=W.length>0?Math.max(...W)+1:1,s={id:Fe(),text:h,page:x[0].page,bbox:m,sourceItems:x,metadata:{type:w,scope:"Specific",number:$}};se(i=>[...i,s]);const l=i=>{const E=i.match(/\d+/g);return E?E.map(q=>parseInt(q,10)):[]},g=i=>{const E=i.toLowerCase();return E.includes("note")?"Note":E.includes("hold")?"Hold":null},r=j.filter(i=>i.category===a.NotesAndHolds&&i.page===f),b=[];for(const i of r){const E=g(i.text);if(!E||E!==w)continue;l(i.text).includes($)&&(`${i.id}${s.id}`,v.some(Re=>Re.from===i.id&&Re.to===s.id&&Re.type===J.Description)||b.push({id:Fe(),from:i.id,to:s.id,type:J.Description}))}b.length>0&&Y(i=>[...i,...b]);const S=u.filter(i=>"category"in i).map(i=>i.id);S.length>0&&N(i=>i.filter(E=>!S.includes(E.id)));const I=u.filter(i=>!("category"in i)).map(i=>i.id);I.length>0&&L(i=>i.filter(E=>!I.includes(E.id)))},[H,j,v]),Ot=t.useCallback(u=>{vt(u,"Hold")},[vt]),Yt=t.useCallback(u=>{if(!u||u.length===0)return;const d=u.filter(G=>"category"in G&&G.category===a.Equipment);if(d.length===0)return;const x=d[0],h=u.filter(G=>!("category"in G));if(h.length===0)return;const m=[...u].sort((G,$e)=>G.bbox.y1-$e.bbox.y1),f=h.sort((G,$e)=>G.bbox.y1-$e.bbox.y1),w=f[0],W=w?w.text:"",$=f.slice(1);let s="",l=null;const g=5;for(let G=0;G<$.length;G++){const $e=$[G],nt=$e.bbox.y1;l!==null&&Math.abs(nt-l)>g?s+=`
`:s.length>0&&!s.endsWith(`
`)&&(s+=" "),s+=$e.text,l=nt}const r={x1:Math.min(...m.map(G=>G.bbox.x1)),y1:Math.min(...m.map(G=>G.bbox.y1)),x2:Math.max(...m.map(G=>G.bbox.x2)),y2:Math.max(...m.map(G=>G.bbox.y2))},b={id:Fe(),text:s,page:m[0].page,bbox:r,sourceItems:m,metadata:{originalEquipmentTag:x,service:W}};O(G=>[...G,b]);const S=G=>{const $e=G.match(/^(.+?)([A-Z](?:\/[A-Z])+|[A-Z])$/);if($e){const nt=$e[1],Rt=$e[2];return{base:nt,suffix:Rt}}return{base:G}},I=(G,$e)=>{const nt=G.metadata.originalEquipmentTag,{base:Rt,suffix:ms}=S(nt.text),js=ms&&ms.includes("/"),Wt=/[A-Z]\/[A-Z]|[A-Z],[A-Z]|[A-Z]\s*&\s*[A-Z]/.test(G.text),vs=js||Wt,ns=[];for(const Jt of $e){const{base:ws,suffix:Ns}=S(Jt.text);if(Jt.text===nt.text){ns.push(Jt);continue}ws===Rt&&Jt.page===G.page&&(vs?ns.push(Jt):Ns||ns.push(Jt))}return ns},i=j.filter(G=>G.category===a.Equipment),E=I(b,i),q=new Set(v.filter(G=>G.type===J.EquipmentShortSpec).map(G=>`${G.from}-${G.to}`)),pe=[];for(const G of E){const $e=`${G.id}-${b.id}`;q.has($e)||(pe.push({id:Fe(),from:G.id,to:b.id,type:J.EquipmentShortSpec}),q.add($e))}pe.length>0&&Y(G=>[...G,...pe]);const Re=d.map(G=>G.id);N(G=>G.filter($e=>!Re.includes($e.id)));const qe=h.filter(G=>!("category"in G)).map(G=>G.id);qe.length>0&&L(G=>G.filter($e=>!qe.includes($e.id)))},[Q,j,v]),gt=t.useCallback(u=>{Q.filter(x=>u.includes(x.id)).forEach(x=>{const h=x.sourceItems.filter(f=>"category"in f&&f.category===a.Equipment);h.length>0&&N(f=>[...f,...h]);const m=x.sourceItems.filter(f=>!("category"in f));m.length>0&&L(f=>[...f,...m])}),O(x=>x.filter(h=>!u.includes(h.id)))},[Q]),wt=t.useCallback((u,d,x)=>{O(h=>h.map(m=>m.id===u?{...m,text:d,...x&&{metadata:x}}:m))},[]),Ht=t.useCallback(u=>{const d=new Set(u);H.filter(h=>d.has(h.id)).forEach(h=>{h.sourceItems.forEach(m=>{"category"in m?N(f=>f.some(W=>W.id===m.id)?f:[...f,m]):L(f=>f.some(W=>W.id===m.id)?f:[...f,m])})}),se(h=>h.filter(m=>!d.has(m.id))),Y(h=>h.filter(m=>!d.has(m.from)&&!d.has(m.to)))},[H]),Kt=t.useCallback((u,d,x)=>{se(h=>{const m=h.find(w=>w.id===u);if(!m)return h;let f=x;if(m.metadata.type!==x.type){const w=h.filter($=>$.id!==u&&$.metadata.type===x.type&&$.page===m.page).map($=>$.metadata.number),W=w.length>0?Math.max(...w)+1:1;f={...x,number:W}}return h.map(w=>w.id===u?{...w,text:d,metadata:f}:w)})},[]),Bt=t.useCallback((u,d,x,h="medium")=>{const m={id:Fe(),targetId:u,targetType:d,content:x,author:"User",timestamp:Date.now(),isResolved:!1,priority:h};ne(f=>[...f,m])},[]),Me=t.useCallback((u,d)=>{ne(x=>x.map(h=>h.id===u?{...h,...d,timestamp:d.content?Date.now():h.timestamp}:h))},[]),Ut=t.useCallback(u=>{ne(d=>d.filter(x=>x.id!==u))},[]);t.useCallback(u=>{ne(d=>d.filter(x=>x.targetId!==u))},[]);const At=t.useCallback(u=>fe.filter(d=>d.targetId===u),[fe]),_t=u=>{if(!u||typeof u!="object")return!1;const d=["pdfFileName","exportDate","tags","relationships","rawTextItems"];for(const x of d)if(!(x in u))return!1;if(!Array.isArray(u.tags)||!Array.isArray(u.relationships)||!Array.isArray(u.rawTextItems)||u.descriptions&&!Array.isArray(u.descriptions))return!1;for(const x of u.tags)if(!x.id||!x.text||!x.page||!x.bbox||!x.category||!x.bbox.hasOwnProperty("x1")||!x.bbox.hasOwnProperty("y1")||!x.bbox.hasOwnProperty("x2")||!x.bbox.hasOwnProperty("y2"))return!1;for(const x of u.relationships)if(!x.id||!x.from||!x.to||!x.type||!Object.values(J).includes(x.type))return!1;for(const x of u.rawTextItems)if(!x.id||!x.text||!x.page||!x.bbox)return!1;return!0},Mt=u=>{const d=x=>x.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/on\w+="[^"]*"/gi,"");return{...u,pdfFileName:d(u.pdfFileName),tags:u.tags.map(x=>({...x,text:d(x.text)})),rawTextItems:u.rawTextItems.map(x=>({...x,text:d(x.text)})),descriptions:(u.descriptions||[]).map(x=>({...x,text:d(x.text)}))}},Tt=t.useCallback(u=>{var x,h,m;if(!_t(u)){alert("Invalid project file structure or corrupted data. Cannot load.");return}const d=Mt(u);N(d.tags),Y(d.relationships),L(d.rawTextItems),se(d.descriptions||[]),O(d.equipmentShortSpecs||[]),ie(d.loops||[]),ne(d.comments||[]),(x=d.settings)!=null&&x.patterns&&_e(d.settings.patterns),(h=d.settings)!=null&&h.tolerances&&Ve(d.settings.tolerances),(m=d.settings)!=null&&m.appSettings&&Xe(d.settings.appSettings)},[]),bt=t.useCallback(async u=>{if(!u||!o){alert("Please open a PDF file before importing a project file.");return}const d=50*1024*1024;if(u.size>d){alert("Project file is too large. Maximum file size is 50MB.");return}if(!u.name.toLowerCase().endsWith(".json")){alert("Please select a valid JSON project file.");return}const x=new FileReader;x.onload=h=>{var m,f;try{const w=(m=h.target)==null?void 0:m.result;if(!w)throw new Error("File content is empty");if(w.includes("<script>")||w.includes("javascript:"))throw new Error("Project file contains potentially malicious content");const W=JSON.parse(w);if(W.pdfFileName!==o.name){const $=((f=W.pdfFileName)==null?void 0:f.replace(/[<>]/g,""))||"Unknown";ke(`This project file seems to be for a different PDF ("${$}"). You currently have "${o.name}" open. Do you want to load the project data anyway?`,()=>Tt(W))}else Tt(W)}catch(w){let W="Could not load project. ";w instanceof SyntaxError?W+="The file contains invalid JSON format.":w.message.includes("malicious")?W+="The file contains potentially unsafe content.":W+="The file might be corrupted or in an invalid format.",alert(W)}},x.onerror=()=>{alert("Error reading file. Please try again.")},x.readAsText(u)},[o,Tt,ke]),Nt=t.useCallback(()=>{if(!o)return;const u={pdfFileName:o.name,exportDate:new Date().toISOString(),tags:j,relationships:v,rawTextItems:U,descriptions:H,equipmentShortSpecs:Q,comments:fe,loops:_,settings:{patterns:Ge,tolerances:Se,appSettings:ve}},d=JSON.stringify(u,null,2),x=new Blob([d],{type:"application/json"}),h=URL.createObjectURL(x),m=document.createElement("a");m.href=h;const f=o.name.replace(/\.pdf$/i,"")+"-project.json";m.download=f,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(h)},[o,j,v,U,Ge,Se]),Ce=(u,d,x)=>{const h=[[x.x1,x.y1],[x.x2,x.y1],[x.x1,x.y2],[x.x2,x.y2],[(x.x1+x.x2)/2,(x.y1+x.y2)/2]];return Math.min(...h.map(([m,f])=>Math.sqrt((u-m)**2+(d-f)**2)))},at=t.useCallback(()=>{var x;const u=(x=Se[a.Instrument])==null?void 0:x.autoLinkDistance;if(typeof u!="number"){alert("Auto-link distance is not configured. Please check your settings.");return}be(!0),setTimeout(()=>{ke(`This will automatically create description links for all Instrument tags based on the current distance setting (${u}px). This may create many relationships. Do you want to proceed?`,()=>{be(!1),d()})},500);const d=()=>{const h=j.filter(W=>W.category===a.Instrument),m=new Set(v.filter(W=>W.type===J.Annotation).map(W=>W.to)),f=U.filter(W=>!m.has(W.id)),w=[];for(const W of f){if(m.has(W.id))continue;const $=h.filter(g=>g.page===W.page);let s=null,l=1/0;for(const g of $){const r={x:(g.bbox.x1+g.bbox.x2)/2,y:(g.bbox.y1+g.bbox.y2)/2},b=Ce(r.x,r.y,W.bbox);b<=u&&b<l&&(l=b,s=g)}s&&(w.push({id:Fe(),from:s.id,to:W.id,type:J.Annotation}),m.add(W.id))}if(w.length>0){const W=new Set(v.map(s=>`${s.from}-${s.to}-${s.type}`)),$=w.filter(s=>!W.has(`${s.from}-${s.to}-${s.type}`));$.length>0?(Y(s=>[...s,...$]),alert(`${$.length} new description link(s) created.`)):alert("No new description links could be found. They may already exist.")}else alert("No new description links could be found with the current settings.")};ke(`This will automatically create description links for all Instrument tags based on the current distance setting (${u}px). This may create many relationships. Do you want to proceed?`,d)},[j,U,v,Se,ke]),ht=t.useCallback(()=>{const u=h=>{const m=h.toLowerCase();return m.includes("note")?"Note":m.includes("hold")?"Hold":null},d=h=>{const m=h.match(/\d+/g);return m?m.map(f=>parseInt(f,10)):[]};ke("This will automatically create links between Note & Hold tags and their corresponding descriptions based on type and number matching. Do you want to proceed?",()=>{const h=j.filter(w=>w.category===a.NotesAndHolds),m=new Set(v.filter(w=>w.type===J.Description).map(w=>`${w.from}-${w.to}`)),f=[];for(const w of h){const W=u(w.text);if(!W)continue;const $=d(w.text);if($.length!==0)for(const s of $){const l=H.filter(g=>g.metadata.type===W&&g.metadata.number===s&&g.metadata.scope==="Specific"&&g.page===w.page);for(const g of l){const r=`${w.id}-${g.id}`;m.has(r)||(f.push({id:Fe(),from:w.id,to:g.id,type:J.Description}),m.add(r))}}}if(f.length>0){const w=new Set(v.map($=>`${$.from}-${$.to}-${$.type}`)),W=f.filter($=>!w.has(`${$.from}-${$.to}-${$.type}`));W.length>0?(Y($=>[...$,...W]),alert(`${W.length} new Note & Hold link(s) created.`)):alert("No new Note & Hold links could be found. They may already exist.")}else alert("No new Note & Hold links could be found with the current data.")})},[j,H,v,ke]),pt=t.useCallback(()=>{const u=h=>{const m=h.match(/^(.+?)([A-Z](?:\/[A-Z])+|[A-Z])$/);if(m){const f=m[1],w=m[2];return{base:f,suffix:w}}return{base:h}},d=(h,m)=>{const f=h.metadata.originalEquipmentTag,{base:w,suffix:W}=u(f.text),$=W&&W.includes("/"),s=/[A-Z]\/[A-Z]|[A-Z],[A-Z]|[A-Z]\s*&\s*[A-Z]/.test(h.text),l=$||s,g=[];for(const r of m){const{base:b,suffix:S}=u(r.text);if(r.text===f.text){g.push(r);continue}b===w&&(l?g.push(r):S||g.push(r))}return g},x=()=>{const h=j.filter(w=>w.category===a.Equipment),m=new Set(v.filter(w=>w.type===J.EquipmentShortSpec).map(w=>`${w.from}-${w.to}`)),f=[];for(const w of Q){const W=d(w,h);for(const $ of W){const s=`${$.id}-${w.id}`;m.has(s)||f.push({id:Fe(),from:$.id,to:w.id,type:J.EquipmentShortSpec})}}f.length>0?(Y(w=>[...w,...f]),alert(`Successfully linked ${f.length} Equipment tag(s) to Equipment Short Spec(s).`)):alert("No new Equipment-Short Spec relationships found to create.")};if(Q.length===0){alert("No Equipment Short Specs available to link.");return}if(j.filter(h=>h.category===a.Equipment).length===0){alert("No Equipment tags available to link.");return}ke("This will automatically create relationships between Equipment tags and Equipment Short Specs. Continue?",x)},[j,Q,v,ke]),Et=t.useCallback(async()=>{ke("This will run all auto-linking functions in sequence: Descriptions, Notes & Holds, and Equipment Short Specs. Continue?",async()=>{try{await new Promise(u=>{(()=>{var W;const x=j.filter($=>$.category===a.Instrument),h=(W=Se[a.Instrument])==null?void 0:W.autoLinkDistance;if(typeof h!="number"||x.length===0){u();return}const m=new Set(v.filter($=>$.type===J.Annotation).map($=>$.to)),f=[],w=U.filter($=>!m.has($.id));for(const $ of w){if(m.has($.id))continue;const s=x.filter(r=>r.page===$.page);let l=null,g=1/0;for(const r of s){const b={x:(r.bbox.x1+r.bbox.x2)/2,y:(r.bbox.y1+r.bbox.y2)/2},S=Ce(b.x,b.y,$.bbox);S<=h&&S<g&&(g=S,l=r)}l&&(f.push({id:Fe(),from:l.id,to:$.id,type:J.Annotation}),m.add($.id))}f.length>0&&Y($=>[...$,...f]),u()})()}),await new Promise(u=>{(()=>{const x=j.filter(f=>f.category===a.NotesAndHolds),h=new Set(v.filter(f=>f.type===J.Description).map(f=>`${f.from}-${f.to}`)),m=[];for(const f of x){const w=f.text.toLowerCase(),W=w.includes("note")?"Note":w.includes("hold")?"Hold":null;if(!W)continue;const $=f.text.match(/\d+/g),s=$?$.map(l=>parseInt(l,10)):[];if(s.length!==0)for(const l of s){const g=H.filter(r=>r.metadata.type===W&&r.metadata.number===l&&r.metadata.scope==="Specific"&&r.page===f.page);for(const r of g){const b=`${f.id}-${r.id}`;h.has(b)||m.push({id:Fe(),from:f.id,to:r.id,type:J.Description})}}}m.length>0&&Y(f=>[...f,...m]),u()})()}),await new Promise(u=>{(()=>{var f,w,W,$;const x=j.filter(s=>s.category===a.Equipment),h=new Set(v.filter(s=>s.type===J.EquipmentShortSpec).map(s=>`${s.from}-${s.to}`)),m=[];for(const s of Q){const l=s.metadata.originalEquipmentTag,g=((f=l.text.match(/^(.+?)([A-Z]\/[A-Z]|[A-Z])?$/))==null?void 0:f[1])||l.text,r=(w=l.text.match(/^(.+?)([A-Z]\/[A-Z]|[A-Z])?$/))==null?void 0:w[2],b=r&&r.includes("/"),S=/[A-Z]\/[A-Z]|[A-Z],[A-Z]|[A-Z]\s*&\s*[A-Z]/.test(s.text),I=b||S;for(const i of x){const E=((W=i.text.match(/^(.+?)([A-Z]\/[A-Z]|[A-Z])?$/))==null?void 0:W[1])||i.text,q=($=i.text.match(/^(.+?)([A-Z]\/[A-Z]|[A-Z])?$/))==null?void 0:$[2];if(i.text===l.text||E===g&&(I||!q)){const pe=`${i.id}-${s.id}`;h.has(pe)||m.push({id:Fe(),from:i.id,to:s.id,type:J.EquipmentShortSpec})}}}m.length>0&&Y(s=>[...s,...m]),u()})()}),alert("All auto-linking completed successfully!")}catch(u){alert("Error during auto-linking: "+u.message)}})},[j,U,H,Q,v,Se,ke]),Gt=t.useCallback(()=>{ke("Are you sure you want to remove all whitespace from Equipment, Line, and Instrument tags? This action cannot be undone.",()=>{const u=j.map(x=>x.category===a.Equipment||x.category===a.Line||x.category===a.Instrument?{...x,text:x.text.replace(/\s/g,"")}:x);N(u);const d=j.filter(x=>(x.category===a.Equipment||x.category===a.Line||x.category===a.Instrument)&&x.text.includes(" ")).length;alert(`Removed whitespace from ${d} Equipment, Line, and Instrument tags.`)})},[j,ke]),Lt=t.useCallback(u=>{const d=u.trim(),x=d.match(/^([A-Z]{1,4})-?(\d+)[\s]*([A-Z]*)$/);if(x)return{function:x[1].trim(),number:parseInt(x[2]),suffix:x[3].trim()};const h=d.match(/^([A-Z]{1,4})(\d+)([A-Z]*)$/);return h?{function:h[1].trim(),number:parseInt(h[2]),suffix:h[3].trim()}:null},[]),Qe=t.useCallback(u=>{if(u.length===0)return null;const d=u[0],x=Lt(d.text);if(!x)return d.text.charAt(0)+"-000";let h=x.function;for(const m of u.slice(1)){const f=Lt(m.text);if(f&&f.number===x.number){let w=0;for(;w<h.length&&w<f.function.length&&h[w]===f.function[w];)w++;h=h.substring(0,w)}}return h.length===0&&(h=x.function.charAt(0)),`${h}-${x.number}`},[Lt]),Ft=t.useCallback(u=>{const d=u.filter(m=>m.category===a.Instrument);if(d.length===0)return;const x=new Map;for(const m of d){const f=Lt(m.text);if(!f)continue;const w=`${f.function.charAt(0)}-${f.number}`;x.has(w)||x.set(w,[]),x.get(w).push(m)}const h=[];x.forEach(m=>{if(m.length>1){const f=Qe(m);if(f){const w={id:f,tagIds:m.map(W=>W.id),createdAt:new Date().toISOString(),isAutoGenerated:!0};h.push(w)}}}),h.length>0&&ie(m=>[...m,...h])},[Lt,Qe]),zt=t.useCallback(u=>{const d=j.filter(x=>x.category===a.Instrument&&(u?x.page===u:!0));if(d.length===0){alert("No instrument tags found to create loops.");return}ke(`This will automatically create loops from ${d.length} instrument tags based on function prefix and number matching. Continue?`,()=>{const x=new Map;for(const w of d){const W=Lt(w.text);if(!W)continue;const $=`${W.function.charAt(0)}-${W.number}`;x.has($)||x.set($,[]),x.get($).push(w)}const h=x,m=[],f=new Set(_.map(w=>w.id));for(const[w,W]of h.entries())if(W.length>1){const $=Qe(W)||w;if(f.has($))continue;m.push({id:$,tagIds:W.map(s=>s.id),createdAt:new Date().toISOString(),isAutoGenerated:!0})}m.length>0?(ie(w=>[...w,...m]),alert(`Created ${m.length} new loops from ${m.reduce((w,W)=>w+W.tagIds.length,0)} instrument tags.`)):alert("No new loops could be created. They may already exist or no matching groups were found.")})},[j,_,Lt,Qe,ke]),lt=t.useCallback(u=>{const d=j.filter(f=>u.includes(f.id)&&f.category===a.Instrument);if(d.length<2){alert("Please select at least 2 instrument tags to create a loop.");return}const x=Qe(d);if(!x){alert("Could not generate loop ID from selected tags.");return}if(_.find(f=>f.id===x)){alert(`Loop "${x}" already exists.`);return}const m={id:x,tagIds:d.map(f=>f.id),createdAt:new Date().toISOString(),isAutoGenerated:!1};ie(f=>[...f,m]),alert(`Created loop "${x}" with ${d.length} instrument tags.`)},[j,_,Qe]),kt=t.useCallback(u=>{ie(d=>d.filter(x=>!u.includes(x.id)))},[]),es=t.useCallback((u,d)=>{ie(x=>x.map(m=>m.id===u?{...m,...d}:m).filter(m=>m.tagIds&&m.tagIds.length>0))},[]),Vt=()=>ye?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-white",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-10 w-10 text-sky-400",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("p",{className:"mt-4 text-lg",children:"Processing PDF..."}),e.jsxs("p",{className:"text-slate-400",children:["Page ",te.current," of ",te.total]})]}):o&&A?e.jsx(ds,{fallback:e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-red-300",children:[e.jsx("p",{className:"mb-4",children:"Error loading workspace. Please try refreshing the page."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Reload"})]})}),children:e.jsx(jn,{pdfDoc:A,tags:j,setTags:N,relationships:v,setRelationships:Y,rawTextItems:U,descriptions:H,setDescriptions:se,equipmentShortSpecs:Q,setEquipmentShortSpecs:O,loops:_,setLoops:ie,onCreateTag:jt,onCreateManualTag:St,onCreateDescription:vt,onCreateHoldDescription:Ot,onCreateEquipmentShortSpec:Yt,onDeleteTags:Pt,onUpdateTagText:xt,onDeleteDescriptions:Ht,onUpdateDescription:Kt,onDeleteEquipmentShortSpecs:gt,onUpdateEquipmentShortSpec:wt,onMergeRawTextItems:ft,onDeleteRawTextItems:st,onUpdateRawTextItemText:Zt,onAutoLinkDescriptions:at,onAutoLinkNotesAndHolds:ht,onAutoLinkEquipmentShortSpecs:pt,onAutoGenerateLoops:zt,onManualCreateLoop:lt,onDeleteLoops:kt,onUpdateLoop:es,showConfirmation:ke,currentPage:Z,setCurrentPage:xe,scale:p,setScale:le,mode:oe,setMode:ge,relationshipStartTag:We,setRelationshipStartTag:Be,visibilitySettings:je,updateVisibilitySettings:ct,showAutoLinkRanges:ae,tolerances:Se,toggleTagVisibility:tt,toggleRelationshipVisibility:it,toggleAllTags:dt,toggleAllRelationships:rt,showAllRelationships:Ie,setShowAllRelationships:De,showOnlySelectedRelationships:Ue,setShowOnlySelectedRelationships:Oe,comments:fe,onCreateComment:Bt,onUpdateComment:Me,onDeleteComment:Ut,getCommentsForTarget:At,isSidePanelVisible:he,isOPCPanelVisible:we,colorSettings:Ee,focusOPCConnection:Ne,onOPCTagClick:X})}):e.jsx(ds,{fallback:e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-red-300",children:[e.jsx("p",{className:"mb-4",children:"Error loading file upload. Please refresh the page."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Reload"})]})}),children:e.jsx(sn,{onFileSelect:Ae})});return e.jsxs("div",{className:"flex flex-col h-screen bg-slate-900 font-sans",children:[e.jsx(ds,{fallback:e.jsx("div",{className:"h-16 bg-slate-800 flex items-center justify-center",children:e.jsx("p",{className:"text-red-300",children:"Error loading header"})}),children:e.jsx(Nn,{onReset:Ye,hasData:!!o,onOpenSettings:()=>F(!0),onImportProject:bt,onExportProject:Nt,pdfDoc:A,currentPage:Z,setCurrentPage:xe,scale:p,setScale:le,mode:oe,onToggleSidePanel:()=>ue(u=>!u),onToggleOPCPanel:()=>y(u=>!u),onAutoLinkDescriptions:at,onAutoLinkNotesAndHolds:ht,onAutoLinkEquipmentShortSpecs:pt,onAutoLinkAll:Et,onRemoveWhitespace:Gt,visibilitySettings:je,updateVisibilitySettings:ct,toggleTagVisibility:tt,toggleRelationshipVisibility:it,toggleAllTags:dt,toggleAllRelationships:rt,showConfirmation:ke,showAllRelationships:Ie,setShowAllRelationships:De,showOnlySelectedRelationships:Ue,setShowOnlySelectedRelationships:Oe})}),e.jsx("main",{className:"flex-grow overflow-hidden",children:Vt()}),T&&e.jsx(ds,{fallback:e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-slate-800 rounded-lg p-6",children:[e.jsx("p",{className:"text-red-300 mb-4",children:"Error loading settings modal"}),e.jsx("button",{onClick:()=>F(!1),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Close"})]})}),children:e.jsx(kn,{patterns:Ge,tolerances:Se,appSettings:ve,colorSettings:Ee,onSaveOnly:Je,onSaveAndRescan:yt,onClose:()=>F(!1)})}),e.jsx(En,{isOpen:R.isOpen,message:R.message,onConfirm:me,onCancel:Le})]})};Gs.createRoot(document.getElementById("root")).render(e.jsx(ot.StrictMode,{children:e.jsx(ds,{children:e.jsx(Ln,{})})}));
